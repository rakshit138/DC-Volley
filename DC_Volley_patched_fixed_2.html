<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DC_Volley - Digital Scoresheet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);overflow:hidden;height:100vh}
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
.setup-screen{padding:40px;max-width:900px;margin:0 auto;overflow-y:auto;height:100vh;background:#0f3460}
.setup-card{background:#16213e;padding:30px;border-radius:10px;margin-bottom:20px;border:3px solid #533483}
.setup-title{color:#e94560;margin-bottom:20px;font-size:24px;text-align:center}
.form-group{margin-bottom:15px}
.form-label{display:block;color:#fff;font-weight:bold;margin-bottom:5px;font-size:13px}
.form-input,.form-select{width:100%;padding:10px;border:2px solid #533483;border-radius:5px;font-size:13px;background:#0f3460;color:#fff}
.roster-table{width:100%;color:#fff;font-size:12px;border-collapse:collapse}
.roster-table thead tr{background:#533483}
.roster-table th{padding:8px;text-align:center;font-weight:bold}
.roster-table td{padding:8px}
.roster-input{width:100%;padding:6px;border:2px solid #533483;border-radius:3px;font-size:12px;background:#1a1a2e;color:#fff;text-align:center}
.roster-input:focus{outline:none;border-color:#00d9ff;background:#16213e}
.roster-input.name-input{text-align:left}
.roster-select{width:100%;padding:6px 8px;border:2px solid #533483;border-radius:3px;font-size:12px;background:#1a1a2e;color:#fff;min-width:100px}
.roster-select:focus{outline:none;border-color:#00d9ff;background:#16213e}
.btn-confirm{background:#00d9ff;color:#000;width:100%;padding:15px;border:none;border-radius:5px;font-size:16px;cursor:pointer;font-weight:bold;margin-top:20px}
.btn-confirm:hover{opacity:0.9}
.btn-cancel{background:#666;color:#fff;padding:12px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold}
.hidden{display:none}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#16213e;padding:25px;border-radius:10px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;border:3px solid #533483}
.modal-title{color:#e94560;margin-bottom:20px;font-size:22px;text-align:center}
.lineup-setup{display:flex;gap:15px;margin:15px 0}
.team-setup{flex:1;background:#0f3460;padding:12px;border-radius:8px;border:2px solid #533483}
.team-setup h3{color:#e94560;margin-bottom:10px;text-align:center;font-size:16px}
.player-roster{background:#1a1a2e;padding:8px;border-radius:6px;margin-bottom:10px;max-height:200px;overflow-y:auto}
.roster-player{padding:6px 8px;margin-bottom:4px;background:#16213e;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;border:2px solid transparent;transition:0.2s}
.roster-player:hover{border-color:#00d9ff;background:#0f3460}
.roster-player.selected{background:#533483;border-color:#e94560}
.court-setup{background:#c67c3a;border:3px solid #fff;border-radius:8px;padding:10px;margin-top:8px}
.court-setup-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.court-setup-pos{background:#d9984f;border:2px solid #fff;border-radius:5px;padding:10px 6px;text-align:center;min-height:60px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;position:relative}
.court-setup-pos:hover{background:#e0a668}
.court-setup-pos.filled{background:#ffeb3b;border-color:#ffc107}
.pos-setup-label{font-size:10px;font-weight:bold;color:#fff;background:rgba(0,0,0,0.4);padding:2px 4px;border-radius:3px;margin-bottom:4px}
.pos-setup-num{font-size:26px;font-weight:bold;color:#000}
.pos-setup-name{display:none}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.top-bar{background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);padding:8px 14px;display:flex;justify-content:space-between;align-items:center;color:#fff;border-bottom:3px solid #00d9ff;box-shadow:0 3px 10px rgba(0,0,0,0.3)}
.top-bar h1{font-size:16px;color:#00ff88;font-weight:900;letter-spacing:0.5px;text-shadow:1px 1px 2px rgba(0,0,0,0.4);white-space:nowrap}
.match-info{font-size:11px;color:#00d9ff;display:flex;align-items:center;gap:12px;font-weight:500}
.match-info-item{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(0,217,255,0.15);border-radius:4px;border:1px solid rgba(0,217,255,0.3);line-height:1.5;text-align:center}
.match-info-icon{color:#00d9ff;font-size:13px}
.championship-info{font-size:11px;line-height:1.4;display:inline-block}
.timer-group{display:flex;flex-direction:column;gap:3px}
.btn-small{padding:5px 10px;border:none;border-radius:4px;font-size:10px;cursor:pointer;font-weight:bold;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;margin-left:6px;transition:all 0.3s;box-shadow:0 1px 4px rgba(0,0,0,0.2)}
.btn-small:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.btn-export{background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);color:#fff}
.btn-lineup{background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);color:#fff}
.btn-scoreboard{background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);color:#fff}
.main{display:flex;flex:1;overflow:hidden;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);min-height:0}
.side-panel{width:180px;background:linear-gradient(180deg, #1e3a5f 0%, #16213e 100%);border-right:3px solid #00d9ff;overflow-y:auto;padding:10px;box-shadow:4px 0 12px rgba(0,0,0,0.3)}
.side-title{color:#e94560;font-size:13px;font-weight:bold;margin-bottom:10px;padding:8px;background:#0f3460;border-radius:4px;text-align:center}
.lineup-list{background:#1a1a2e;border-radius:4px;padding:8px}
.lineup-item{padding:6px;margin-bottom:5px;background:#0f3460;border-radius:3px;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:space-between}
.lineup-pos{color:#e94560;font-weight:bold;min-width:30px;font-size:13px}
.lineup-badge{padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold;margin-left:4px}
.badge-c{background:#ffd700;color:#000}
.badge-l{background:#9c27b0;color:#fff}
.on-court{color:#00ff00;font-size:14px}
.center{flex:1;display:flex;flex-direction:column}
.score-section{background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);padding:10px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #00d9ff;box-shadow:0 3px 10px rgba(0,0,0,0.3)}
.team-score{text-align:center;flex:1}
.team-name{font-size:24px;font-weight:bold;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
.score-display{font-size:70px;font-weight:bold;line-height:1;font-family:Arial, sans-serif;text-shadow:3px 3px 6px rgba(0,0,0,0.4)}
.team-a{color:#ff6b9d}
.team-b{color:#4ecdc4}
.set-center{text-align:center;padding:8px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.set-title{font-size:17px;margin-bottom:10px;font-weight:600;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}
.set-dots{display:flex;gap:12px;justify-content:center}
.set-dot{width:36px;height:36px;border-radius:50%;border:3px solid #fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:bold;background:#1a1a2e;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.set-won-a{background:linear-gradient(135deg, #ff6b9d 0%, #ff5370 100%);border-color:#ff6b9d;box-shadow:0 0 12px rgba(255,107,157,0.6)}
.set-won-b{background:linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);border-color:#4ecdc4;box-shadow:0 0 12px rgba(78,205,196,0.6)}
.courts{display:flex;flex:1;background:#0f3460}
.court-container{flex:1;display:flex;flex-direction:column;padding:12px;border-right:1px solid #16213e}
.court-container:last-child{border-right:none}
.court-header{background:#16213e;padding:10px;border-radius:6px;margin-bottom:10px}
.court-name{color:#e94560;font-size:15px;font-weight:bold;text-align:center;margin-bottom:8px}
.stats-row{display:flex;justify-content:space-around;margin-top:8px}
.stat{text-align:center}
.stat-label{font-size:9px;color:#888;display:block}
.stat-val{font-size:14px;color:#fff;font-weight:bold;display:block}
.court-visual{background:linear-gradient(135deg, #d4a574 0%, #c67c3a 50%, #b8733d 100%);border:4px solid #fff;border-radius:10px;padding:14px;margin-bottom:12px;flex:1;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.court-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:360px}
.court-pos{background:linear-gradient(135deg, #e5b589 0%, #d9984f 100%);border:3px solid #fff;border-radius:6px;padding:14px 10px;text-align:center;min-height:80px;display:flex;flex-direction:column;justify-content:center;position:relative;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.court-pos:hover{background:linear-gradient(135deg, #f0c79a 0%, #e0a668 100%);transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.pos-label{font-size:10px;font-weight:bold;color:#fff;background:rgba(0,0,0,0.4);padding:2px 5px;border-radius:3px;margin-bottom:4px}
.pos-player{display:none}
.pos-jersey{font-size:24px;color:#000;font-weight:bold}
.libero-on-court{background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%) !important;border-color:#9c27b0 !important;box-shadow:0 0 24px rgba(156,39,176,0.8),0 4px 12px rgba(0,0,0,0.3)}
.libero-on-court .pos-jersey{color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.4)}
.libero-on-court .pos-label{background:rgba(255,255,255,0.4)}
.server{background:linear-gradient(135deg, #ffeb3b 0%, #ffd600 100%);box-shadow:0 0 24px rgba(255,235,59,0.8),0 4px 12px rgba(0,0,0,0.3);border-width:4px;border-color:#ffc107}
.server::before{content:'üèê';position:absolute;top:-16px;right:-16px;background:linear-gradient(135deg, #ffeb3b 0%, #00d9ff 100%);color:#000;padding:6px 10px;border-radius:50%;font-size:16px;border:3px solid #fff;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.copyright-footer{background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);padding:6px 20px;text-align:center;color:#00d9ff;font-size:11px;border-top:2px solid #00d9ff;font-weight:500;flex-shrink:0}
.copyright-footer a{color:#00d9ff;text-decoration:none}
.copyright-footer a:hover{text-decoration:underline}
.controls{padding:10px 12px 6px 12px;background:linear-gradient(135deg, #2c3e50 0%, #34495e 100%);border-top:3px solid #00d9ff}
.btn-group{display:flex;gap:10px;margin-bottom:10px}
.btn{padding:14px;border:none;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;transition:all 0.3s;flex:1;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.2)}
.btn:hover{opacity:0.9;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.btn-point{background:linear-gradient(135deg, #00d9ff 0%, #00b8d4 100%);color:#fff;font-size:19px;padding:18px;font-weight:900}
.btn-point.rally-inactive{opacity:0.35;cursor:not-allowed;filter:grayscale(60%)}
.btn-timeout{background:linear-gradient(135deg, #ff9500 0%, #ff6f00 100%);color:#fff;font-size:11px}
.btn-sub{background:linear-gradient(135deg, #007aff 0%, #0056b3 100%);color:#fff;font-size:11px}
.btn-rotate{background:linear-gradient(135deg, #af52de 0%, #8e24aa 100%);color:#fff;font-size:11px}
.btn-exceptional{background:linear-gradient(135deg, #ff3b3b 0%, #c71f1f 100%);color:#fff;font-size:11px;border:2px solid #ff6b6b;box-shadow:0 0 10px rgba(255,59,59,0.5)}
.btn-exceptional:hover{box-shadow:0 0 20px rgba(255,59,59,0.8)}
.timeout-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.timeout-modal.active{display:flex}
.timeout-content{background:#16213e;padding:40px;border-radius:15px;text-align:center;border:4px solid #ff9500;min-width:500px}
.timeout-timer{font-size:120px;font-weight:bold;color:#ff9500;font-family:monospace;line-height:1;margin:20px 0}
.timeout-team{font-size:28px;color:#fff;margin-bottom:20px}
.timeout-score{font-size:32px;color:#fff;margin-top:20px;background:#0f3460;padding:20px;border-radius:10px;border:3px solid #533483}
.timeout-score-label{font-size:16px;color:#888;margin-bottom:10px}
.timeout-score-display{display:flex;justify-content:center;align-items:center;gap:30px;margin-top:10px}
.timeout-team-score{display:flex;flex-direction:column;align-items:center;gap:8px}
.timeout-team-score-name{font-size:18px;font-weight:bold}
.timeout-team-score-points{font-size:48px;font-weight:bold;font-family:monospace}
.sub-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.sub-modal.active{display:flex}
.sub-content{background:#16213e;padding:30px;border-radius:10px;border:3px solid #007aff;max-width:800px;width:90%;max-height:90vh;overflow-y:auto}
.sub-title{color:#007aff;font-size:24px;margin-bottom:20px;text-align:center}
.sub-section{margin-bottom:25px}
.sub-section h4{color:#e94560;margin-bottom:10px;font-size:16px}
.player-select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.player-select-btn{padding:12px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;transition:0.2s;text-align:left}
.player-select-btn:hover{background:#16213e;border-color:#00d9ff}
.player-select-btn.selected{background:#007aff;border-color:#007aff}
.player-select-btn.disabled{opacity:0.4;cursor:not-allowed}
.sub-info{background:#0f3460;padding:15px;border-radius:5px;color:#ffd700;font-size:14px;margin-bottom:20px}
.libero-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.libero-modal.active{display:flex}
.libero-content{background:#16213e;padding:30px;border-radius:10px;border:3px solid #9c27b0;max-width:700px;width:90%;max-height:90vh;overflow-y:auto}
.libero-title{color:#9c27b0;font-size:24px;margin-bottom:20px;text-align:center}
.libero-section{margin-bottom:20px}
.libero-section h4{color:#e94560;margin-bottom:10px;font-size:16px}
.libero-info{background:#0f3460;padding:12px;border-radius:5px;color:#ffd700;font-size:13px;margin-bottom:15px}
.libero-select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.libero-player-btn{padding:12px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;transition:0.2s;text-align:left;font-size:13px}
.libero-player-btn:hover{background:#16213e;border-color:#9c27b0}
.libero-player-btn.selected{background:#9c27b0;border-color:#9c27b0}
.libero-player-btn.libero{border-color:#9c27b0;background:#1a1a2e}
.libero-badge-big{background:#9c27b0;color:#fff;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;margin-left:5px}
.btn-libero{background:#9c27b0;color:#fff;font-size:11px}
.history-item{background:#1a1a2e;padding:12px;margin-bottom:8px;border-radius:5px;border-left:4px solid}
.history-item.timeout-item{border-color:#ff9500}
.history-item.sub-item{border-color:#007aff}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.history-team{font-weight:bold;color:#fff;font-size:14px}
.history-set{color:#888;font-size:11px}
.history-score-box{background:#16213e;padding:8px;border-radius:4px;margin-top:8px}
.history-score-display{display:flex;justify-content:space-around;align-items:center}
.history-team-score{text-align:center}
.history-team-name{font-size:10px;color:#888}
.history-points{font-size:20px;font-weight:bold;color:#fff}
.history-sub-info{font-size:12px;color:#ccc;margin-top:6px}
.history-sub-arrow{color:#00d9ff;margin:0 5px}
.history-empty{text-align:center;color:#888;padding:20px;font-size:13px}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* AUTO LIBERO ENTRY/EXIT MODAL */
.auto-libero-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:3000;align-items:center;justify-content:center}
.auto-libero-modal.active{display:flex}
.auto-libero-content{background:#16213e;padding:35px;border-radius:15px;border:4px solid #9c27b0;max-width:600px;width:90%;text-align:center;animation:slideIn 0.3s ease-out}
@keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
.auto-libero-icon{font-size:80px;margin-bottom:15px;animation:pulse 1.5s infinite}
.auto-libero-title{color:#9c27b0;font-size:28px;margin-bottom:15px;font-weight:bold;text-shadow:0 2px 10px rgba(156,39,176,0.5)}
.auto-libero-message{color:#fff;font-size:18px;margin-bottom:10px;line-height:1.6}
.auto-libero-details{background:#0f3460;padding:20px;border-radius:8px;margin:20px 0;border:2px solid #533483}
.auto-libero-player-info{display:flex;justify-content:center;align-items:center;gap:30px;margin:15px 0}
.auto-libero-player{text-align:center}
.auto-libero-player-label{font-size:12px;color:#888;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.auto-libero-player-jersey{font-size:48px;font-weight:bold;color:#e94560;font-family:monospace;text-shadow:0 2px 10px rgba(233,69,96,0.5)}
.auto-libero-player-name{font-size:16px;color:#fff;margin-top:8px}
.auto-libero-arrow{font-size:36px;color:#00d9ff;animation:slideRight 1s infinite}
@keyframes slideRight{0%,100%{transform:translateX(0)}50%{transform:translateX(10px)}}
.auto-libero-position{background:#533483;padding:12px 20px;border-radius:6px;margin:15px 0;display:inline-block}
.auto-libero-position-label{font-size:12px;color:#ccc;margin-bottom:5px}
.auto-libero-position-value{font-size:24px;color:#ffd700;font-weight:bold}
.auto-libero-buttons{display:flex;gap:12px;margin-top:25px}
.auto-libero-btn{flex:1;padding:18px;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:0.2s;text-transform:uppercase;letter-spacing:1px}
.auto-libero-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.auto-libero-btn-replace{background:#9c27b0;color:#fff;border:3px solid #9c27b0}
.auto-libero-btn-replace:hover{background:#7b1fa2;box-shadow:0 4px 20px rgba(156,39,176,0.6)}
.auto-libero-btn-skip{background:#533483;color:#fff;border:3px solid #533483}
.auto-libero-btn-skip:hover{background:#3d2560}
</style>
</head>
<body>
<div class="app">
<div id="setupScreen" class="setup-screen">
<div class="setup-card">
<h2 class="setup-title">Match Information</h2>
<div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="matchDate"></div>
<div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="matchTime"></div>
<div class="form-group"><label class="form-label">City</label><input class="form-input" type="text" id="matchCity" placeholder="Enter city name"></div>
<div class="form-group"><label class="form-label">Country Code</label><input class="form-input" type="text" id="matchCountryCode" placeholder="e.g., IND, USA, BRA" maxlength="3"></div>
<div class="form-group"><label class="form-label">Division</label><select class="form-select" id="matchDivision"><option value="">Select Division</option><option value="Men">Men</option><option value="Women">Women</option></select></div>
<div class="form-group"><label class="form-label">Category</label><select class="form-select" id="matchCategory"><option value="">Select Category</option><option value="Youth">Youth</option><option value="Junior">Junior</option><option value="Senior">Senior</option></select></div>
<div class="form-group"><label class="form-label">Pool</label><input class="form-input" type="text" id="matchPool" placeholder="e.g., Pool A, Pool B"></div>
<div class="form-group"><label class="form-label">Competition</label><input class="form-input" id="comp" value="FIVB Championship 2026"></div>
<div class="form-group"><label class="form-label">Match Number</label><input class="form-input" id="matchNo" value="M-001"></div>
<div class="form-group"><label class="form-label">Venue</label><input class="form-input" id="venue" value="National Stadium"></div>
<div class="form-group"><label class="form-label">Format</label><select class="form-select" id="fmt"><option value="3">Best of 3</option><option value="5">Best of 5</option></select></div>
<div class="form-group"><label class="form-label">Substitution Limit / Set</label><select class="form-select" id="subLimitSel"><option value="6">6 (FIVB Standard)</option><option value="8">8 (Optional)</option></select></div>
</div>

<div class="setup-card">
<h2 class="setup-title">Match Officials</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label class="form-label">1st Referee</label><input class="form-input" id="ref1" placeholder="Name"></div>
<div class="form-group"><label class="form-label">2nd Referee</label><input class="form-input" id="ref2" placeholder="Name"></div>
<div class="form-group"><label class="form-label">Scorer</label><input class="form-input" id="scorer" placeholder="Name"></div>
<div class="form-group"><label class="form-label">Assistant Scorer</label><input class="form-input" id="assistScorer" placeholder="Name"></div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Team Setup</h2>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">üìù First, enter both teams. After coin toss, you'll assign which team goes on which side (A or B)</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div>
<div class="form-group"><label class="form-label">Team 1 Name</label><input class="form-input" id="team1Name" value="Warriors"></div>
<div class="form-group">
<label class="form-label">Team 1 Jersey Color</label>
<div style="display:flex;gap:10px;align-items:center">
<input type="color" id="team1Color" value="#ff6b6b" style="width:60px;height:40px;border:none;border-radius:5px;cursor:pointer">
<span style="color:#fff;font-size:12px">Jersey color</span>
</div>
</div>
</div>
<div>
<div class="form-group"><label class="form-label">Team 2 Name</label><input class="form-input" id="team2Name" value="Eagles"></div>
<div class="form-group">
<label class="form-label">Team 2 Jersey Color</label>
<div style="display:flex;gap:10px;align-items:center">
<input type="color" id="team2Color" value="#4ecdc4" style="width:60px;height:40px;border:none;border-radius:5px;cursor:pointer">
<span style="color:#fff;font-size:12px">Jersey color</span>
</div>
</div>
</div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Coin Toss</h2>
<div class="form-group">
<label class="form-label">Coin Toss Winner</label>
<select class="form-select" id="coinTossWinner">
<option value="">-- Select Winner --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Winner's Choice</label>
<select class="form-select" id="coinTossChoice">
<option value="">-- Select Choice --</option>
<option value="serve">Serve First</option>
<option value="receive">Receive First</option>
<option value="side">Choose Side</option>
</select>
</div>

<div id="teamAssignment" style="background:#0f3460;padding:20px;border-radius:8px;margin-top:20px;display:none">
<h3 style="color:#ffd700;margin-bottom:15px;font-size:16px">üìã Assign Team Positions</h3>
<p style="color:#fff;font-size:13px;margin-bottom:15px">Choose which team will be Team A (left side) or Team B (right side):</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div>
<label class="form-label" style="color:#ff6b6b">Team A (Left Side)</label>
<select class="form-select" id="teamAAssignment">
<option value="">-- Select Team --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
<div>
<label class="form-label" style="color:#4ecdc4">Team B (Right Side)</label>
<select class="form-select" id="teamBAssignment">
<option value="">-- Select Team --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
</div>
<p style="color:#ffa500;font-size:12px;margin-top:15px">‚ö†Ô∏è Make sure each team is assigned to a different side!</p>
</div>

<div id="coinTossResult" style="background:#0f3460;padding:15px;border-radius:5px;margin-top:15px;display:none">
<div style="color:#00d9ff;font-weight:bold;font-size:14px;margin-bottom:10px">‚úì Coin Toss Result:</div>
<div style="color:#fff;font-size:13px;line-height:1.8">
<div>üéØ <strong>First Server:</strong> <span id="firstServer"></span></div>
<div>üî• <strong>First Receiver:</strong> <span id="firstReceiver"></span></div>
<div>üìç <strong>Court Sides:</strong> <span id="courtSides"></span></div>
</div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Team Rosters</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div>
<h3 style="margin-bottom:15px;text-align:center" id="team1Header"><span style="color:#ff6b6b">TEAM 1</span> - <span id="team1Count">0</span>/14 Players</h3>
<div style="display:flex;gap:8px;margin-bottom:10px;justify-content:center">
<button class="btn-small" onclick="saveTeam1Roster()" style="background:linear-gradient(135deg, #00d9ff 0%, #00b8d4 100%);color:#fff;padding:8px 16px;font-size:10px">üíæ Save Team 1</button>
<button class="btn-small" onclick="document.getElementById('loadTeam1File').click()" style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);color:#fff;padding:8px 16px;font-size:10px">üìÇ Load Team 1</button>
<input type="file" id="loadTeam1File" accept=".json" style="display:none" onchange="loadTeam1Roster(event)">
</div>
<div style="background:#0f3460;padding:15px;border-radius:8px;overflow-y:auto;max-height:500px">
<table class="roster-table">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="width:10%">N</th>
<th style="width:15%">Jersey</th>
<th style="width:48%;text-align:left">Player Name</th>
<th style="width:27%">Role</th>
</tr>
</thead>
<tbody id="rosterInput1"></tbody>
</table>
</div>
</div>
<div>
<h3 style="margin-bottom:15px;text-align:center" id="team2Header"><span style="color:#4ecdc4">TEAM 2</span> - <span id="team2Count">0</span>/14 Players</h3>
<div style="display:flex;gap:8px;margin-bottom:10px;justify-content:center">
<button class="btn-small" onclick="saveTeam2Roster()" style="background:linear-gradient(135deg, #00d9ff 0%, #00b8d4 100%);color:#fff;padding:8px 16px;font-size:10px">üíæ Save Team 2</button>
<button class="btn-small" onclick="document.getElementById('loadTeam2File').click()" style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);color:#fff;padding:8px 16px;font-size:10px">üìÇ Load Team 2</button>
<input type="file" id="loadTeam2File" accept=".json" style="display:none" onchange="loadTeam2Roster(event)">
</div>
<div style="background:#0f3460;padding:15px;border-radius:8px;overflow-y:auto;max-height:500px">
<table class="roster-table">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="width:10%">N</th>
<th style="width:15%">Jersey</th>
<th style="width:48%;text-align:left">Player Name</th>
<th style="width:27%">Role</th>
</tr>
</thead>
<tbody id="rosterInput2"></tbody>
</table>
</div>
</div>
</div>
<div style="display:flex;gap:15px;align-items:center;margin-top:20px">
<button class="btn-small" onclick="saveRosterOnly()" style="background:linear-gradient(135deg, #00d9ff 0%, #00b8d4 100%);color:#fff;padding:12px 24px">üíæ Save Roster</button>
<button class="btn-small" onclick="document.getElementById('loadRosterFile').click()" style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);color:#fff;padding:12px 24px">üìÇ Load Roster</button>
<input type="file" id="loadRosterFile" accept=".json" style="display:none" onchange="loadRosterOnly(event)">
<button class="btn-small" onclick="openOfficialsModal()" style="background:#ff69b4;color:#000;padding:12px 24px">üë• Team Officials & Signatures</button>
<button class="btn-confirm" id="nextLineupBtn" style="flex:1">Next: Setup Lineups ‚Üí</button>
</div>
</div>
<div style="text-align:center;padding:15px;color:#666;font-size:11px;background:#0f3460;border-top:2px solid #16213e;margin-top:20px">
  DC_Volley ¬© 2025 | Digital Volleyball Scoresheet
</div>
</div>

<div id="lineupModal" class="modal">
<div class="modal-content">
<h3 class="modal-title" id="lineupModalTitle">Select Starting Lineups for Set 1</h3>
<div class="lineup-setup">
<div class="team-setup">
<h3 style="color:#ff6b6b">TEAM A - <span id="teamANameSetup"></span></h3>
<div class="player-roster" id="rosterASetup"></div>
<div class="court-setup">
<div class="court-setup-grid" id="courtASetup">
<div class="court-setup-pos" data-pos="4"><span class="pos-setup-label">P4-LF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="3"><span class="pos-setup-label">P3-MF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="2"><span class="pos-setup-label">P2-RF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="5"><span class="pos-setup-label">P5-LB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="6"><span class="pos-setup-label">P6-MB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="1"><span class="pos-setup-label">P1-RB</span><div class="pos-setup-num">-</div></div>
</div>
</div>
</div>
<div class="team-setup">
<h3 style="color:#4ecdc4">TEAM B - <span id="teamBNameSetup"></span></h3>
<div class="player-roster" id="rosterBSetup"></div>
<div class="court-setup">
<div class="court-setup-grid" id="courtBSetup">
<div class="court-setup-pos" data-pos="4"><span class="pos-setup-label">P4-LF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="3"><span class="pos-setup-label">P3-MF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="2"><span class="pos-setup-label">P2-RF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="5"><span class="pos-setup-label">P5-LB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="6"><span class="pos-setup-label">P6-MB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="1"><span class="pos-setup-label">P1-RB</span><div class="pos-setup-num">-</div></div>
</div>
</div>
</div>
</div>
<p style="color:#ffd700;text-align:center;font-size:12px;margin-top:15px">Click on a player, then click on a court position to assign</p>
<!-- PATCH: Libero Serving Config UI -->
<div id="liberoServeConfigBox" style="background:#0f3460;border:2px solid #9c27b0;border-radius:8px;padding:14px 18px;margin:14px 0;display:none">
  <div style="color:#9c27b0;font-weight:bold;font-size:13px;margin-bottom:10px">Libero Serving Rule (Optional)</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label style="color:#ccc;font-size:11px;display:block;margin-bottom:4px"><strong id="liberoServeTeamAName" style="color:#ff6b6b">TEAM A</strong> ‚Äî Libero may serve for:</label>
      <select id="liberoServePlayerA" onchange="LiberoServe.onConfigChange('A')" style="width:100%;padding:6px 8px;background:#16213e;border:1px solid #533483;color:#fff;border-radius:4px;font-size:12px">
        <option value="">-- OFF (default) --</option>
      </select>
    </div>
    <div>
      <label style="color:#ccc;font-size:11px;display:block;margin-bottom:4px"><strong id="liberoServeTeamBName" style="color:#4ecdc4">TEAM B</strong> ‚Äî Libero may serve for:</label>
      <select id="liberoServePlayerB" onchange="LiberoServe.onConfigChange('B')" style="width:100%;padding:6px 8px;background:#16213e;border:1px solid #533483;color:#fff;border-radius:4px;font-size:12px">
        <option value="">-- OFF (default) --</option>
      </select>
    </div>
  </div>
  <div style="color:#888;font-size:10px;margin-top:8px">When enabled: libero may replace that player in P1 while serving. All other rotations remain blocked.</div>
</div>
<!-- END PATCH: Libero Serving Config UI -->
<div class="modal-buttons">
<button class="btn-cancel" onclick="cancelLineup()" style="flex:1">Cancel</button>
<button class="btn-confirm" id="startMatchBtn" style="flex:1">Start Match</button>
</div>
</div>
</div>

<div id="matchScreen" class="hidden">
<div class="top-bar">
<h1>üèê DC_Volley</h1>
<div class="match-info">
<div class="match-info-item"><span class="match-info-icon">üèÜ</span><span id="topInfo" class="championship-info"></span></div>
<div class="timer-group">
<div class="match-info-item"><span class="match-info-icon">‚è±</span>Match: <span id="matchDuration">00:00:00</span></div>
<div class="match-info-item"><span class="match-info-icon">‚è≤</span>Set: <span id="setDuration">00:00</span></div>
</div>
<div id="intervalTimerDisplay" class="match-info-item" style="display:none;background:rgba(255,149,0,0.2);border-color:rgba(255,149,0,0.4);color:#ff0000;font-weight:bold"><span class="match-info-icon">‚è≥</span>Interval: <span id="intervalTimerText">3:00</span></div>
</div>
<div>
<button class="btn-small" onclick="openRosterModal()" style="background:#9c27b0;color:#fff">üìã ROSTER</button>
<button class="btn-small" onclick="saveMatch()" style="background:#4CAF50;color:#fff">üíæ SAVE</button>
<button class="btn-small" onclick="document.getElementById('loadMatchFile').click()" style="background:#2196F3;color:#fff">üìÇ LOAD</button>
<input type="file" id="loadMatchFile" accept=".json" style="display:none" onchange="loadMatch(event)">
<button class="btn-small" onclick="manuallyOpenNextSetLineup()" style="background:#9c27b0;color:#fff">üìù SETUP NEXT SET</button>
<button class="btn-small" onclick="openMatchDataModal()" style="background:#00ff00;color:#000">üíæ DATA</button>
<button class="btn-small" onclick="openSummaryModal()" style="background:#ffd700;color:#000">üìä SUMMARY</button>
<button class="btn-small" onclick="openHistoryModal()" style="background:#00d9ff;color:#000">üìã HISTORY</button>
<button class="btn-small btn-export" onclick="exportToPDF()">üìÑ Export PDF</button>
<button class="btn-small btn-lineup" onclick="openLineupDisplay()">üë• Lineup</button>
<button class="btn-small btn-scoreboard" onclick="openScoreboard()">üì∫ Scoreboard</button>
<button class="btn-small" onclick="openOfficialsModal()" style="background:#ff69b4;color:#000">üë• OFFICIALS</button>
<button class="btn-small" onclick="openSanctionModal()" style="background:#ff0000;color:#fff">‚ö†Ô∏è SANCTION</button>
<button class="btn-small" onclick="swapSides()">üîÑ SWAP</button>
<button class="btn-small" onclick="undoPoint()" style="background:#ff9500">‚Ü∂ UNDO</button>
<button class="btn-small" onclick="endMatch()">End Match</button>
<button class="btn-small" onclick="confirm('Exit?')&&location.reload()">Exit</button>
</div>
</div>

<div class="main">
<div class="side-panel">
<div class="side-title" id="sideATtl">TEAM A LINEUP</div>
<div class="lineup-list" id="lineupA"></div>
</div>

<div class="center">
<div class="score-section">
<div class="team-score">
<div class="team-name team-a" id="nameDispA">TEAM A</div>
<div class="score-display team-a" id="scoreDispA">0</div>
<div style="color:#888;font-size:11px">Sets: <span id="setsA">0</span></div>
</div>
<div class="set-center">
<div class="set-title">SET <span id="setDisp">1</span></div>
<div class="set-dots" id="setDotsDisp"></div>
<div style="font-size:11px;margin-top:5px" id="setTypeDisp"></div>
</div>
<div class="team-score">
<div class="team-name team-b" id="nameDispB">TEAM B</div>
<div class="score-display team-b" id="scoreDispB">0</div>
<div style="color:#888;font-size:11px">Sets: <span id="setsB">0</span></div>
</div>
</div>

<div class="courts">

<div class="court-container">
<div class="court-header">
<div class="court-name" id="courtNameA">TEAM A</div>
<div class="stats-row">
<div class="stat"><span class="stat-label">TIMEOUT</span><span class="stat-val" id="toDispA">0/2</span></div>
<div class="stat"><span class="stat-label">SUB</span><span class="stat-val" id="subDispA">0/6</span></div>
<div class="stat"><span class="stat-label">SERVE</span><span class="stat-val" id="servDispA">YES</span></div>
</div>
</div>
<div class="court-visual">
<div class="court-grid" id="courtGridA">
<div class="court-pos" data-pos="4"><span class="pos-label">P4-LF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="3"><span class="pos-label">P3-MF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="2"><span class="pos-label">P2-RF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="5"><span class="pos-label">P5-LB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="6"><span class="pos-label">P6-MB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="1"><span class="pos-label">P1-RB</span><div class="pos-player">-</div></div>
</div>
</div>
<div class="controls">
<div class="btn-group"><button id="pointBtnA" class="btn btn-point rally-inactive" onclick="addPoint('A')">+ POINT</button></div>
<div class="btn-group">
<button class="btn btn-timeout" onclick="takeTimeout('A')">‚è± TO</button>
<button class="btn btn-sub" onclick="openSubModal('A')">üë• SUB</button>
</div>
<div class="btn-group">
<button class="btn btn-libero" onclick="openLiberoModal('A')">üîÑ LIBERO</button>
<button class="btn btn-rotate" onclick="manualRotate('A')">üîÑ ROT</button>
</div>
</div>
</div>

<!-- Rally Button Between Courts -->
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 5px">
<button id="rallyButton" class="btn" onclick="toggleRally()" style="background:#ffd700;color:#000;font-size:12px;font-weight:bold;padding:8px 16px;border:2px solid #fff;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,0.2)">
üèê START RALLY
</button>
<div id="rallyStatus" style="color:#888;font-size:9px;font-weight:bold;margin-top:3px">STOPPED</div>
</div>

<div class="court-container">
<div class="court-header">
<div class="court-name" id="courtNameB">TEAM B</div>
<div class="stats-row">
<div class="stat"><span class="stat-label">TIMEOUT</span><span class="stat-val" id="toDispB">0/2</span></div>
<div class="stat"><span class="stat-label">SUB</span><span class="stat-val" id="subDispB">0/6</span></div>
<div class="stat"><span class="stat-label">SERVE</span><span class="stat-val" id="servDispB">NO</span></div>
</div>
</div>
<div class="court-visual">
<div class="court-grid" id="courtGridB">
<div class="court-pos" data-pos="4"><span class="pos-label">P4-LF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="3"><span class="pos-label">P3-MF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="2"><span class="pos-label">P2-RF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="5"><span class="pos-label">P5-LB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="6"><span class="pos-label">P6-MB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="1"><span class="pos-label">P1-RB</span><div class="pos-player">-</div></div>
</div>
</div>
<div class="controls">
<div class="btn-group"><button id="pointBtnB" class="btn btn-point rally-inactive" onclick="addPoint('B')">+ POINT</button></div>
<div class="btn-group">
<button class="btn btn-timeout" onclick="takeTimeout('B')">‚è± TO</button>
<button class="btn btn-sub" onclick="openSubModal('B')">üë• SUB</button>
</div>
<div class="btn-group">
<button class="btn btn-libero" onclick="openLiberoModal('B')">üîÑ LIBERO</button>
<button class="btn btn-rotate" onclick="manualRotate('B')">üîÑ ROT</button>
</div>
</div>
</div>
</div>
</div>

<div class="side-panel">
<div class="side-title" id="sideBTtl">TEAM B LINEUP</div>
<div class="lineup-list" id="lineupB"></div>
</div>
</div>

<div class="copyright-footer">
  <div>DC_Volley ¬© 2025 | Digital Volleyball Scoresheet</div>
</div>
</div>

<div id="timeoutModal" class="timeout-modal">
<div class="timeout-content">
<div class="timeout-team" id="timeoutTeamName">TIMEOUT</div>
<div class="timeout-timer" id="timeoutTimer">30</div>
<div class="timeout-score">
<div class="timeout-score-label">SCORE AT TIMEOUT</div>
<div class="timeout-score-display" id="timeoutScoreDisplay">
<div class="timeout-team-score">
<div class="timeout-team-score-name" id="timeoutTeamAName">Team A</div>
<div class="timeout-team-score-points team-a" id="timeoutTeamAScore">0</div>
</div>
<div style="font-size:40px;color:#888">-</div>
<div class="timeout-team-score">
<div class="timeout-team-score-name" id="timeoutTeamBName">Team B</div>
<div class="timeout-team-score-points team-b" id="timeoutTeamBScore">0</div>
</div>
</div>
</div>
<button class="btn-confirm" onclick="endTimeout()" style="margin-top:30px">End Timeout</button>
</div>
</div>

<div id="subModal" class="sub-modal">
<div class="sub-content">
<h3 class="sub-title">Substitution - <span id="subTeamName"></span></h3>
<div class="sub-info" id="subInfo">Select a player OUT, then select a player IN</div>
<div class="sub-section">
<h4>Players ON Court (Select player to come OUT)</h4>
<div class="player-select-grid" id="playersOut"></div>
</div>
<div class="sub-section">
<h4>Players on Bench (Select player to come IN)</h4>
<div class="player-select-grid" id="playersIn"></div>
</div>
<div class="modal-buttons">
<button class="btn-cancel" onclick="closeSubModal()">Cancel</button>
<button class="btn-exceptional" onclick="openExceptionalSubModal()">üöë Exceptional Substitution</button>
<button class="btn-confirm" id="confirmSubBtn" onclick="confirmSubstitution()">üîÅ Regular Substitution</button>
</div>
</div>
</div>

<!-- EXCEPTIONAL SUBSTITUTION MODAL -->
<div id="exceptionalSubModal" class="sub-modal">
<div class="sub-content">
<h3 class="sub-title" style="color:#ff3b3b">üöë Exceptional Substitution - <span id="exceptionalSubTeamName"></span></h3>
<div class="sub-info" style="background:#ff3b3b;color:#fff;padding:12px;border-radius:5px;margin-bottom:15px">
‚ö†Ô∏è This substitution is for injured players only. It will NOT count toward the 6-substitution limit, and the injured player will be locked for the entire match.
</div>
<div class="sub-section">
<h4>Players ON Court (Select INJURED player to come OUT)</h4>
<div class="player-select-grid" id="exceptionalPlayersOut"></div>
</div>
<div class="sub-section">
<h4>Players on Bench (Select ANY player to come IN)</h4>
<div class="player-select-grid" id="exceptionalPlayersIn"></div>
</div>
<div class="modal-buttons">
<button class="btn-cancel" onclick="closeExceptionalSubModal()">Cancel</button>
<button class="btn-confirm" style="background:#ff3b3b" id="confirmExceptionalSubBtn" onclick="confirmExceptionalSubstitution()">Confirm Exceptional Substitution</button>
</div>
</div>
</div>

<div id="liberoModal" class="libero-modal">
<div class="libero-content">
<h3 class="libero-title">Libero Replacement - <span id="liberoTeamName"></span></h3>
<div class="libero-info" id="liberoInfo">Select a back-row player to replace with Libero</div>
<div class="libero-section">
<h4>Available Liberos</h4>
<div class="libero-select-grid" id="liberosList"></div>
</div>
<div class="libero-section">
<h4>Back Row Players (Can be replaced by Libero)</h4>
<div class="libero-select-grid" id="backRowPlayers"></div>
</div>
<div class="modal-buttons">
<button class="btn-cancel" onclick="closeLiberoModal()">Cancel</button>
<button class="btn-confirm" id="confirmLiberoBtn" onclick="confirmLiberoReplacement()">Confirm Replacement</button>
</div>
</div>
</div>

<!-- AUTO LIBERO ENTRY MODAL -->
<div id="autoLiberoEntryModal" class="auto-libero-modal">
<div class="auto-libero-content">
<div class="auto-libero-icon">üü°</div>
<h3 class="auto-libero-title">LIBERO ENTRY AVAILABLE</h3>
<p class="auto-libero-message" id="autoEntryMessage">Player rotated to back-row position</p>

<div class="auto-libero-details">
<div class="auto-libero-player-info">
<div class="auto-libero-player">
<div class="auto-libero-player-label">‚¨áÔ∏è OUT</div>
<div class="auto-libero-player-jersey" id="autoEntryOutJersey">-</div>
<div class="auto-libero-player-name" id="autoEntryOutName">-</div>
</div>
<div class="auto-libero-arrow">‚ûú</div>
<div class="auto-libero-player">
<div class="auto-libero-player-label">‚¨ÜÔ∏è IN (Libero)</div>
<div class="auto-libero-player-jersey" id="autoEntryInJersey">-</div>
<div class="auto-libero-player-name" id="autoEntryInName">-</div>
</div>
</div>

<div class="auto-libero-position">
<div class="auto-libero-position-label">Zone / Position</div>
<div class="auto-libero-position-value" id="autoEntryPosition">P-</div>
</div>
</div>

<div class="auto-libero-buttons">
<button class="auto-libero-btn auto-libero-btn-replace" onclick="confirmAutoLiberoEntry()">
‚úì REPLACE WITH LIBERO
</button>
<button class="auto-libero-btn auto-libero-btn-skip" onclick="skipAutoLiberoEntry()">
‚úó SKIP
</button>
</div>
</div>
</div>

<!-- AUTO LIBERO EXIT MODAL -->
<div id="autoLiberoExitModal" class="auto-libero-modal">
<div class="auto-libero-content">
<div class="auto-libero-icon">üîÑ</div>
<h3 class="auto-libero-title">LIBERO EXIT THE COURT</h3>
<p class="auto-libero-message" id="autoExitMessage">Libero rotating to front row</p>

<div class="auto-libero-details">
<div class="auto-libero-player-info">
<div class="auto-libero-player">
<div class="auto-libero-player-label">‚¨ÜÔ∏è IN</div>
<div class="auto-libero-player-jersey" id="autoExitInJersey">-</div>
<div class="auto-libero-player-name" id="autoExitInName">-</div>
</div>
<div class="auto-libero-arrow">‚ûú</div>
<div class="auto-libero-player">
<div class="auto-libero-player-label">‚¨áÔ∏è OUT (Libero)</div>
<div class="auto-libero-player-jersey" id="autoExitOutJersey">-</div>
<div class="auto-libero-player-name" id="autoExitOutName">-</div>
</div>
</div>

<div class="auto-libero-position">
<div class="auto-libero-position-label">Zone / Position</div>
<div class="auto-libero-position-value" id="autoExitPosition">P-</div>
</div>
</div>

<div class="auto-libero-buttons">
<button class="auto-libero-btn auto-libero-btn-replace" onclick="confirmAutoLiberoExit()">
‚úì CONFIRM EXIT
</button>
</div>
</div>
</div>

<!-- ROSTER MODAL -->
<div id="rosterModal" class="modal">
<div class="modal-content" style="max-width:1200px">
<h3 class="modal-title">üìã TEAM ROSTERS</h3>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
<!-- Team A Roster -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #ff6b6b">
<h4 style="color:#ff6b6b;margin-bottom:15px;font-size:18px;text-align:center" id="rosterTeamAName">TEAM A</h4>
<div id="rosterTeamAContent"></div>
</div>

<!-- Team B Roster -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #4ecdc4">
<h4 style="color:#4ecdc4;margin-bottom:15px;font-size:18px;text-align:center" id="rosterTeamBName">TEAM B</h4>
<div id="rosterTeamBContent"></div>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" onclick="closeRosterModal()">Close</button>
</div>
</div>
</div>

<div id="historyModal" class="modal">
<div class="modal-content" style="max-width:1200px;max-height:90vh">
<h3 class="modal-title">üìã MATCH HISTORY</h3>

<div id="historyContent" style="max-height:70vh;overflow-y:auto;padding:10px"></div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="exportHistoryPDF()">üì• Export PDF</button>
<button class="btn-confirm" onclick="closeHistoryModal()">Close</button>
</div>
</div>
</div>

<div id="summaryModal" class="modal">
<div class="modal-content" style="max-width:1400px;max-height:90vh;overflow-y:auto">
<h3 class="modal-title">üìä MATCH SUMMARY</h3>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">Complete match statistics and event log</p>

<!-- Statistics Overview -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px">
<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ffd700">
<h4 style="color:#ffd700;font-size:14px;margin-bottom:8px">‚è± TIMEOUTS USED</h4>
<div id="summaryTimeouts" style="color:#fff;font-size:13px">
<div><span id="teamATimeouts">0</span> / 2</div>
<div><span id="teamBTimeouts">0</span> / 2</div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #00d9ff">
<h4 style="color:#00d9ff;font-size:14px;margin-bottom:8px">üë• SUBSTITUTIONS</h4>
<div id="summarySubstitutions" style="color:#fff;font-size:13px">
<div><span id="teamASubstitutions">0</span></div>
<div><span id="teamBSubstitutions">0</span></div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #9c27b0">
<h4 style="color:#9c27b0;font-size:14px;margin-bottom:8px">üîÑ LIBERO REPLACEMENTS</h4>
<div id="summaryLibero" style="color:#fff;font-size:13px">
<div>Team A: <span id="teamALibero">0</span></div>
<div>Team B: <span id="teamBLibero">0</span></div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ff6b6b">
<h4 style="color:#ff6b6b;font-size:14px;margin-bottom:8px">‚ö†Ô∏è SANCTIONS</h4>
<div id="summarySanctions" style="color:#fff;font-size:13px">
<div><span id="teamASanctions">0</span></div>
<div><span id="teamBSanctions">0</span></div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #4ecdc4">
<h4 style="color:#4ecdc4;font-size:14px;margin-bottom:8px">‚è∞ MATCH DURATION</h4>
<div id="summaryDuration" style="color:#fff;font-size:13px">
<div id="totalDuration">--:--:--</div>
</div>
</div>
</div>

<!-- Set-by-Set Breakdown -->
<div id="setBreakdownContainer" style="margin-bottom:20px"></div>

<!-- Event Log -->
<div style="background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">üìã Event Log</h4>
<div style="max-height:400px;overflow-y:auto">
<table style="width:100%;border-collapse:collapse;color:#fff;font-size:13px">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Set</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Time</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Team</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Event</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Details</th>
</tr>
</thead>
<tbody id="summaryTableBody">
<tr>
<td colspan="5" style="padding:20px;text-align:center;color:#888">No events yet. Start the match to see live updates.</td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="exportSummaryPDF()">üì• Export PDF</button>
<button class="btn-confirm" onclick="closeSummaryModal()">Close</button>
</div>
</div>
</div>

<div id="officialsModal" class="modal">
<div class="modal-content" style="max-width:800px;max-height:85vh;overflow-y:auto">
<h3 class="modal-title">üë• TEAM OFFICIALS & SIGNATURES</h3>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">Team staff information and captain/coach signatures</p>

<!-- Team A Officials -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #ff6b6b;margin-bottom:15px">
<h4 style="color:#ff6b6b;margin-bottom:15px;font-size:18px;text-align:center">
  <span style="font-size:14px;opacity:0.8">TEAM A:</span> <span id="officialsTeamATitle" style="font-weight:bold">TEAM A</span>
</h4>

<div style="margin-bottom:15px;background:#16213e;padding:12px;border-radius:5px;border:2px solid #ff6b6b">
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px;font-weight:bold">‚úèÔ∏è Team Name</label>
<input type="text" id="teamANameInput" class="form-input" placeholder="Enter Team A name" style="background:#0f3460;border:1px solid #ff6b6b;color:#fff;padding:10px;width:100%;border-radius:5px;font-size:14px;font-weight:bold">
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px">
<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Coach Name</label>
<input type="text" id="coachA" class="form-input" placeholder="Coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Assistant Coach</label>
<input type="text" id="asstCoachA" class="form-input" placeholder="Assistant coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Medical Officer</label>
<input type="text" id="medicalA" class="form-input" placeholder="Medical officer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Trainer</label>
<input type="text" id="trainerA" class="form-input" placeholder="Trainer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>
</div>

<div style="border-top:2px solid #533483;padding-top:15px">
<h5 style="color:#ffd700;margin-bottom:10px;font-size:14px">‚úçÔ∏è Signatures</h5>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (Before)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignA1" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignA1')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (After)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignA2" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignA2')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Coach Signature</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="coachSignA" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('coachSignA')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>
</div>
</div>
</div>

<!-- Team B Officials -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #4ecdc4;margin-bottom:15px">
<h4 style="color:#4ecdc4;margin-bottom:15px;font-size:18px;text-align:center">
  <span style="font-size:14px;opacity:0.8">TEAM B:</span> <span id="officialsTeamBTitle" style="font-weight:bold">TEAM B</span>
</h4>

<div style="margin-bottom:15px;background:#16213e;padding:12px;border-radius:5px;border:2px solid #4ecdc4">
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px;font-weight:bold">‚úèÔ∏è Team Name</label>
<input type="text" id="teamBNameInput" class="form-input" placeholder="Enter Team B name" style="background:#0f3460;border:1px solid #4ecdc4;color:#fff;padding:10px;width:100%;border-radius:5px;font-size:14px;font-weight:bold">
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px">
<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Coach Name</label>
<input type="text" id="coachB" class="form-input" placeholder="Coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Assistant Coach</label>
<input type="text" id="asstCoachB" class="form-input" placeholder="Assistant coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Medical Officer</label>
<input type="text" id="medicalB" class="form-input" placeholder="Medical officer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Trainer</label>
<input type="text" id="trainerB" class="form-input" placeholder="Trainer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>
</div>

<div style="border-top:2px solid #533483;padding-top:15px">
<h5 style="color:#ffd700;margin-bottom:10px;font-size:14px">‚úçÔ∏è Signatures</h5>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (Before)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignB1" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignB1')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (After)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignB2" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignB2')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Coach Signature</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="coachSignB" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('coachSignB')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>
</div>
</div>
</div>

<!-- Match Officials Signatures - Each on separate row -->
<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ffc107;margin-bottom:15px">
<h4 style="color:#ffc107;margin-bottom:12px;font-size:16px;text-align:center">‚öñÔ∏è MATCH OFFICIALS SIGNATURES</h4>

<!-- 1st Referee Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">1st Referee</div>
<div style="color:#fff;font-size:13px" id="ref1Display">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="firstRefSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('firstRefSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- 2nd Referee Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">2nd Referee</div>
<div style="color:#fff;font-size:13px" id="ref2Display">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="secondRefSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('secondRefSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- Scorer Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">Scorer</div>
<div style="color:#fff;font-size:13px" id="scorerDisplay">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="scorerSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('scorerSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- Assistant Scorer Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">Asst. Scorer</div>
<div style="color:#fff;font-size:13px" id="assistScorerDisplay">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="assistScorerSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('assistScorerSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" onclick="saveOfficials()">üíæ Save</button>
<button class="btn-cancel" onclick="closeOfficialsModal()">Close</button>
</div>
</div>
</div>

<!-- ============================================================ -->
<!-- FIVB SANCTION MANAGEMENT SYSTEM - MAIN MODAL -->
<!-- ============================================================ -->
<div id="sanctionModal" class="modal">
<div class="modal-content" style="max-width:720px">
<h3 class="modal-title" style="font-size:20px">‚ö†Ô∏è FIVB SANCTION MANAGEMENT</h3>

<!-- Module Selector Tabs -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px">
  <button id="smTabMisconduct" onclick="smSelectModule('misconduct')"
    style="padding:14px;border:3px solid #ffd700;border-radius:8px;background:#2d1f00;color:#ffd700;font-size:14px;font-weight:bold;cursor:pointer">
    üü® MISCONDUCT<br><span style="font-size:10px;color:#ccc">Behaviour-based (Player/Coach)</span>
  </button>
  <button id="smTabDelay" onclick="smSelectModule('delay')"
    style="padding:14px;border:3px solid #533483;border-radius:8px;background:#16213e;color:#aaa;font-size:14px;font-weight:bold;cursor:pointer">
    ‚è± DELAY<br><span style="font-size:10px;color:#888">Time-wasting (Team-based)</span>
  </button>
</div>

<!-- TEAM SELECTOR -->
<div style="margin-bottom:14px">
  <label style="color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:1px">Select Team</label>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
    <button onclick="smSelectTeam('A')" id="smTeamA"
      style="padding:12px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold">
      <span id="smTeamAName">Team A</span>
    </button>
    <button onclick="smSelectTeam('B')" id="smTeamB"
      style="padding:12px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold">
      <span id="smTeamBName">Team B</span>
    </button>
  </div>
</div>

<!-- MISCONDUCT PANEL -->
<div id="smMisconductPanel">
  <!-- Player/Coach selector -->
  <div style="margin-bottom:14px">
    <label style="color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:1px">Sanctioned Person</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
      <button id="smPersonPlayer" onclick="smSelectPerson('player')"
        style="padding:10px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:5px;cursor:pointer;font-size:13px">
        üë§ Player
      </button>
      <button id="smPersonCoach" onclick="smSelectPerson('coach')"
        style="padding:10px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:5px;cursor:pointer;font-size:13px">
        üß¢ Coach / Staff
      </button>
    </div>
    <div id="smPlayerJerseyRow" style="margin-top:8px;display:none">
      <input type="text" id="smPlayerJersey" placeholder="Jersey number (e.g. 7)" maxlength="3"
        oninput="smRefreshEscalation()"
        style="width:100%;padding:10px;border:2px solid #533483;border-radius:5px;background:#1a1a2e;color:#fff;font-size:14px">
    </div>
  </div>

  <!-- Misconduct escalation status -->
  <div id="smEscalationStatus" style="background:#0f3460;padding:12px;border-radius:6px;margin-bottom:14px;font-size:12px;color:#ccc;display:none">
    <strong style="color:#ffd700">üìã Sanction History for this person:</strong>
    <div id="smEscalationDetail" style="margin-top:6px"></div>
  </div>

  <!-- Sanction type buttons -->
  <div style="margin-bottom:14px">
    <label style="color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:1px">Sanction Type</label>
    <div id="smTypeHint" style="color:#ff8800;font-size:11px;margin-top:4px">‚ö†Ô∏è Please select a sanction type below</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <button id="smTypeW" onclick="smSelectMisconductType('W')"
        style="padding:12px;background:#16213e;border:2px solid #ffd700;color:#ffd700;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        üü® WARNING<br><span style="font-size:10px;color:#aaa">Yellow Card ‚Ä¢ No point</span>
      </button>
      <button id="smTypeP" onclick="smSelectMisconductType('P')"
        style="padding:12px;background:#16213e;border:2px solid #ff4444;color:#ff4444;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        üü• PENALTY<br><span style="font-size:10px;color:#aaa">Red Card ‚Ä¢ +1 pt opponent</span>
      </button>
      <button id="smTypeEXP" onclick="smSelectMisconductType('EXP')"
        style="padding:12px;background:#16213e;border:2px solid #ff8800;color:#ff8800;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        üü®üü• EXPULSION<br><span style="font-size:10px;color:#aaa">Out this set only</span>
      </button>
      <button id="smTypeDISQ" onclick="smSelectMisconductType('DISQ')"
        style="padding:12px;background:#16213e;border:2px solid #cc00cc;color:#cc00cc;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        üü•‚ùå DISQUALIFICATION<br><span style="font-size:10px;color:#aaa">Out entire match</span>
      </button>
    </div>
  </div>

  <!-- Notes -->
  <div style="margin-bottom:14px">
    <label style="color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:1px">Reason / Notes</label>
    <select id="smMisconductReason" style="width:100%;padding:10px;border:2px solid #533483;border-radius:5px;background:#1a1a2e;color:#fff;font-size:13px;margin-top:6px">
      <option value="">-- Select reason (optional) --</option>
      <option value="Rude gesture">Rude gesture</option>
      <option value="Verbal abuse">Verbal abuse</option>
      <option value="Arguing with official">Arguing with official</option>
      <option value="Repeated misconduct">Repeated misconduct</option>
      <option value="Serious misconduct">Serious misconduct (direct red)</option>
      <option value="Offensive conduct">Offensive conduct</option>
      <option value="Physical aggression">Physical aggression</option>
      <option value="Other">Other</option>
    </select>
    <textarea id="smMisconductNotes" placeholder="Additional details..." style="width:100%;margin-top:6px;padding:10px;border:2px solid #533483;border-radius:5px;background:#1a1a2e;color:#fff;font-size:12px;min-height:50px;resize:none"></textarea>
  </div>

  <!-- Preview / consequence info box -->
  <div id="smConsequenceBox" style="display:none;background:#1a2f1a;border:2px solid #00cc44;border-radius:6px;padding:12px;margin-bottom:14px;font-size:13px;color:#fff">
    <strong style="color:#00cc44">üìå CONSEQUENCE:</strong>
    <div id="smConsequenceText" style="margin-top:5px"></div>
  </div>

  <div style="display:flex;gap:10px">
    <button onclick="smConfirmMisconduct()" style="flex:1;padding:14px;background:#c00;color:#fff;border:none;border-radius:6px;font-size:15px;font-weight:bold;cursor:pointer">
      ‚ö†Ô∏è APPLY SANCTION
    </button>
    <button onclick="closeSanctionModal()" style="padding:14px 20px;background:#444;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer">Cancel</button>
  </div>
</div>

<!-- DELAY PANEL (hidden by default) -->
<div id="smDelayPanel" style="display:none">
  <!-- Delay status -->
  <div id="smDelayStatus" style="background:#0f3460;padding:14px;border-radius:8px;margin-bottom:14px">
    <div style="font-size:13px;color:#00d9ff;margin-bottom:10px;font-weight:bold">üìä DELAY SANCTION TRACKER (Entire Match)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="smDelayStatusGrid">
      <!-- filled dynamically -->
    </div>
  </div>

  <!-- Delay type ‚Äì auto suggested -->
  <div id="smDelayAutoBox" style="background:#1a2030;border:2px solid #00d9ff;border-radius:6px;padding:14px;margin-bottom:14px;font-size:13px;color:#fff">
    <strong style="color:#00d9ff">AUTO-SUGGESTION:</strong>
    <div id="smDelayAutoText" style="margin-top:6px"></div>
  </div>

  <!-- Override -->
  <div style="margin-bottom:14px">
    <label style="color:#aaa;font-size:12px;text-transform:uppercase;letter-spacing:1px">Apply</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <button id="smDelayTypeW" onclick="smSelectDelayType('DW')"
        style="padding:12px;background:#16213e;border:2px solid #ffd700;color:#ffd700;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        ‚è± DELAY WARNING<br><span style="font-size:10px;color:#aaa">1st delay ‚Ä¢ No point</span>
      </button>
      <button id="smDelayTypeP" onclick="smSelectDelayType('DP')"
        style="padding:12px;background:#16213e;border:2px solid #ff4444;color:#ff4444;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px">
        ‚è±üü• DELAY PENALTY<br><span style="font-size:10px;color:#aaa">2nd+ delay ‚Ä¢ +1 pt opponent</span>
      </button>
    </div>
  </div>

  <div id="smDelayConsequenceBox" style="display:none;background:#1a2f1a;border:2px solid #00cc44;border-radius:6px;padding:12px;margin-bottom:14px;font-size:13px;color:#fff">
    <strong style="color:#00cc44">üìå CONSEQUENCE:</strong>
    <div id="smDelayConsequenceText" style="margin-top:5px"></div>
  </div>

  <div style="display:flex;gap:10px">
    <button onclick="smConfirmDelay()" style="flex:1;padding:14px;background:#0056b3;color:#fff;border:none;border-radius:6px;font-size:15px;font-weight:bold;cursor:pointer">
      ‚è± APPLY DELAY SANCTION
    </button>
    <button onclick="closeSanctionModal()" style="padding:14px 20px;background:#444;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer">Cancel</button>
  </div>
</div>

<!-- Live sanction log -->
<div style="margin-top:16px;background:#0f3460;border-radius:6px;padding:10px">
  <div style="font-size:11px;color:#888;font-weight:bold;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Match Sanction Log</div>
  <div id="smLiveSanctionLog" style="font-size:11px;max-height:90px;overflow-y:auto;color:#ccc">‚Äî</div>
</div>

</div>
</div>

<!-- ============================================================ -->
<!-- RED CARD CONFIRMATION MODAL -->
<!-- ============================================================ -->
<div id="smRedConfirmModal" class="modal" style="z-index:1100">
<div class="modal-content" style="max-width:480px;text-align:center;border:4px solid #ff4444">
  <div style="font-size:60px;margin-bottom:10px">üü•</div>
  <h3 style="color:#ff4444;margin-bottom:10px;font-size:20px" id="smRedConfirmTitle">CONFIRM RED CARD</h3>
  <p style="color:#fff;margin-bottom:18px;font-size:14px;line-height:1.6" id="smRedConfirmText"></p>
  <div style="background:#1a1a2e;border-radius:6px;padding:12px;margin-bottom:18px;font-size:13px;color:#ffd700" id="smRedConfirmEffect"></div>
  <div style="display:flex;gap:12px">
    <button onclick="smRedConfirmYes()" style="flex:1;padding:14px;background:#c00;color:#fff;border:none;border-radius:6px;font-size:15px;font-weight:bold;cursor:pointer">
      ‚úì CONFIRM ‚Äî APPLY
    </button>
    <button onclick="smRedConfirmNo()" style="flex:1;padding:14px;background:#555;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer">
      ‚úó CANCEL
    </button>
  </div>
</div>
</div>

<!-- ============================================================ -->
<!-- EXPELLED / DISQUALIFIED PLAYER SUBSTITUTE REQUIRED MODAL -->
<!-- ============================================================ -->
<div id="smSubRequiredModal" class="modal" style="z-index:1200">
<div class="modal-content" style="max-width:540px;border:4px solid #ff8800">
  <h3 style="color:#ff8800;margin-bottom:12px;font-size:18px" id="smSubReqTitle">üîÑ SUBSTITUTE REQUIRED</h3>
  <p style="color:#fff;margin-bottom:14px;font-size:13px;line-height:1.6" id="smSubReqText"></p>
  <div style="margin-bottom:14px">
    <label style="color:#aaa;font-size:12px">Select replacement player from bench:</label>
    <div id="smSubReqPlayerList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto"></div>
  </div>
  <div id="smSubReqNoneMsg" style="display:none;background:#c00;color:#fff;padding:12px;border-radius:6px;font-size:13px;margin-bottom:12px">
    ‚õî No eligible substitute available. Per FIVB rules the team must continue with 5 players (or match is forfeited ‚Äî referee decision required).
  </div>
  <div style="display:flex;gap:10px">
    <button id="smSubReqConfirmBtn" onclick="smSubReqConfirm()" style="flex:1;padding:12px;background:#ff8800;color:#000;border:none;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer">
      ‚úì Confirm Replacement
    </button>
    <button onclick="smSubReqDismiss()" style="padding:12px 16px;background:#555;color:#fff;border:none;border-radius:6px;cursor:pointer">Done / Skip</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CAPTAIN REDESIGNATION MODAL (FIVB Art.5.1.2)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="smCaptainReqModal" class="modal" style="z-index:1300">
<div class="modal-content" style="max-width:520px;border:4px solid #ffd700">
  <h3 style="color:#ffd700;margin-bottom:8px;font-size:18px">üëë NEW CAPTAIN REQUIRED</h3>
  <p style="color:#aaa;font-size:11px;margin-bottom:10px">FIVB Art.5.1.2 ‚Äî Captain disqualified. Team must designate a replacement immediately.</p>
  <div style="background:#1a1a2e;padding:10px;border-radius:6px;margin-bottom:12px;font-size:13px">
    <span style="color:#aaa">Team: </span><strong id="smCaptainReqTeam" style="color:#ffd700"></strong><br>
    <span style="color:#aaa">Disqualified captain: </span><strong id="smCaptainReqOld" style="color:#ff4444"></strong>
  </div>
  <p style="color:#fff;font-size:13px;margin-bottom:8px">Select new captain:</p>
  <div id="smCaptainReqList" style="max-height:220px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;margin-bottom:12px"></div>
  <p style="color:#888;font-size:11px;margin-bottom:10px">
    ‚ÑπÔ∏è Authority transfers immediately. New captain has full protest rights and will sign scoresheet.
  </p>
  <button onclick="smCloseCaptainReq()"
    style="width:100%;padding:10px;background:#555;color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer">
    Cancel (Referee will resolve)
  </button>
</div>
</div>

<div id="decidingSetTossModal" class="modal">
<div class="modal-content" style="max-width:600px">
<h3 class="modal-title">üéØ DECIDING SET COIN TOSS</h3>
<p style="color:#00d9ff;font-size:14px;margin-bottom:20px;text-align:center">
  Conduct coin toss to determine first service and court side
</p>

<div style="background:#0f3460;padding:25px;border-radius:8px;margin-bottom:20px">
<h4 style="color:#ffd700;margin-bottom:20px;font-size:18px;text-align:center">STEP 1: WHO WON THE TOSS?</h4>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<button id="decidingTossA" onclick="decidingSetTossWinner('A')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#ff6b6b;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold">
<span id="decidingTossAName">TEAM A</span>
</button>
<button id="decidingTossB" onclick="decidingSetTossWinner('B')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#4ecdc4;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold">
<span id="decidingTossBName">TEAM B</span>
</button>
</div>
</div>

<div id="decidingTossChoice" style="display:none;background:#0f3460;padding:25px;border-radius:8px;margin-bottom:20px">
<h4 style="color:#ffd700;margin-bottom:20px;font-size:18px;text-align:center">
STEP 2: <span id="decidingTossWinnerName"></span> CHOOSES:
</h4>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<button onclick="decidingSetTossChoice('serve')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#fff;border-radius:8px;cursor:pointer;font-size:16px">
üèê SERVE FIRST
</button>
<button onclick="decidingSetTossChoice('receive')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#fff;border-radius:8px;cursor:pointer;font-size:16px">
üì• RECEIVE FIRST
</button>
</div>
</div>

<div class="modal-buttons">
<button class="btn-cancel" onclick="closeDecidingSetTossModal()">Cancel</button>
</div>
</div>
</div>

<div id="matchDataModal" class="modal">
<div class="modal-content" style="max-width:1200px">
<h3 class="modal-title">üíæ MATCH DATA</h3>

<div style="background:#0f3460;padding:20px;border-radius:8px;margin-bottom:15px">
<h4 style="color:#00ff00;margin-bottom:15px;font-size:18px">Match Information</h4>
<div id="matchDataInfo" style="color:#fff;font-size:13px;line-height:1.8"></div>
</div>

<div style="display:flex;gap:15px;margin-bottom:15px">
<div style="flex:1;background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#ff6b6b;margin-bottom:10px;font-size:16px">Team A</h4>
<div id="teamAData" style="color:#fff;font-size:12px"></div>
</div>
<div style="flex:1;background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#4ecdc4;margin-bottom:10px;font-size:16px">Team B</h4>
<div id="teamBData" style="color:#fff;font-size:12px"></div>
</div>
</div>

<div style="background:#0f3460;padding:20px;border-radius:8px;margin-bottom:15px">
<h4 style="color:#ffd700;margin-bottom:15px;font-size:18px">Sets Data</h4>
<div id="setsData" style="max-height:400px;overflow-y:auto"></div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="downloadMatchDataPDF()">üì• Download PDF</button>
<button class="btn-confirm" onclick="closeMatchDataModal()">Close</button>
</div>
</div>
</div>

</div>

<script>
var gameData = {
  teams: {
    A: {players: [], lineup: []},
    B: {players: [], lineup: []}
  },
  matchInfo: {},
  coinToss: {winner: null, choice: null, firstServer: null},
  selectedPlayer: null,
  score: {A: 0, B: 0},
  sets: [],
  currentSet: 1,
  swapped: false,
  startTime: null,
  setStartTime: null,
  history: [],
  timeouts: {A: 0, B: 0},
  substitutions: {A: 0, B: 0},
  timeoutTimer: null,
  matchTimerInterval: null,
  timeoutRemaining: 0,
  currentTimeoutTeam: null,
  subSelection: {playerOut: null, playerIn: null, team: null},
  liberoSelection: {libero: null, playerOut: null, team: null},
  liberoReplacements: {A: [], B: []},
  actionHistory: [],
  substitutionTracking: {A: {}, B: {}},
  injuredPlayers: {A: [], B: []}, // Track players locked due to exceptional substitution
  matchSummary: [],
  officials: null,
  rallyInProgress: false
};

function initRosterTables() {
  // Initialize with team1 and team2
  gameData.teams = {
    team1: {players: [], lineup: []},
    team2: {players: [], lineup: []}
  };
  
  createRosterRows('1');
  createRosterRows('2');
}

function createRosterRows(team) {
  var tbody = document.getElementById('rosterInput' + team);
  var html = '';
  
  for (var i = 1; i <= 14; i++) {
    html += '<tr style="background:#16213e">';
    html += '<td style="text-align:center;color:#888;font-weight:bold">' + i + '</td>';
    html += '<td><input type="text" class="roster-input" id="team' + team + '_jersey_' + i + '" maxlength="2" placeholder="#"></td>';
    html += '<td><input type="text" class="roster-input name-input" id="team' + team + '_name_' + i + '" placeholder="PLAYER NAME" style="text-transform:uppercase"></td>';
    html += '<td><select class="roster-select" id="team' + team + '_role_' + i + '">';
    html += '<option value="">-</option>';
    html += '<option value="player">Player</option>';
    html += '<option value="captain">Captain</option>';
    html += '<option value="libero1">Libero 1</option>';
    html += '<option value="libero2">Libero 2</option>';
    html += '</select></td>';
    html += '</tr>';
  }
  
  tbody.innerHTML = html;
  
  for (var i = 1; i <= 14; i++) {
    addRowListeners(team, i);
  }
}

function addRowListeners(team, row) {
  var jerseyInput = document.getElementById('team' + team + '_jersey_' + row);
  var nameInput = document.getElementById('team' + team + '_name_' + row);
  var roleInput = document.getElementById('team' + team + '_role_' + row);
  
  var updateFunction = function() {
    updatePlayerData(team, row);
  };
  
  // Use 'blur' for jersey (validates when done typing)
  jerseyInput.addEventListener('blur', function() {
    updatePlayerData(team, row);
  });
  
  // INSTANT duplicate check on every keystroke (no delay)
  jerseyInput.addEventListener('input', function() {
    var currentValue = jerseyInput.value.trim();
    // Only check if we have at least one digit
    if (currentValue.length >= 1) {
      // Instant check - no delay
      checkDuplicateJerseyInstant(team, row);
    }
  });
  
  // Keep 'input' for name (immediate feedback is fine for names)
  nameInput.addEventListener('input', updateFunction);
  
  // Special validation for role changes
  roleInput.addEventListener('change', function() {
    validateRoleSelection(team, row);
  });
}

function checkDuplicateJersey(team, row) {
  var teamKey = 'team' + team;
  var jerseyInput = document.getElementById(teamKey + '_jersey_' + row);
  var jersey = jerseyInput.value.trim();
  
  if (!jersey) return;
  
  var jerseyNum = parseInt(jersey);
  if (isNaN(jerseyNum)) return;
  
  // Get all OTHER players (exclude current row)
  var otherPlayers = gameData.teams[teamKey].players.filter(function(p) {
    return p.row !== row;
  });
  
  // Check for duplicate
  var duplicate = otherPlayers.find(function(p) {
    return parseInt(p.jersey) === jerseyNum;
  });
  
  if (duplicate) {
    // Show error and CLEAR the field
    alert('‚ùå DUPLICATE JERSEY NUMBER\n\nJersey #' + jerseyNum + ' is already used by:\n' + duplicate.name + ' (Row ' + (duplicate.row + 1) + ')\n\nEach player must have a unique jersey number.\n\nPlease choose a different number.');
    jerseyInput.value = '';
    jerseyInput.style.borderColor = '#ff0000';
    jerseyInput.style.borderWidth = '3px';
    jerseyInput.focus();
    // Remove the player data if it was saved
    gameData.teams[teamKey].players = gameData.teams[teamKey].players.filter(function(p) {
      return p.row !== row;
    });
    updateCount(team);
  } else {
    // Reset to normal
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
  }
}

function checkDuplicateJerseyInstant(team, row) {
  var teamKey = 'team' + team;
  var jerseyInput = document.getElementById(teamKey + '_jersey_' + row);
  var jersey = jerseyInput.value.trim();
  
  if (!jersey) {
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
    return;
  }
  
  var jerseyNum = parseInt(jersey);
  if (isNaN(jerseyNum)) return;
  
  // Check ALL fields in the table (not just saved data)
  var allJerseyFields = [];
  for (var i = 0; i < 14; i++) {
    var fieldId = teamKey + '_jersey_' + i;
    var field = document.getElementById(fieldId);
    if (field && i !== row) { // Skip current row
      var fieldValue = field.value.trim();
      if (fieldValue) {
        allJerseyFields.push({
          row: i,
          jersey: parseInt(fieldValue)
        });
      }
    }
  }
  
  // Check if current number already exists
  var duplicate = allJerseyFields.find(function(f) {
    return f.jersey === jerseyNum;
  });
  
  if (duplicate) {
    // Highlight in RED - duplicate detected
    jerseyInput.style.borderColor = '#ff0000';
    jerseyInput.style.borderWidth = '3px';
    jerseyInput.style.backgroundColor = '#ffcccc';
  } else {
    // Reset to normal - no duplicate
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
    jerseyInput.style.backgroundColor = '';
  }
}

function validateRoleSelection(team, row) {
  var teamKey = 'team' + team;
  var roleInput = document.getElementById(teamKey + '_role_' + row);
  var selectedRole = roleInput.value;
  
  // Only validate special roles (captain, libero1, libero2)
  if (!selectedRole || selectedRole === 'player' || selectedRole === '') {
    updatePlayerData(team, row);
    return;
  }
  
  // Get current jersey for this row (may be empty)
  var currentJersey = document.getElementById(teamKey + '_jersey_' + row).value.trim();
  
  // Check if this role is already taken by another player (exclude current row)
  // Look at ALL rows, not just saved players
  var allRoleInputs = document.querySelectorAll('[id^="' + teamKey + '_role_"]');
  var conflictFound = false;
  var conflictJersey = '';
  var conflictName = '';
  
  allRoleInputs.forEach(function(input) {
    var inputRow = input.id.split('_')[2];
    if (inputRow !== String(row) && input.value === selectedRole) {
      conflictFound = true;
      conflictJersey = document.getElementById(teamKey + '_jersey_' + inputRow).value.trim();
      conflictName = document.getElementById(teamKey + '_name_' + inputRow).value.trim();
    }
  });
  
  var roleLabels = {
    'captain': 'Captain',
    'libero1': 'Libero 1',
    'libero2': 'Libero 2'
  };
  
  if (conflictFound) {
    var conflictInfo = conflictJersey && conflictName ? 
      '#' + conflictJersey + ' ' + conflictName : 
      'Row ' + (parseInt(row) + 1);
    
    alert('‚ùå Team already has ' + roleLabels[selectedRole] + '\n\n' + 
          conflictInfo + ' is already assigned as ' + roleLabels[selectedRole] + 
          '.\n\nOnly ONE ' + roleLabels[selectedRole] + ' allowed per team.');
    roleInput.value = '';
    return;
  }
  
  // Role is valid, proceed with normal update
  updatePlayerData(team, row);
}

function updatePlayerData(team, row) {
  var teamKey = 'team' + team;
  var jersey = document.getElementById(teamKey + '_jersey_' + row).value.trim();
  var name = document.getElementById(teamKey + '_name_' + row).value.trim().toUpperCase();
  var role = document.getElementById(teamKey + '_role_' + row).value;
  
  // Find existing player in this row (if updating)
  var existingPlayer = gameData.teams[teamKey].players.find(function(p) {
    return p.row === row;
  });
  
  // Store the old jersey and role before removing
  var oldJersey = existingPlayer ? existingPlayer.jersey : null;
  var oldRole = existingPlayer ? existingPlayer.role : null;
  
  // Remove existing player from this row temporarily for validation
  var otherPlayers = gameData.teams[teamKey].players.filter(function(p) {
    return p.row !== row;
  });
  
  if (jersey && name && role) {
    var jerseyNum = parseInt(jersey);
    
    if (isNaN(jerseyNum) || jerseyNum < 1 || jerseyNum > 99) {
      alert('‚ùå INVALID JERSEY NUMBER\n\nJersey must be between 1-99');
      document.getElementById(teamKey + '_jersey_' + row).value = oldJersey || '';
      updateCount(team);
      return;
    }
    
    // Check for duplicate jersey in OTHER players only (exclude current row)
    var duplicate = otherPlayers.find(function(p) {
      return parseInt(p.jersey) === jerseyNum;
    });
    
    if (duplicate) {
      alert('‚ùå DUPLICATE JERSEY NUMBER\n\nJersey #' + jerseyNum + ' is already used by:\n' + duplicate.name + ' (Row ' + (duplicate.row + 1) + ')\n\nEach player must have a unique jersey number.\n\nPlease choose a different number.');
      document.getElementById(teamKey + '_jersey_' + row).value = oldJersey || '';
      document.getElementById(teamKey + '_jersey_' + row).focus();
      updateCount(team);
      return;
    }
    
    // Check for duplicate roles in OTHER players only
    if (role === 'captain') {
      var existingCaptain = otherPlayers.find(function(p) { 
        return p.role === 'captain';
      });
      if (existingCaptain) {
        alert('‚ùå Team already has a Captain\n\n#' + existingCaptain.jersey + ' ' + existingCaptain.name + ' is already the captain.\n\nYou can only have ONE captain per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    if (role === 'libero1') {
      var existingLibero1 = otherPlayers.find(function(p) { 
        return p.role === 'libero1';
      });
      if (existingLibero1) {
        alert('‚ùå Team already has Libero 1\n\n#' + existingLibero1.jersey + ' ' + existingLibero1.name + ' is already Libero 1.\n\nYou can only have ONE Libero 1 per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        if (existingPlayer) gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    if (role === 'libero2') {
      var existingLibero2 = otherPlayers.find(function(p) { 
        return p.role === 'libero2';
      });
      if (existingLibero2) {
        alert('‚ùå Team already has Libero 2\n\n#' + existingLibero2.jersey + ' ' + existingLibero2.name + ' is already Libero 2.\n\nYou can only have ONE Libero 2 per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        if (existingPlayer) gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    // Validation passed - update the array with new player data
    gameData.teams[teamKey].players = otherPlayers;
    gameData.teams[teamKey].players.push({
      row: row,
      jersey: jerseyNum,
      name: name,
      role: role
    });
  } else {
    // If any field is empty, just remove the player from that row
    gameData.teams[teamKey].players = otherPlayers;
  }
  
  updateCount(team);
}

function updateCount(team) {
  var teamKey = 'team' + team;
  var count = gameData.teams[teamKey].players.length;
  document.getElementById('team' + team + 'Count').textContent = count;
}

function determineCoinTossOutcome() {
  var winner = document.getElementById('coinTossWinner').value;
  var choice = document.getElementById('coinTossChoice').value;
  
  if (!winner || !choice) {
    document.getElementById('coinTossResult').style.display = 'none';
    document.getElementById('teamAssignment').style.display = 'none';
    return;
  }
  
  // Show team assignment section
  document.getElementById('teamAssignment').style.display = 'block';
  
  var loser = winner === 'team1' ? 'team2' : 'team1';
  var team1Name = document.getElementById('team1Name').value || 'Team 1';
  var team2Name = document.getElementById('team2Name').value || 'Team 2';
  var winnerName = winner === 'team1' ? team1Name : team2Name;
  var loserName = loser === 'team1' ? team1Name : team2Name;
  
  var firstServer, firstReceiver, courtSides;
  
  if (choice === 'serve') {
    firstServer = winnerName + ' (chose to serve)';
    firstReceiver = loserName;
    courtSides = loserName + ' chooses their preferred side';
  } else if (choice === 'receive') {
    firstServer = loserName;
    firstReceiver = winnerName + ' (chose to receive)';
    courtSides = loserName + ' chooses their preferred side';
  } else if (choice === 'side') {
    firstServer = loserName + ' (will serve first)';
    firstReceiver = winnerName;
    courtSides = winnerName + ' chooses their preferred side';
  }
  
  document.getElementById('firstServer').textContent = firstServer;
  document.getElementById('firstReceiver').textContent = firstReceiver;
  document.getElementById('courtSides').textContent = courtSides;
  document.getElementById('coinTossResult').style.display = 'block';
}

function determineFirstServer(winnerAB, choice) {
  // winnerAB is already 'A' or 'B'
  console.log('=== DETERMINE FIRST SERVER ===');
  console.log('Winner (A/B):', winnerAB);
  console.log('Choice:', choice);
  
  var firstServer;
  if (choice === 'serve') {
    firstServer = winnerAB;
    console.log('Choice is SERVE ‚Üí Winner serves first');
  } else if (choice === 'receive' || choice === 'side') {
    firstServer = winnerAB === 'A' ? 'B' : 'A';
    console.log('Choice is RECEIVE/SIDE ‚Üí Loser serves first');
  } else {
    firstServer = 'A';
    console.log('Default ‚Üí Team A serves');
  }
  
  console.log('=== RESULT: First server is', firstServer, '===');
  return firstServer;
}

function validateAndProceed() {
  console.log('=== validateAndProceed called ===');
  console.log('gameData.teams:', gameData.teams);
  
  // Check team assignment
  var teamAAssignment = document.getElementById('teamAAssignment').value;
  var teamBAssignment = document.getElementById('teamBAssignment').value;
  
  console.log('Team A Assignment:', teamAAssignment);
  console.log('Team B Assignment:', teamBAssignment);
  
  if (!teamAAssignment || !teamBAssignment) {
    alert('Please assign both teams to positions A and B in the Team Assignment section');
    return;
  }
  
  if (teamAAssignment === teamBAssignment) {
    alert('Each team must be assigned to a different position (A or B)');
    return;
  }
  
  // Check that teams have enough players
  console.log('team1 players:', gameData.teams.team1 ? gameData.teams.team1.players.length : 'team1 not found');
  console.log('team2 players:', gameData.teams.team2 ? gameData.teams.team2.players.length : 'team2 not found');
  
  if (!gameData.teams.team1 || gameData.teams.team1.players.length < 6) {
    alert('Team 1 needs at least 6 players. Currently has ' + (gameData.teams.team1 ? gameData.teams.team1.players.length : 0));
    return;
  }
  
  if (!gameData.teams.team2 || gameData.teams.team2.players.length < 6) {
    alert('Team 2 needs at least 6 players. Currently has ' + (gameData.teams.team2 ? gameData.teams.team2.players.length : 0));
    return;
  }
  
  // Check for duplicate jersey numbers in Team 1
  var team1Jerseys = {};
  var team1Duplicates = [];
  gameData.teams.team1.players.forEach(function(p) {
    var jersey = String(p.jersey);
    if (team1Jerseys[jersey]) {
      if (!team1Duplicates.includes(jersey)) {
        team1Duplicates.push(jersey);
      }
    }
    team1Jerseys[jersey] = true;
  });
  
  if (team1Duplicates.length > 0) {
    alert('‚ùå DUPLICATE JERSEY NUMBERS IN TEAM 1\n\nJersey #' + team1Duplicates.join(', #') + ' is used multiple times.\n\nEach player must have a unique jersey number.\n\nPlease fix the duplicates before proceeding.');
    return;
  }
  
  // Check for duplicate jersey numbers in Team 2
  var team2Jerseys = {};
  var team2Duplicates = [];
  gameData.teams.team2.players.forEach(function(p) {
    var jersey = String(p.jersey);
    if (team2Jerseys[jersey]) {
      if (!team2Duplicates.includes(jersey)) {
        team2Duplicates.push(jersey);
      }
    }
    team2Jerseys[jersey] = true;
  });
  
  if (team2Duplicates.length > 0) {
    alert('‚ùå DUPLICATE JERSEY NUMBERS IN TEAM 2\n\nJersey #' + team2Duplicates.join(', #') + ' is used multiple times.\n\nEach player must have a unique jersey number.\n\nPlease fix the duplicates before proceeding.');
    return;
  }
  
  var coinWinner = document.getElementById('coinTossWinner').value;
  var coinChoice = document.getElementById('coinTossChoice').value;
  
  console.log('Coin Toss Winner:', coinWinner);
  console.log('Coin Toss Choice:', coinChoice);
  
  if (!coinWinner || !coinChoice) {
    alert('Please complete the Coin Toss section (select winner and their choice)');
    return;
  }
  
  console.log('All validations passed, proceeding...');
  
  // Map team1/team2 to A/B based on assignment
  var sourceA = teamAAssignment; // 'team1' or 'team2'
  var sourceB = teamBAssignment; // 'team1' or 'team2'
  
  var team1Name = document.getElementById('team1Name').value;
  var team2Name = document.getElementById('team2Name').value;
  var team1Color = document.getElementById('team1Color').value;
  var team2Color = document.getElementById('team2Color').value;
  
  // Create A and B from assigned teams
  gameData.teams.A = {
    players: gameData.teams[sourceA].players.slice(),
    lineup: []
  };
  gameData.teams.B = {
    players: gameData.teams[sourceB].players.slice(),
    lineup: []
  };
  
  gameData.matchInfo = {
    date: document.getElementById('matchDate').value,
    time: document.getElementById('matchTime').value,
    city: document.getElementById('matchCity').value,
    countryCode: document.getElementById('matchCountryCode').value,
    division: document.getElementById('matchDivision').value,
    category: document.getElementById('matchCategory').value,
    pool: document.getElementById('matchPool').value,
    competition: document.getElementById('comp').value,
    matchNumber: document.getElementById('matchNo').value,
    venue: document.getElementById('venue').value,
    format: document.getElementById('fmt').value,
    subLimit: parseInt(document.getElementById('subLimitSel').value) || 6,
    teamAName: sourceA === 'team1' ? team1Name : team2Name,
    teamBName: sourceB === 'team1' ? team1Name : team2Name,
    teamAColor: sourceA === 'team1' ? team1Color : team2Color,
    teamBColor: sourceB === 'team1' ? team1Color : team2Color,
    ref1: document.getElementById('ref1').value,
    ref2: document.getElementById('ref2').value,
    scorer: document.getElementById('scorer').value,
    assistScorer: document.getElementById('assistScorer').value
  };
  
  console.log('=== TEAM COLOR ASSIGNMENT ===');
  console.log('Team 1 Name:', team1Name, 'Color:', team1Color);
  console.log('Team 2 Name:', team2Name, 'Color:', team2Color);
  console.log('Source A:', sourceA, '‚Üí Team A Name:', gameData.matchInfo.teamAName, 'Color:', gameData.matchInfo.teamAColor);
  console.log('Source B:', sourceB, '‚Üí Team B Name:', gameData.matchInfo.teamBName, 'Color:', gameData.matchInfo.teamBColor);
  
  // Apply team colors dynamically
  applyTeamColors();
  
  // Convert coin toss winner from team1/team2 to A/B
  var coinWinnerAB = coinWinner === sourceA ? 'A' : 'B';
  
  console.log('=== COIN TOSS CONVERSION ===');
  console.log('Coin winner (team1/team2):', coinWinner);
  console.log('sourceA:', sourceA, '= Team A:', gameData.matchInfo.teamAName);
  console.log('sourceB:', sourceB, '= Team B:', gameData.matchInfo.teamBName);
  console.log('Coin winner AB:', coinWinnerAB);
  console.log('Team', coinWinnerAB, '=', gameData.matchInfo['team' + coinWinnerAB + 'Name'], 'won coin toss');
  
  gameData.coinToss = {
    winner: coinWinnerAB,  // Store as 'A' or 'B'
    choice: coinChoice,
    firstServer: determineFirstServer(coinWinnerAB, coinChoice)
  };
  
  console.log('=== COIN TOSS FINAL ===');
  console.log('Winner:', gameData.coinToss.winner, '=', gameData.matchInfo['team' + gameData.coinToss.winner + 'Name']);
  console.log('Choice:', gameData.coinToss.choice);
  console.log('First Server:', gameData.coinToss.firstServer, '=', gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name']);
  
  showLineupSetup();
}

function applyTeamColors() {
  var colorA = gameData.matchInfo.teamAColor || '#ff6b6b';
  var colorB = gameData.matchInfo.teamBColor || '#4ecdc4';
  
  // Create or update style element for team colors
  var styleId = 'teamColorStyles';
  var styleElement = document.getElementById(styleId);
  
  if (!styleElement) {
    styleElement = document.createElement('style');
    styleElement.id = styleId;
    document.head.appendChild(styleElement);
  }
  
  styleElement.textContent = `
    :root {
      --team-a-color: ${colorA};
      --team-b-color: ${colorB};
    }
    .team-a { color: ${colorA} !important; }
    .team-b { color: ${colorB} !important; }
    .set-won-a { background: ${colorA} !important; border-color: ${colorA} !important; }
    .set-won-b { background: ${colorB} !important; border-color: ${colorB} !important; }
  `;
}

function showLineupSetup() {
  document.getElementById('teamANameSetup').textContent = gameData.matchInfo.teamAName;
  document.getElementById('teamBNameSetup').textContent = gameData.matchInfo.teamBName;
  
  // Initialize lineup arrays so player assignments can be stored
  if (!gameData.teams.A.lineup) gameData.teams.A.lineup = [];
  if (!gameData.teams.B.lineup) gameData.teams.B.lineup = [];
  
  renderRosterSetup('A');
  renderRosterSetup('B');
  
  document.getElementById('lineupModal').classList.add('active');
}

function renderRosterSetup(team) {
  // Make sure players array exists
  if (!gameData.teams[team] || !gameData.teams[team].players) {
    console.error('No players data for team', team);
    document.getElementById('roster' + team + 'Setup').innerHTML = '<p style="color:#ff0000">Error: No roster data</p>';
    return;
  }
  
  // Get injured players (locked due to exceptional substitution)
  var injuredPlayers = gameData.injuredPlayers[team] || [];

  // Get disqualified players (locked for entire match via sanction)
  var disqualifiedJerseys = [];
  if (gameData.sanctionSystem && gameData.sanctionSystem.disqualified[team]) {
    disqualifiedJerseys = gameData.sanctionSystem.disqualified[team].map(function(e) { return e.jersey; });
  }
  
  var players = gameData.teams[team].players.filter(function(p) {
    return p.role !== 'libero1' && p.role !== 'libero2';
  }).sort(function(a, b) {
    return a.jersey - b.jersey;
  });
  
  var html = '';
  players.forEach(function(p) {
    var isReplaced = isPlayerReplacedByLibero(team, p.jersey);
    var isInjured = injuredPlayers.includes(p.jersey);
    var isDisqualified = disqualifiedJerseys.some(function(j) { return String(j) === String(p.jersey); });
    
    if (!isReplaced && !isInjured && !isDisqualified) {
      var badge = p.role === 'captain' ? ' <span style="background:#ffd700;color:#000;padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold">C</span>' : '';
      var playerName = p.name || 'Unknown';
      html += '<div class="roster-player" onclick="selectPlayerForLineup(\'' + team + '\',' + p.jersey + ')"><strong>#' + p.jersey + '</strong> ' + playerName + badge + '</div>';
    }
  });
  
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  liberos.forEach(function(p) {
    var replacingPlayer = getPlayerReplacedByLibero(team, p.jersey);
    if (replacingPlayer) {
      var badge = ' <span style="background:#9c27b0;color:#fff;padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold">LIBERO</span>';
      var playerName = p.name || 'Unknown';
      html += '<div class="roster-player" onclick="selectPlayerForLineup(\'' + team + '\',' + p.jersey + ')"><strong>#' + p.jersey + '</strong> ' + playerName + badge + '</div>';
    }
  });
  
  // Show warning for injured players
  if (injuredPlayers.length > 0) {
    html += '<div style="background:#ff3b3b;color:#fff;padding:8px;margin-top:10px;border-radius:4px;font-size:10px;">';
    html += 'üöë Injured (Locked):<br>';
    injuredPlayers.forEach(function(jersey) {
      var p = gameData.teams[team].players.find(function(player) { return player.jersey === jersey; });
      if (p) {
        html += '‚Ä¢ #' + jersey + ' ' + p.name + '<br>';
      }
    });
    html += '</div>';
  }

  // Show warning for disqualified players
  if (disqualifiedJerseys.length > 0) {
    html += '<div style="background:#7b0000;color:#fff;padding:8px;margin-top:6px;border-radius:4px;font-size:10px;">';
    html += 'üü•‚ùå Disqualified (Match ‚Äî Cannot Play):<br>';
    disqualifiedJerseys.forEach(function(jersey) {
      var p = gameData.teams[team].players.find(function(player) { return String(player.jersey) === String(jersey); });
      if (p) {
        html += '‚Ä¢ #' + jersey + ' ' + p.name + '<br>';
      }
    });
    html += '</div>';
  }
  
  if (html === '' || html.indexOf('roster-player') === -1) {
    html = '<p style="color:#888;padding:10px">No available players</p>' + (html || '');
  }
  
  document.getElementById('roster' + team + 'Setup').innerHTML = html;
}

function selectPlayerForLineup(team, jersey) {
  // Check if player is injured (locked due to exceptional substitution)
  var injuredPlayers = gameData.injuredPlayers[team] || [];
  if (injuredPlayers.includes(jersey)) {
    var playerInfo = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
    var playerName = playerInfo ? playerInfo.name : 'Player';
    alert('üöë PLAYER LOCKED\n\nPlayer #' + jersey + ' ' + playerName + ' was exceptionally substituted due to injury and cannot return in this match.');
    return;
  }

  // Check if player is disqualified (locked for entire match via sanction)
  if (gameData.sanctionSystem && gameData.sanctionSystem.disqualified[team]) {
    var isDisq = gameData.sanctionSystem.disqualified[team].some(function(e) {
      return String(e.jersey) === String(jersey);
    });
    if (isDisq) {
      var playerInfo2 = gameData.teams[team].players.find(function(p) { return String(p.jersey) === String(jersey); });
      var playerName2 = playerInfo2 ? playerInfo2.name : 'Player';
      alert('üü•‚ùå PLAYER DISQUALIFIED\n\nPlayer #' + jersey + ' ' + playerName2 + ' has been DISQUALIFIED and cannot participate for the remainder of this match.');
      return;
    }
  }
  
  gameData.selectedPlayer = {team: team, jersey: jersey};
  
  // Clear all selections first
  var players = document.querySelectorAll('#roster' + team + 'Setup .roster-player');
  players.forEach(function(el) {
    el.classList.remove('selected');
  });
  
  // Now select only the clicked player by checking exact jersey match
  players.forEach(function(el) {
    var text = el.textContent.trim();
    // Extract jersey number from text like "#1 A" or "#13 Name C"
    // Match: starts with # followed by the exact number followed by space or end
    var jerseyPattern = new RegExp('^#' + jersey + '(?:\\s|$)');
    if (jerseyPattern.test(text)) {
      el.classList.add('selected');
    }
  });
  
  var positions = document.querySelectorAll('#court' + team + 'Setup .court-setup-pos');
  positions.forEach(function(el) {
    el.style.cursor = 'pointer';
    el.style.opacity = '1';
  });
}

function assignPosition(team, pos) {
  if (!gameData.selectedPlayer || gameData.selectedPlayer.team !== team) {
    alert('Please select a player from ' + team + ' first');
    return;
  }
  
  var jersey = gameData.selectedPlayer.jersey;
  
  // Check if player is already assigned to another position
  var currentPositionIndex = gameData.teams[team].lineup.indexOf(jersey);
  if (currentPositionIndex !== -1 && currentPositionIndex !== (pos - 1)) {
    var playerInfo = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
    var playerName = playerInfo ? playerInfo.name : 'Player';
    alert('‚ö†Ô∏è ' + playerName + ' (#' + jersey + ') is already assigned to Position ' + (currentPositionIndex + 1) + '.\n\nPlease click on their current position to remove them first, then assign to the new position.');
    return;
  }
  
  gameData.teams[team].lineup[pos - 1] = jersey;
  
  updateCourtSetup(team);
  gameData.selectedPlayer = null;
  
  var players = document.querySelectorAll('#roster' + team + 'Setup .roster-player');
  players.forEach(function(el) {
    el.classList.remove('selected');
  });
}

function updateCourtSetup(team) {
  var grid = document.getElementById('court' + team + 'Setup');
  var positions = grid.querySelectorAll('.court-setup-pos');
  
  positions.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    var jersey = gameData.teams[team].lineup[pos - 1];
    var player = jersey ? gameData.teams[team].players.find(function(p) { return p.jersey === jersey; }) : null;
    
    if (player) {
      el.classList.add('filled');
      el.querySelector('.pos-setup-num').textContent = '#' + player.jersey;
    } else {
      el.classList.remove('filled');
      el.querySelector('.pos-setup-num').textContent = '-';
    }
  });
}

function cancelLineup() {
  document.getElementById('lineupModal').classList.remove('active');
  gameData.teams.A.lineup = [];
  gameData.teams.B.lineup = [];
}

function startMatch() {
  console.log('=== START MATCH VALIDATION ===');
  console.log('Team A lineup:', gameData.teams.A.lineup);
  console.log('Team B lineup:', gameData.teams.B.lineup);
  
  // Filter out null, undefined, empty string, and 0
  var aFilled = gameData.teams.A.lineup.filter(function(x) { 
    return x !== null && x !== undefined && x !== '' && x !== 0; 
  }).length;
  var bFilled = gameData.teams.B.lineup.filter(function(x) { 
    return x !== null && x !== undefined && x !== '' && x !== 0; 
  }).length;
  
  console.log('Team A filled positions:', aFilled);
  console.log('Team B filled positions:', bFilled);
  
  if (aFilled !== 6) {
    alert('Team A needs exactly 6 players on court.\n\nCurrently has: ' + aFilled + ' players\n\nPlease assign all 6 positions.');
    return;
  }
  
  if (bFilled !== 6) {
    alert('Team B needs exactly 6 players on court.\n\nCurrently has: ' + bFilled + ' players\n\nPlease assign all 6 positions.');
    return;
  }
  
  // Remove the event listener so it doesn't fire again for subsequent sets
  document.getElementById('startMatchBtn').removeEventListener('click', startMatch);
  
  gameData.sets = [{
    score: {A: 0, B: 0},
    timeouts: {A: [], B: []},
    substitutions: {A: [], B: []},
    substitutionTracking: {A: {}, B: {}},
    completedSubstitutions: {A: [], B: []},
    serving: gameData.coinToss.firstServer,
    firstServer: gameData.coinToss.firstServer,  // NEW: Track who served FIRST (never changes)
    winner: null,
    startTime: null,  // Will be set when first rally starts
    lineupA: gameData.teams.A.lineup.slice(),
    lineupB: gameData.teams.B.lineup.slice()
  }];
  
  // PATCH: Capture libero serving slots now that lineups are finalized
  if (typeof LiberoServe !== 'undefined' && LiberoServe.captureDesignatedSlots) {
    LiberoServe.captureDesignatedSlots();
  }
  
  gameData.startTime = Date.now();
  gameData.setStartTime = null;  // Will be set on first rally
  gameData.currentSet = 1;
  gameData.swapped = false;
  
  document.getElementById('lineupModal').classList.remove('active');
  document.getElementById('setupScreen').classList.add('hidden');
  document.getElementById('matchScreen').classList.remove('hidden');
  
  updateMatchDisplay();
  startMatchTimer();
  
  // Check for libero entry at start of match - BOTH teams BEFORE first serve
  // Show them SEQUENTIALLY - second modal only appears after first is closed
  var set = gameData.sets[gameData.currentSet - 1];
  var servingTeam = set.serving;
  var receivingTeam = servingTeam === 'A' ? 'B' : 'A';
  
  // Show RECEIVING team modal FIRST
  setTimeout(function() {
    checkAutoLiberoEntryWithCallback(receivingTeam, function() {
      // After receiving team modal is done, show SERVING team modal
      setTimeout(function() {
        checkAutoLiberoEntryWithCallback(servingTeam, function() {
          // Both modals done
        });
      }, 500);
    });
  }, 800);
}

// New function that calls callback after modal closes
function checkAutoLiberoEntryWithCallback(team, callback) {
  // Safety check - make sure team data exists
  if (!gameData.teams || !gameData.teams[team] || !gameData.teams[team].players) {
    console.log('Team data not ready for', team);
    if (callback) callback();
    return;
  }
  
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  if (liberos.length === 0) {
    if (callback) callback();
    return;
  }

  // Filter out expelled/disqualified liberos ‚Äî they cannot enter court (FIVB Art.19.3)
  liberos = liberos.filter(function(lib) {
    return !SM.isPlayerLocked(team, String(lib.jersey));
  });
  if (liberos.length === 0) {
    if (callback) callback();
    return;
  }
  
  var liberoOnCourt = false;
  liberos.forEach(function(lib) {
    if (gameData.teams[team].lineup.includes(lib.jersey)) {
      liberoOnCourt = true;
    }
  });
  
  if (liberoOnCourt) {
    if (callback) callback();
    return;
  }
  
  // Safety check - make sure sets array exists
  if (!gameData.sets || gameData.sets.length === 0 || !gameData.sets[gameData.currentSet - 1]) {
    console.log('Sets data not ready');
    if (callback) callback();
    return;
  }
  
  var set = gameData.sets[gameData.currentSet - 1];
  var isFirstServe = set.score.A === 0 && set.score.B === 0;
  
  if (!isFirstServe) {
    if (callback) callback();
    return;
  }
  
  var isServing = set.serving === team;
  var targetPosIndex = isServing ? 5 : 0; // P6 for serving, P1 for receiving
  var targetPosition = isServing ? 6 : 1;
  
  console.log('=== LIBERO POSITION CHECK ===');
  console.log('Team:', team);
  console.log('set.serving:', set.serving);
  console.log('isServing:', isServing);
  console.log('targetPosIndex:', targetPosIndex, '(should be 5 for P6 if serving, 0 for P1 if receiving)');
  console.log('targetPosition:', targetPosition, '(should be 6 if serving, 1 if receiving)');
  
  var jersey = gameData.teams[team].lineup[targetPosIndex];
  var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
  
  if (!player || player.role === 'libero1' || player.role === 'libero2') {
    if (callback) callback();
    return;
  }
  
  var targetData = {
    player: player,
    position: targetPosition,
    posIndex: targetPosIndex,
    jersey: jersey
  };
  
  // Store callback to call after modal closes
  gameData.liberoEntryCallback = callback;
  
  showAutoLiberoEntryModal(team, targetData, liberos);
}

function startMatchTimer() {
  // Update timers every second
  if (gameData.matchTimerInterval) {
    clearInterval(gameData.matchTimerInterval);
  }
  
  gameData.matchTimerInterval = setInterval(function() {
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  // Update Match Duration (actual elapsed time)
  if (gameData.startTime) {
    var matchElapsed = Math.floor((Date.now() - gameData.startTime) / 1000);
    
    var matchHours = Math.floor(matchElapsed / 3600);
    var matchMins = Math.floor((matchElapsed % 3600) / 60);
    var matchSecs = matchElapsed % 60;
    
    var matchDurationStr = 
      (matchHours < 10 ? '0' : '') + matchHours + ':' +
      (matchMins < 10 ? '0' : '') + matchMins + ':' +
      (matchSecs < 10 ? '0' : '') + matchSecs;
    
    document.getElementById('matchDuration').textContent = matchDurationStr;
  }
  
  // Update Set Duration
  if (gameData.setStartTime) {
    var setElapsed = Math.floor((Date.now() - gameData.setStartTime) / 1000);
    var setMins = Math.floor(setElapsed / 60);
    var setSecs = setElapsed % 60;
    
    var setDurationStr = 
      (setMins < 10 ? '0' : '') + setMins + ':' +
      (setSecs < 10 ? '0' : '') + setSecs;
    
    document.getElementById('setDuration').textContent = setDurationStr;
  }
}

function startIntervalTimer(seconds, callback) {
  console.log('=== STARTING INTERVAL TIMER: ' + seconds + ' seconds ===');
  
  // Clear any existing interval timer first
  if (gameData.intervalTimer) {
    clearInterval(gameData.intervalTimer);
  }
  
  // Show interval timer in top bar
  document.getElementById('intervalTimerDisplay').style.display = 'inline';
  
  var remaining = seconds;
  document.getElementById('intervalTimerText').textContent = formatIntervalTime(remaining);
  
  console.log('Interval timer display shown, starting countdown from', formatIntervalTime(remaining));
  
  gameData.intervalTimer = setInterval(function() {
    remaining--;
    document.getElementById('intervalTimerText').textContent = formatIntervalTime(remaining);
    
    if (remaining <= 0) {
      clearInterval(gameData.intervalTimer);
      gameData.intervalTimer = null;
      document.getElementById('intervalTimerDisplay').style.display = 'none';
      console.log('Interval timer complete');
      if (callback) callback();
    }
  }, 1000);
  
  // Store callback for manual end if needed
  gameData.intervalCallback = callback;
}

function formatIntervalTime(seconds) {
  var mins = Math.floor(seconds / 60);
  var secs = seconds % 60;
  return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function updateMatchDisplay() {
  console.log('=== UPDATE MATCH DISPLAY ===');
  console.log('Current Set Number:', gameData.currentSet);
  console.log('Total Sets in Array:', gameData.sets.length);
  console.log('Swapped:', gameData.swapped);
  
  var tA = gameData.swapped ? 'B' : 'A';
  var tB = gameData.swapped ? 'A' : 'B';
  var set = gameData.sets[gameData.currentSet - 1];
  
  console.log('Set Object:', set);
  
  if (!set) {
    console.error('ERROR: Set object is undefined! currentSet=' + gameData.currentSet + ', sets.length=' + gameData.sets.length);
    console.error('This should not happen! Aborting updateMatchDisplay.');
    return;
  }
  
  document.getElementById('topInfo').innerHTML = gameData.matchInfo.competition + '<br>' + gameData.matchInfo.venue;
  
  // Colors follow the TEAMS - teams carry their colors when they swap
  var leftSideColor = (tA === 'A') ? gameData.matchInfo.teamAColor : gameData.matchInfo.teamBColor;
  var rightSideColor = (tB === 'A') ? gameData.matchInfo.teamAColor : gameData.matchInfo.teamBColor;
  
  console.log('=== APPLYING COLORS ===');
  console.log('Left side (' + gameData.matchInfo['team' + tA + 'Name'] + '):', leftSideColor);
  console.log('Right side (' + gameData.matchInfo['team' + tB + 'Name'] + '):', rightSideColor);
  
  document.getElementById('nameDispA').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('nameDispA').setAttribute('style', 'color: ' + leftSideColor + ' !important');
  
  document.getElementById('nameDispB').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('nameDispB').setAttribute('style', 'color: ' + rightSideColor + ' !important');
  
  document.getElementById('courtNameA').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('courtNameA').setAttribute('style', 'color: ' + leftSideColor + ' !important');
  
  document.getElementById('courtNameB').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('courtNameB').setAttribute('style', 'color: ' + rightSideColor + ' !important');
  
  document.getElementById('sideATtl').textContent = gameData.matchInfo['team' + tA + 'Name'] + ' LINEUP';
  document.getElementById('sideATtl').setAttribute('style', 'color: ' + leftSideColor + ' !important');
  
  document.getElementById('sideBTtl').textContent = gameData.matchInfo['team' + tB + 'Name'] + ' LINEUP';
  document.getElementById('sideBTtl').setAttribute('style', 'color: ' + rightSideColor + ' !important');
  
  document.getElementById('scoreDispA').textContent = set.score[tA];
  document.getElementById('scoreDispB').textContent = set.score[tB];
  
  document.getElementById('setDisp').textContent = gameData.currentSet;
  
  // Display sets won for the teams currently on each side (accounting for swaps)
  var setsWonByTeamA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonByTeamB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  // setsA display shows the team currently on the A (left) side
  // If swapped, Team B is on the left, so show Team B's sets
  if (gameData.swapped) {
    document.getElementById('setsA').textContent = setsWonByTeamB;
    document.getElementById('setsB').textContent = setsWonByTeamA;
  } else {
    document.getElementById('setsA').textContent = setsWonByTeamA;
    document.getElementById('setsB').textContent = setsWonByTeamB;
  }
  
  document.getElementById('toDispA').textContent = set.timeouts[tA].length + '/2';
  document.getElementById('toDispB').textContent = set.timeouts[tB].length + '/2';
  
  // Calculate actual substitution count using the tracking system
  var subCountA = countCompletedSubstitutions(tA, gameData.currentSet - 1);
  var subCountB = countCompletedSubstitutions(tB, gameData.currentSet - 1);
  
  var _subLimHUD = getSubLimit();
  document.getElementById('subDispA').textContent = subCountA + '/' + _subLimHUD;
  document.getElementById('subDispB').textContent = subCountB + '/' + _subLimHUD;
  
  // Service indicator - with debug logging
  console.log('=== SERVICE DISPLAY ===');
  console.log('set.serving:', set.serving);
  console.log('tA (display left):', tA);
  console.log('tB (display right):', tB);
  console.log('tA serving?', set.serving === tA);
  console.log('tB serving?', set.serving === tB);
  
  document.getElementById('servDispA').textContent = set.serving === tA ? '‚ö° YES' : 'NO';
  document.getElementById('servDispB').textContent = set.serving === tB ? '‚ö° YES' : 'NO';
  
  var maxSets = parseInt(gameData.matchInfo.format);
  var targetPoints = 25; // Default
  
  // Deciding set plays to 15
  if (maxSets === 5 && gameData.currentSet === 5) {
    targetPoints = 15;
  } else if (maxSets === 3 && gameData.currentSet === 3) {
    targetPoints = 15;
  }
  
  document.getElementById('setTypeDisp').textContent = '(First to ' + targetPoints + ', win by 2)';
  
  var dotsHTML = '';
  console.log('=== GENERATING SET DOTS ===');
  console.log('Total sets to display:', maxSets);
  console.log('Actual sets in array:', gameData.sets.length);
  
  for (var i = 0; i < maxSets; i++) {
    var s = gameData.sets[i];
    var dotStyle = '';
    
    console.log('Set ' + (i+1) + ':', s ? {score: s.score, winner: s.winner} : 'undefined');
    
    if (s && s.winner) {
      // Use the actual team color from matchInfo
      var winnerColor = gameData.matchInfo['team' + s.winner + 'Color'];
      dotStyle = 'style="background: ' + winnerColor + '; border-color: ' + winnerColor + ';"';
      console.log('  ‚Üí Applying color for Team ' + s.winner + ':', winnerColor);
    } else {
      console.log('  ‚Üí No color (set not won yet)');
    }
    
    dotsHTML += '<div class="set-dot" ' + dotStyle + '>' + (i + 1) + '</div>';
  }
  document.getElementById('setDotsDisp').innerHTML = dotsHTML;
  
  updateCourtDisplay(tA, 'A');
  updateCourtDisplay(tB, 'B');
  
  updateLineupPanel(tA, 'A');
  updateLineupPanel(tB, 'B');
  
  // Share data with other display windows
  localStorage.setItem('volleyballGameData', JSON.stringify(gameData));
}

function updateCourtDisplay(team, side) {
  var grid = document.getElementById('courtGrid' + side);
  var positions = grid.querySelectorAll('.court-pos');
  var set = gameData.sets[gameData.currentSet - 1];
  
  positions.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    var jersey = gameData.teams[team].lineup[pos - 1];
    var player = jersey ? gameData.teams[team].players.find(function(p) { return p.jersey === jersey; }) : null;
    
    var jerseyEl = el.querySelector('.pos-jersey');
    if (!jerseyEl) {
      jerseyEl = document.createElement('div');
      jerseyEl.className = 'pos-jersey';
      el.appendChild(jerseyEl);
    }
    
    // Check if this position has a libero
    var isLiberoOnCourt = false;
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      isLiberoOnCourt = true;
    }
    
    if (player) {
      jerseyEl.textContent = '#' + player.jersey;
    } else {
      jerseyEl.textContent = '-';
    }
    
    // Add libero highlighting
    if (isLiberoOnCourt) {
      el.classList.add('libero-on-court');
    } else {
      el.classList.remove('libero-on-court');
    }
    
    if (pos === 1 && set.serving === team) {
      el.classList.add('server');
    } else {
      el.classList.remove('server');
    }
  });
}

function updateLineupPanel(team, side) {
  var players = gameData.teams[team].players.sort(function(a, b) {
    return a.jersey - b.jersey;
  });
  
  var html = '';
  players.forEach(function(p) {
    var onCourt = gameData.teams[team].lineup.includes(p.jersey);
    var badge = '';
    if (p.role === 'captain') badge = '<span class="lineup-badge badge-c">C</span>';
    else if (p.role === 'libero1') badge = '<span class="lineup-badge badge-l">L1</span>';
    else if (p.role === 'libero2') badge = '<span class="lineup-badge badge-l">L2</span>';
    
    var pos = '';
    if (onCourt) {
      var idx = gameData.teams[team].lineup.indexOf(p.jersey);
      if (idx >= 0) pos = 'P' + (idx + 1);
    }
    
    // ‚îÄ‚îÄ Sanction card symbols ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // RULE: Cards from CURRENT set shown normally (bright, full size)
    //       Cards from PREVIOUS sets shown dimmed (opacity 0.4, italic, S# superscript)
    //       EXP (expulsion) = locked THIS set only, NOT carried forward
    //       DISQ (disqualification) = locked entire match
    var cardSymbols = '';
    var isExpelled  = false;  // expelled in current set
    var isDisq      = false;  // disqualified (whole match)

    if (gameData.sanctionSystem) {
      var jerseyStr = String(p.jersey);

      // ‚îÄ‚îÄ 1. Is player DISQUALIFIED (entire match)? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      if (gameData.sanctionSystem.disqualified[team].some(function(e){
            return String(e.jersey) === jerseyStr;
          })) {
        isDisq = true;
        cardSymbols += '<span title="DISQUALIFIED ‚Äî out for match" style="margin-left:3px;font-size:11px">üü•‚ùå</span>';
      }

      // ‚îÄ‚îÄ 2. All misconduct records for this player, split by set ‚îÄ‚îÄ
      // (We show EXP/W/P cards for all sets; EXP for current set ‚Üí lock)
      var currentCardStr  = '';  // bright, full-size ‚Äî current set
      var previousEntries = [];  // {sym, set} ‚Äî previous sets, shown dimmed

      gameData.sanctionSystem.misconduct[team].forEach(function(r) {
        if (String(r.person) !== jerseyStr) return;
        var sym = '';
        if      (r.type === 'W')    sym = 'üü®';
        else if (r.type === 'P')    sym = 'üü•';
        else if (r.type === 'EXP')  sym = 'üü®üü•';
        else if (r.type === 'DISQ') sym = 'üü•‚ùå';
        if (!sym) return;

        if (r.set === gameData.currentSet) {
          // Current set card: show bright
          currentCardStr += sym;
          // Mark as expelled-this-set if EXP type
          if (r.type === 'EXP') isExpelled = true;
        } else {
          // Previous set card: collect for dimmed display
          previousEntries.push({sym: sym, set: r.set});
        }
      });

      // Build card badge HTML
      if (currentCardStr) {
        cardSymbols += '<span style="margin-left:3px;font-size:11px">' + currentCardStr + '</span>';
      }
      previousEntries.forEach(function(entry) {
        // Dimmed, italic, with set superscript ‚Äî clearly NOT current set
        cardSymbols += '<span style="margin-left:3px;font-size:10px;opacity:0.4;color:#bbb;font-style:italic" '
          + 'title="Set ' + entry.set + ' card (not carried forward)">'
          + entry.sym
          + '<sup style="font-size:8px;vertical-align:super">S' + entry.set + '</sup>'
          + '</span>';
      });

    } else if (gameData.sanctions && gameData.sanctions[team]) {
      // ‚îÄ‚îÄ Legacy path (no sanctionSystem) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      var jerseyStr2 = String(p.jersey);
      var currentCardStr2  = '';
      var previousEntries2 = [];
      gameData.sanctions[team].forEach(function(s) {
        if (String(s.player).trim() !== jerseyStr2) return;
        var sym = '';
        if      (s.type === 'misconduct_warning')        sym = 'üü®';
        else if (s.type === 'misconduct_penalty')        sym = 'üü•';
        else if (s.type === 'misconduct_expulsion')      sym = 'üü®üü•';
        else if (s.type === 'misconduct_disqualification') sym = 'üü•‚ùå';
        else if (s.type === 'delay')                     sym = '‚è±Ô∏è';
        else if (s.type === 'delay_penalty')             sym = '‚è±Ô∏èüü•';
        if (!sym) return;
        var sSet = s.set || 1;
        if (sSet === gameData.currentSet) {
          currentCardStr2 += sym;
          if (s.type === 'misconduct_expulsion') isExpelled = true;
        } else {
          previousEntries2.push({sym: sym, set: sSet});
        }
      });
      if (currentCardStr2) {
        cardSymbols += '<span style="margin-left:3px;font-size:11px">' + currentCardStr2 + '</span>';
      }
      previousEntries2.forEach(function(entry) {
        cardSymbols += '<span style="margin-left:3px;font-size:10px;opacity:0.4;color:#bbb;font-style:italic" '
          + 'title="Set ' + entry.set + ' card (not carried forward)">'
          + entry.sym
          + '<sup style="font-size:8px;vertical-align:super">S' + entry.set + '</sup>'
          + '</span>';
      });
    }
    
    var rowStyle = isDisq ? 'opacity:0.45;text-decoration:line-through' : (isExpelled ? 'opacity:0.55' : '');
    html += '<div class="lineup-item" style="' + rowStyle + '">';
    html += '<div><span class="lineup-pos">' + pos + '</span> <strong>#' + p.jersey + '</strong> ' + p.name + badge + cardSymbols + '</div>';
    if (onCourt && !isDisq && !isExpelled) html += '<span class="on-court">‚óè</span>';
    html += '</div>';
  });
  
  document.getElementById('lineup' + side).innerHTML = html;
}

function addPointToTeam(team) {
  var set = gameData.sets[gameData.currentSet - 1];
  var opponent = team === 'A' ? 'B' : 'A';
  
  saveActionToHistory({
    type: 'point',
    team: team,
    previousScore: {A: set.score.A, B: set.score.B},
    previousServing: set.serving,
    previousLineupA: gameData.teams.A.lineup.slice(),
    previousLineupB: gameData.teams.B.lineup.slice(),
    previousLiberoReplacementsA: JSON.parse(JSON.stringify(gameData.liberoReplacements.A || [])),
    previousLiberoReplacementsB: JSON.parse(JSON.stringify(gameData.liberoReplacements.B || [])),
    setNumber: gameData.currentSet,
    previousSummaryLength: (gameData.matchSummary || []).length
  });
  
  set.score[team]++;
  
  // Add to match summary
  var teamName = team === 'A' ? gameData.matchInfo.teamAName : gameData.matchInfo.teamBName;
  addSummaryEvent('Pt', team, 'Point scored - Score: ' + set.score.A + '-' + set.score.B);
  
  if (set.serving !== team) {
    set.serving = team;
    rotateTeam(team);
    
    // Team that WON the point and will SERVE next - they rotate but NO libero popup (libero can't serve)
    // Team that LOST the point (opponent) - they can now replace P1 with libero (they're not serving)
    
    // Check for libero entry for OPPONENT (lost point, now receiving, can replace P1)
    setTimeout(function() {
      checkAutoLiberoEntryAfterLosingService(opponent);
    }, 600);
  }
  
  // FIVB Rules: Determine target score based on current set number and format
  var maxSets = parseInt(gameData.matchInfo.format);
  var target = 25; // Default to 25 points
  
  // Deciding set (5th set in best of 5, 3rd set in best of 3) plays to 15 points
  if (maxSets === 5 && gameData.currentSet === 5) {
    target = 15; // 5th set in best of 5
  } else if (maxSets === 3 && gameData.currentSet === 3) {
    target = 15; // 3rd set in best of 3
  }
  
  console.log('Set ' + gameData.currentSet + ' target: ' + target + ' points (Format: Best of ' + maxSets + ')');
  
  // Must win by at least 2 points
  if (set.score[team] >= target && set.score[team] - set.score[opponent] >= 2) {
    console.log('=== SET WIN DETECTED ===');
    console.log('Winning team:', team);
    console.log('Score:', set.score[team] + '-' + set.score[opponent]);
    console.log('Setting set.winner =', team);
    
    set.winner = team;
    set.endTime = Date.now();
    
    console.log('After setting - set.winner:', set.winner);
    console.log('SET WON by Team ' + team + ': ' + set.score[team] + '-' + set.score[opponent]);
    
    // Add set win to summary
    addSummaryEvent('SET WIN', team, 'Won Set ' + gameData.currentSet + ' (' + set.score[team] + '-' + set.score[opponent] + ')');
    
    // Count how many sets each team has won
    var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
    var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
    var setsNeeded = maxSets === 5 ? 3 : 2;
    
    console.log('Sets won - Team A: ' + setsWonA + ', Team B: ' + setsWonB + ' (Need ' + setsNeeded + ' to win match)');
    
    // Check if a team has won the match
    if (setsWonA >= setsNeeded || setsWonB >= setsNeeded) {
      // Stop all timers when match is won
      if (gameData.matchTimerInterval) {
        clearInterval(gameData.matchTimerInterval);
        gameData.matchTimerInterval = null;
      }
      
      // Stop interval timer if running
      if (gameData.intervalTimer) {
        clearInterval(gameData.intervalTimer);
        gameData.intervalTimer = null;
        document.getElementById('intervalTimerDisplay').style.display = 'none';
      }
      
      // Mark match as ended
      gameData.matchEnded = true;
      gameData.matchEndTime = Date.now();
      
      setTimeout(function() {
        alert('üèÜ ' + gameData.matchInfo['team' + team + 'Name'] + ' WINS THE MATCH!\n\nFinal Score: ' + set.score[team] + '-' + set.score[opponent]);
      }, 300);
    } else {
      setTimeout(function() {
        var msg = '‚úÖ SET ' + gameData.currentSet + ' COMPLETE!\n\n';
        msg += gameData.matchInfo['team' + team + 'Name'] + ' wins ' + set.score[team] + '-' + set.score[opponent] + '\n\n';
        
        // Check if next set is deciding set (Set 3 in best-of-3 or Set 5 in best-of-5)
        var maxSets = parseInt(gameData.matchInfo.format);
        var nextSetNum = gameData.currentSet + 1;
        var isDecidingSet = (maxSets === 3 && nextSetNum === 3) || (maxSets === 5 && nextSetNum === 5);
        
        if (isDecidingSet) {
          msg += 'üéØ DECIDING SET ' + nextSetNum + '!\n\n';
          msg += 'A new coin toss will be conducted.\n\n';
        } else {
          msg += 'üèê ' + gameData.matchInfo['team' + opponent + 'Name'] + ' will serve first in next set.\n\n';
        }
        msg += '3-minute interval started. Setup lineup now!';
        
        alert(msg);
        
        console.log('=== STARTING INTERVAL TIMER FOR SET', nextSetNum, '===');
        // Start 3-minute interval timer immediately
        startIntervalTimer(180, function() {
          // After 3 minutes, if lineup not ready, just proceed
          console.log('3-minute interval complete for Set', nextSetNum);
        });
        
        // Open lineup setup immediately
        if (isDecidingSet) {
          showDecidingSetToss();
        } else {
          startNextSet();
        }
      }, 300);
    }
  }
  
  updateMatchDisplay();
}

function saveActionToHistory(action) {
  gameData.actionHistory.push(action);
  if (gameData.actionHistory.length > 50) {
    gameData.actionHistory.shift();
  }
}

function manualRotate(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  
  if (!confirm('üîÑ MANUAL ROTATION\n\nRotate ' + gameData.matchInfo['team' + team + 'Name'] + ' lineup?\n\nThis will rotate all positions clockwise:\nP1‚ÜíP6, P2‚ÜíP1, P3‚ÜíP2, P4‚ÜíP3, P5‚ÜíP4, P6‚ÜíP5\n\nNote: This should only be used for corrections, not during normal play.')) {
    return;
  }
  
  rotateTeam(team);
  updateMatchDisplay();
  
  addSummaryEvent('Manual Rotation', team, 'Manual rotation performed');
  
  alert('‚úì Rotation complete!\n\n' + gameData.matchInfo['team' + team + 'Name'] + ' lineup has been rotated.');
}

function rotateTeam(team) {
  var lineup = gameData.teams[team].lineup;
  var first = lineup.shift();
  lineup.push(first);
  
  autoReplaceLiberoInFrontRow(team);
}

function autoReplaceLiberoInFrontRow(team) {
  var frontRowIndices = [1, 2, 3];
  
  if (!gameData.liberoReplacements[team]) return;
  
  var replacements = [];
  
  frontRowIndices.forEach(function(posIndex) {
    var jersey = gameData.teams[team].lineup[posIndex];
    
    var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      var replacement = gameData.liberoReplacements[team].find(function(r) {
        return r.libero === jersey;
      });
      
      if (replacement) {
        var originalPlayerObj = gameData.teams[team].players.find(function(p) { 
          return p.jersey === replacement.originalPlayer; 
        });
        
        replacements.push({
          libero: player,
          original: originalPlayerObj,
          position: posIndex + 1,
          posIndex: posIndex,
          team: team,
          replacementData: replacement
        });
      }
    }
  });
  
  // Show beautiful modal if replacements need to be made
  if (replacements.length > 0) {
    showAutoLiberoExitModal(replacements[0]);
  }
}

// Global variable to store current exit data
var currentLiberoExitData = null;
var currentLiberoEntryData = null;

// Check if libero should enter after rotation
function checkAutoLiberoEntry(team) {
  // This function is ONLY called at match start (0-0)
  // For libero entry during match, use checkAutoLiberoEntryAfterLosingService
  
  // Check if team has liberos
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  if (liberos.length === 0) return;

  // Filter out expelled/disqualified liberos ‚Äî they cannot enter court (FIVB Art.19.3)
  liberos = liberos.filter(function(lib) {
    return !SM.isPlayerLocked(team, String(lib.jersey));
  });
  if (liberos.length === 0) return;
  
  // Check if any libero already on court
  var liberoOnCourt = false;
  liberos.forEach(function(lib) {
    if (gameData.teams[team].lineup.includes(lib.jersey)) {
      liberoOnCourt = true;
    }
  });
  
  if (liberoOnCourt) return; // Libero already on court
  
  var set = gameData.sets[gameData.currentSet - 1];
  
  // ONLY at first serve (0-0) - BEFORE first serve
  var isFirstServe = set.score.A === 0 && set.score.B === 0;
  
  if (!isFirstServe) {
    // Not first serve - this function should not be called
    return;
  }
  
  // Determine position based on serving status
  var isServing = set.serving === team;
  var targetPosIndex;
  var targetPosition;
  
  if (isServing) {
    // SERVING team at match start - replace P6 (middle blocker)
    targetPosIndex = 5; // P6
    targetPosition = 6;
  } else {
    // RECEIVING team at match start - replace P1 (back right receiver)
    targetPosIndex = 0; // P1
    targetPosition = 1;
  }
  
  // Get the player at target position
  var jersey = gameData.teams[team].lineup[targetPosIndex];
  var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
  
  if (!player || player.role === 'libero1' || player.role === 'libero2') {
    return; // Position already has libero or invalid
  }
  
  var targetData = {
    player: player,
    position: targetPosition,
    posIndex: targetPosIndex,
    jersey: jersey
  };
  
  // Show entry modal with libero selection
  showAutoLiberoEntryModal(team, targetData, liberos);
}

// NEW: Check for libero entry AFTER team loses service (now they can replace P1)
function checkAutoLiberoEntryAfterLosingService(team) {
  // Check if team has liberos
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  if (liberos.length === 0) return;

  // Filter out expelled/disqualified liberos ‚Äî they cannot enter court (FIVB Art.19.3)
  liberos = liberos.filter(function(lib) {
    return !SM.isPlayerLocked(team, String(lib.jersey));
  });
  if (liberos.length === 0) return;
  
  // Check if any libero already on court
  var liberoOnCourt = false;
  liberos.forEach(function(lib) {
    if (gameData.teams[team].lineup.includes(lib.jersey)) {
      liberoOnCourt = true;
    }
  });
  
  if (liberoOnCourt) return; // Libero already on court
  
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Only check if NOT first serve
  var isFirstServe = set.score.A === 0 && set.score.B === 0;
  if (isFirstServe) return;
  
  // Target P1 (server position that they just lost)
  var targetPosIndex = 0; // P1
  var targetPosition = 1;
  
  // Get the player at P1
  var jersey = gameData.teams[team].lineup[targetPosIndex];
  var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
  
  if (!player || player.role === 'libero1' || player.role === 'libero2') {
    return; // Position already has libero or invalid
  }
  
  var targetData = {
    player: player,
    position: targetPosition,
    posIndex: targetPosIndex,
    jersey: jersey
  };
  
  // Show entry modal with libero selection
  showAutoLiberoEntryModal(team, targetData, liberos);
}

function showAutoLiberoEntryModal(team, targetData, liberos) {
  currentLiberoEntryData = {
    team: team,
    playerOut: targetData.player,
    liberos: liberos, // Array of available liberos
    selectedLibero: liberos[0], // Default to first
    position: targetData.position,
    posIndex: targetData.posIndex,
    jerseyOut: targetData.jersey
  };
  
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var set = gameData.sets[gameData.currentSet - 1];
  var isServing = set.serving === team;
  var isFirstServe = set.score.A === 0 && set.score.B === 0;
  
  // Add context message for first serve
  var contextMessage = teamName;
  if (isFirstServe) {
    contextMessage = teamName + ' - ' + (isServing ? 'SERVING TEAM' : 'RECEIVING TEAM');
  }
  
  // Populate modal
  document.getElementById('autoEntryMessage').textContent = contextMessage;
  document.getElementById('autoEntryOutJersey').textContent = targetData.player.jersey;
  document.getElementById('autoEntryOutName').textContent = targetData.player.name;
  
  // If 2 liberos, show selection - otherwise show single libero
  if (liberos.length === 2) {
    // Show both liberos with selection
    var badge1 = 'L1';
    var badge2 = 'L2';
    document.getElementById('autoEntryInJersey').textContent = liberos[0].jersey + ' / ' + liberos[1].jersey;
    document.getElementById('autoEntryInName').innerHTML = 
      '<div style="margin-bottom:8px">' +
      '<input type="radio" name="liberoChoice" value="0" id="liberoChoice0" checked style="margin-right:5px">' +
      '<label for="liberoChoice0" style="cursor:pointer">' +
      '<strong>#' + liberos[0].jersey + '</strong> ' + liberos[0].name + 
      ' <span class="libero-badge-big" style="font-size:11px;margin-left:5px;padding:2px 6px;background:#9c27b0;color:#fff;border-radius:3px">' + badge1 + '</span>' +
      '</label></div>' +
      '<div>' +
      '<input type="radio" name="liberoChoice" value="1" id="liberoChoice1" style="margin-right:5px">' +
      '<label for="liberoChoice1" style="cursor:pointer">' +
      '<strong>#' + liberos[1].jersey + '</strong> ' + liberos[1].name + 
      ' <span class="libero-badge-big" style="font-size:11px;margin-left:5px;padding:2px 6px;background:#9c27b0;color:#fff;border-radius:3px">' + badge2 + '</span>' +
      '</label></div>';
  } else {
    // Single libero
    var badge = liberos[0].role === 'libero1' ? 'L1' : 'L2';
    document.getElementById('autoEntryInJersey').textContent = liberos[0].jersey;
    document.getElementById('autoEntryInName').innerHTML = liberos[0].name + 
      ' <span class="libero-badge-big" style="font-size:11px;margin-left:5px;padding:2px 6px;background:#9c27b0;color:#fff;border-radius:3px">' + badge + '</span>';
  }
  
  document.getElementById('autoEntryPosition').textContent = 'P' + targetData.position;
  
  // Show modal
  document.getElementById('autoLiberoEntryModal').classList.add('active');
}

function confirmAutoLiberoEntry() {
  if (!currentLiberoEntryData) return;
  
  var data = currentLiberoEntryData;
  
  // Get selected libero if there are 2
  var selectedLibero = data.selectedLibero;
  if (data.liberos.length === 2) {
    var choice0 = document.getElementById('liberoChoice0');
    var choice1 = document.getElementById('liberoChoice1');
    if (choice0 && choice0.checked) {
      selectedLibero = data.liberos[0];
    } else if (choice1 && choice1.checked) {
      selectedLibero = data.liberos[1];
    }
  }
  
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Check if another libero on court
  var allLiberos = gameData.teams[data.team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  var otherLiberoOnCourt = false;
  allLiberos.forEach(function(lib) {
    if (lib.jersey !== selectedLibero.jersey && gameData.teams[data.team].lineup.includes(lib.jersey)) {
      otherLiberoOnCourt = true;
    }
  });
  
  if (otherLiberoOnCourt) {
    alert('‚õî Only one libero allowed on court!');
    document.getElementById('autoLiberoEntryModal').classList.remove('active');
    return;
  }
  
  // Initialize array if needed
  if (!gameData.liberoReplacements[data.team]) {
    gameData.liberoReplacements[data.team] = [];
  }
  
  // Save to history for undo
  saveActionToHistory({
    type: 'libero',
    team: data.team,
    libero: selectedLibero.jersey,
    originalPlayer: data.jerseyOut,
    position: data.position,
    setNumber: gameData.currentSet
  });
  
  // Track replacement
  gameData.liberoReplacements[data.team].push({
    libero: selectedLibero.jersey,
    originalPlayer: data.jerseyOut,
    position: data.position,
    setNumber: gameData.currentSet
  });
  
  // Replace in lineup
  gameData.teams[data.team].lineup[data.posIndex] = selectedLibero.jersey;
  
  // Add to summary
  var teamName = gameData.matchInfo['team' + data.team + 'Name'];
  var scoreText = set.score[data.team] + ':' + set.score[data.team === 'A' ? 'B' : 'A'];
  var badge = selectedLibero.role === 'libero1' ? 'L1' : 'L2';
  addSummaryEvent('Libero', data.team, teamName + ' Libero #' + selectedLibero.jersey + ' ' + selectedLibero.name + ' (' + badge + ') replaces #' + data.jerseyOut + ' ' + data.playerOut.name + ' in P' + data.position + ' at ' + scoreText);
  
  // Update display
  updateMatchDisplay();
  
  // Close modal
  document.getElementById('autoLiberoEntryModal').classList.remove('active');
  currentLiberoEntryData = null;
  
  // Call callback if exists (for sequential modals)
  if (gameData.liberoEntryCallback) {
    var cb = gameData.liberoEntryCallback;
    gameData.liberoEntryCallback = null;
    setTimeout(cb, 200);
  }
}

function skipAutoLiberoEntry() {
  document.getElementById('autoLiberoEntryModal').classList.remove('active');
  currentLiberoEntryData = null;
  
  // Call callback if exists (for sequential modals)
  if (gameData.liberoEntryCallback) {
    var cb = gameData.liberoEntryCallback;
    gameData.liberoEntryCallback = null;
    setTimeout(cb, 200);
  }
}

// Global variable to store current exit data
var currentLiberoExitData = null;

function showAutoLiberoExitModal(data) {
  currentLiberoExitData = data;
  var teamName = gameData.matchInfo['team' + data.team + 'Name'];
  
  // Populate modal
  document.getElementById('autoExitMessage').textContent = teamName;
  document.getElementById('autoExitInJersey').textContent = data.original.jersey;
  document.getElementById('autoExitInName').textContent = data.original.name;
  document.getElementById('autoExitOutJersey').textContent = data.libero.jersey;
  document.getElementById('autoExitOutName').textContent = data.libero.name;
  document.getElementById('autoExitPosition').textContent = 'P' + data.position;
  
  // Show modal
  document.getElementById('autoLiberoExitModal').classList.add('active');
}

function confirmAutoLiberoExit() {
  if (!currentLiberoExitData) return;
  
  var data = currentLiberoExitData;
  
  // Execute the replacement
  gameData.teams[data.team].lineup[data.posIndex] = data.replacementData.originalPlayer;
  
  // Remove from tracking
  gameData.liberoReplacements[data.team] = gameData.liberoReplacements[data.team].filter(function(r) {
    return r.libero !== data.libero.jersey;
  });
  
  // Update display
  updateMatchDisplay();
  
  // Close modal
  document.getElementById('autoLiberoExitModal').classList.remove('active');
  currentLiberoExitData = null;
}

var decidingSetTossData = {winner: null, choice: null};

function showDecidingSetToss() {
  decidingSetTossData = {winner: null, choice: null};
  
  document.getElementById('decidingTossAName').textContent = gameData.matchInfo.teamAName;
  document.getElementById('decidingTossBName').textContent = gameData.matchInfo.teamBName;
  
  // Reset UI
  document.getElementById('decidingTossA').style.border = '3px solid #533483';
  document.getElementById('decidingTossB').style.border = '3px solid #533483';
  document.getElementById('decidingTossChoice').style.display = 'none';
  
  document.getElementById('decidingSetTossModal').classList.add('active');
}

function decidingSetTossWinner(team) {
  decidingSetTossData.winner = team;
  
  // Highlight winner
  document.getElementById('decidingTossA').style.border = team === 'A' ? '3px solid #ff6b6b' : '3px solid #533483';
  document.getElementById('decidingTossB').style.border = team === 'B' ? '3px solid #4ecdc4' : '3px solid #533483';
  
  // Show choice
  document.getElementById('decidingTossWinnerName').textContent = gameData.matchInfo['team' + team + 'Name'];
  document.getElementById('decidingTossChoice').style.display = 'block';
}

function decidingSetTossChoice(choice) {
  decidingSetTossData.choice = choice;
  
  var winner = decidingSetTossData.winner;
  var loser = winner === 'A' ? 'B' : 'A';
  
  var firstServer;
  if (choice === 'serve') {
    firstServer = winner;
  } else {
    firstServer = loser;
  }
  
  // Save toss result
  gameData.decidingSetToss = {
    winner: winner,
    choice: choice,
    firstServer: firstServer,
    setNumber: gameData.currentSet + 1
  };
  
  closeDecidingSetTossModal();
  
  alert('üéØ DECIDING SET COIN TOSS RESULT\n\n' +
    'Toss Winner: ' + gameData.matchInfo['team' + winner + 'Name'] + '\n' +
    'Choice: ' + (choice === 'serve' ? 'SERVE FIRST' : 'RECEIVE FIRST') + '\n\n' +
    'First Server: ' + gameData.matchInfo['team' + firstServer + 'Name']);
  
  startNextSet();
}

function closeDecidingSetTossModal() {
  document.getElementById('decidingSetTossModal').classList.remove('active');
}

function startNextSet() {
  // Prevent double execution
  if (gameData.startingNextSet) {
    console.log('startNextSet already in progress, ignoring duplicate call');
    return;
  }
  gameData.startingNextSet = true;
  
  console.log('=== START NEXT SET CALLED ===');
  console.log('BEFORE Changes:');
  console.log('  currentSet:', gameData.currentSet);
  console.log('  sets.length:', gameData.sets.length);
  console.log('  swapped:', gameData.swapped);
  console.log('  sets array:', JSON.stringify(gameData.sets.map(function(s, i) {
    return {set: i+1, score: s.score, winner: s.winner};
  })));
  
  // Don't increment currentSet yet - it will be incremented when the set is actually created
  gameData.setStartTime = null;  // Will be set on first rally after interval
  
  // NO AUTOMATIC SWAPPING - user will manually swap using SWAP button if needed
  // gameData.swapped = !gameData.swapped; // REMOVED
  
  // Get the team that served first in the previous set (which is the current set that just finished)
  var prevSet = gameData.sets[gameData.currentSet - 1];
  console.log('Reading previous set from index:', gameData.currentSet - 1);
  console.log('Previous set object:', prevSet);
  console.log('Previous set score:', prevSet ? prevSet.score : 'undefined');
  console.log('Previous set winner:', prevSet ? prevSet.winner : 'undefined');
  console.log('Previous set serving (who served FIRST):', prevSet ? prevSet.serving : 'undefined');
  console.log('Team A name:', gameData.matchInfo.teamAName);
  console.log('Team B name:', gameData.matchInfo.teamBName);
  
  if (!prevSet) {
    console.error('ERROR: prevSet is undefined!');
    alert('Error: Cannot find previous set data. currentSet=' + gameData.currentSet + ', sets.length=' + gameData.sets.length);
    gameData.startingNextSet = false;
    return;
  }
  
  var newFirstServer;
  
  // Check if this is a deciding set and we have toss data
  if (gameData.decidingSetToss && gameData.decidingSetToss.setNumber === (gameData.currentSet + 1)) {
    newFirstServer = gameData.decidingSetToss.firstServer;
    console.log('Using deciding set toss result - First server:', newFirstServer);
  } else {
    // Normal rule: team that did NOT serve first in previous set serves first
    var prevFirstServer = prevSet.firstServer || prevSet.serving;  // Use firstServer if available
    console.log('Previous set first server:', prevFirstServer, '=', gameData.matchInfo['team' + prevFirstServer + 'Name']);
    newFirstServer = prevFirstServer === 'A' ? 'B' : 'A';
    console.log('New first server for next set:', newFirstServer, '=', gameData.matchInfo['team' + newFirstServer + 'Name']);
  }
  
  console.log('Calling showNewSetLineupSetup with serving team:', newFirstServer);
  showNewSetLineupSetup(newFirstServer);
  
  // Reset flag after modal is shown
  setTimeout(function() {
    gameData.startingNextSet = false;
  }, 500);
}

function manuallyOpenNextSetLineup() {
  // Check if current set is finished
  var currentSet = gameData.sets[gameData.currentSet - 1];
  if (!currentSet || !currentSet.winner) {
    alert('‚ö†Ô∏è Current set must be completed before setting up the next set.');
    return;
  }
  
  // Check if match is already over
  var maxSets = parseInt(gameData.matchInfo.format);
  var setsNeeded = maxSets === 5 ? 3 : 2;
  var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  if (setsWonA >= setsNeeded || setsWonB >= setsNeeded) {
    alert('‚ö†Ô∏è Match is already over. Cannot setup next set.');
    return;
  }
  
  // Call startNextSet to open the lineup modal
  startNextSet();
}

function showNewSetLineupSetup(servingTeam) {
  gameData.selectedPlayer = null;
  
  gameData.teams.A.lineup = [];
  gameData.teams.B.lineup = [];
  
  // CRITICAL: Clear libero replacements for new set - all players available again
  gameData.liberoReplacements = {A: [], B: []};
  
  document.getElementById('teamANameSetup').textContent = gameData.matchInfo.teamAName;
  document.getElementById('teamBNameSetup').textContent = gameData.matchInfo.teamBName;
  
  renderRosterSetup('A');
  renderRosterSetup('B');
  
  updateCourtSetup('A');
  updateCourtSetup('B');
  
  document.getElementById('lineupModal').classList.add('active');
  
  var nextSetNum = gameData.currentSet + 1;
  document.getElementById('lineupModalTitle').textContent = 'Select Starting Lineups for Set ' + nextSetNum;
  document.getElementById('startMatchBtn').textContent = 'Start Set ' + nextSetNum;
  
  // Store servingTeam explicitly to avoid closure issues
  var storedServingTeam = servingTeam;
  console.log('Setup complete - stored serving team:', storedServingTeam);
  
  document.getElementById('startMatchBtn').onclick = function() {
    console.log('=== NEW SET VALIDATION ===');
    console.log('Stored serving team:', storedServingTeam);
    console.log('Team A lineup:', gameData.teams.A.lineup);
    console.log('Team B lineup:', gameData.teams.B.lineup);
    
    var aFilled = gameData.teams.A.lineup.filter(function(x) { 
      return x !== null && x !== undefined && x !== '' && x !== 0; 
    }).length;
    var bFilled = gameData.teams.B.lineup.filter(function(x) { 
      return x !== null && x !== undefined && x !== '' && x !== 0; 
    }).length;
    
    console.log('Team A filled positions:', aFilled);
    console.log('Team B filled positions:', bFilled);
    
    if (aFilled !== 6) {
      alert('Team A needs exactly 6 players on court.\n\nCurrently has: ' + aFilled + ' players\n\nPlease assign all 6 positions.');
      return;
    }
    
    if (bFilled !== 6) {
      alert('Team B needs exactly 6 players on court.\n\nCurrently has: ' + bFilled + ' players\n\nPlease assign all 6 positions.');
      return;
    }
    
    console.log('=== BEFORE PUSH ===');
    console.log('currentSet before push:', gameData.currentSet);
    console.log('sets.length before push:', gameData.sets.length);
    console.log('storedServingTeam parameter:', storedServingTeam);
    
    gameData.sets.push({
      score: {A: 0, B: 0},
      timeouts: {A: [], B: []},
      substitutions: {A: [], B: []},
      substitutionTracking: {A: {}, B: {}},
      completedSubstitutions: {A: [], B: []},
      serving: storedServingTeam,
      firstServer: storedServingTeam,  // NEW: Track who serves FIRST (never changes)
      winner: null,
      startTime: null,  // Will be set when first rally starts
      lineupA: gameData.teams.A.lineup.slice(),
      lineupB: gameData.teams.B.lineup.slice()
    });
    
    console.log('=== AFTER PUSH ===');
    console.log('sets.length after push:', gameData.sets.length);
    console.log('New set serving:', gameData.sets[gameData.sets.length - 1].serving);
    
    // Now increment currentSet since the new set has been created
    console.log('currentSet before increment:', gameData.currentSet);
    gameData.currentSet++;
    console.log('=== NEW SET CREATED ===');
    console.log('New currentSet:', gameData.currentSet);
    console.log('Total sets:', gameData.sets.length);
    
    // Reset expulsion status for new set (FIVB: expelled players eligible again next set)
    if (typeof SM !== 'undefined') SM.onNewSet();
    
    document.getElementById('lineupModal').classList.remove('active');
    
    // PATCH: Capture libero serving slots for this new set
    if (typeof LiberoServe !== 'undefined' && LiberoServe.captureDesignatedSlots) {
      LiberoServe.captureDesignatedSlots();
    }
    
    updateMatchDisplay();
    
    // Check for libero entry at start of NEW set - BOTH teams BEFORE first serve
    // Show SEQUENTIALLY - second modal only after first closes
    var newSet = gameData.sets[gameData.currentSet - 1];
    
    if (!newSet) {
      console.error('ERROR: New set not found!');
      return;
    }
    
    var servingTeam = newSet.serving;
    var receivingTeam = servingTeam === 'A' ? 'B' : 'A';
    
    console.log('=== LIBERO CHECK FOR NEW SET ===');
    console.log('Serving team:', servingTeam, '=', gameData.matchInfo['team' + servingTeam + 'Name']);
    console.log('Receiving team:', receivingTeam, '=', gameData.matchInfo['team' + receivingTeam + 'Name']);
    console.log('Teams data exists:', !!gameData.teams);
    console.log('Team A data exists:', !!(gameData.teams && gameData.teams.A));
    console.log('Team B data exists:', !!(gameData.teams && gameData.teams.B));
    console.log('Team A is:', gameData.matchInfo.teamAName);
    console.log('Team B is:', gameData.matchInfo.teamBName);
    
    // Make sure teams are set up properly before checking libero
    if (!gameData.teams || !gameData.teams.A || !gameData.teams.B) {
      console.error('ERROR: Team data not available for libero check');
      return;
    }
    
    setTimeout(function() {
      console.log('Checking libero for receiving team:', receivingTeam);
      checkAutoLiberoEntryWithCallback(receivingTeam, function() {
        setTimeout(function() {
          console.log('Checking libero for serving team:', servingTeam);
          checkAutoLiberoEntryWithCallback(servingTeam, function() {
            console.log('Both libero checks complete');
          });
        }, 500);
      });
    }, 800);
  };
}

function updatePointButtons() {
  var active = gameData.rallyInProgress;
  ['pointBtnA','pointBtnB'].forEach(function(id) {
    var btn = document.getElementById(id);
    if (!btn) return;
    if (active) {
      btn.classList.remove('rally-inactive');
    } else {
      btn.classList.add('rally-inactive');
    }
  });
}

function toggleRally() {
  // Block rally if the current set is already won or match has ended
  var currentSet = gameData.sets[gameData.currentSet - 1];
  if (currentSet && currentSet.winner) {
    alert('‚õî Set ' + gameData.currentSet + ' is already finished.\nPlease set up the next set lineup.');
    return;
  }
  if (gameData.matchEnded) {
    alert('‚õî The match has ended.');
    return;
  }

  gameData.rallyInProgress = !gameData.rallyInProgress;
  
  var button = document.getElementById('rallyButton');
  var status = document.getElementById('rallyStatus');
  
  if (gameData.rallyInProgress) {
    // PATCH: Libero Serve Rule check
    if (!LiberoServe.validateServeStart()) {
      gameData.rallyInProgress = false;
      updatePointButtons();
      return;
    }
    // Start set timer on FIRST rally of the set
    if (!gameData.setStartTime) {
      gameData.setStartTime = Date.now();
      // Also store in the set object for duration calculation
      var currentSet = gameData.sets[gameData.currentSet - 1];
      if (currentSet) {
        currentSet.startTime = Date.now();
      }
      console.log('Set timer started at first rally');
    }
    
    button.textContent = '‚ö° ACTIVE';
    button.style.background = '#00ff00';
    button.style.animation = 'pulse 1s infinite';
    status.textContent = 'IN PROGRESS';
    status.style.color = '#00ff00';
    updatePointButtons();
  } else {
    button.textContent = 'üèê START RALLY';
    button.style.background = '#ffd700';
    button.style.animation = 'none';
    status.textContent = 'STOPPED';
    status.style.color = '#888';
    updatePointButtons();
  }
}

function addPoint(side) {
  if (!gameData.rallyInProgress) return; // Only allow scoring during active rally
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  addPointToTeam(team);
  
  // Auto-stop rally when point is scored
  if (gameData.rallyInProgress) {
    gameData.rallyInProgress = false;
    var button = document.getElementById('rallyButton');
    var status = document.getElementById('rallyStatus');
    button.textContent = 'üèê START RALLY';
    button.style.background = '#ffd700';
    button.style.animation = 'none';
    status.textContent = 'Rally: Stopped';
    status.style.color = '#888';
    updatePointButtons();
  }
}

function swapSides() {
  gameData.swapped = !gameData.swapped;
  updateMatchDisplay();
}

function undoPoint() {
  if (gameData.actionHistory.length === 0) {
    alert('No actions to undo');
    return;
  }
  
  // Check if we're currently in Set 2 or higher with 0 points scored
  var currentSet = gameData.sets[gameData.currentSet - 1];
  if (currentSet && gameData.currentSet > 1 && currentSet.score.A === 0 && currentSet.score.B === 0) {
    // We're at the START of Set 2+ with no points yet
    console.log('UNDO: At start of Set ' + gameData.currentSet + ' (0-0), reverting to Set ' + (gameData.currentSet - 1));
    
    // Remove the current set
    gameData.sets.pop();
    
    // Decrement set number
    gameData.currentSet--;
    
    // Get previous set
    var prevSet = gameData.sets[gameData.currentSet - 1];
    
    // Re-open previous set (remove winner)
    if (prevSet) {
      delete prevSet.winner;
      delete prevSet.endTime;
      
      // Restore lineups from previous set
      if (prevSet.lineupA && prevSet.lineupB) {
        gameData.teams.A.lineup = prevSet.lineupA.slice();
        gameData.teams.B.lineup = prevSet.lineupB.slice();
      }
      
      // Restore libero replacements (empty for new set)
      gameData.liberoReplacements = {A: [], B: []};
      
      // Update display
      updateMatchDisplay();
      
      alert('‚úì Undone: Canceled Set ' + (gameData.currentSet + 1) + '\nReturned to Set ' + gameData.currentSet + 
            '\nScore: ' + prevSet.score.A + '-' + prevSet.score.B);
    }
    
    return;
  }
  
  var lastAction = gameData.actionHistory.pop();
  var set = gameData.sets[gameData.currentSet - 1];
  
  if (lastAction.type === 'point') {
    set.score.A = lastAction.previousScore.A;
    set.score.B = lastAction.previousScore.B;
    
    set.serving = lastAction.previousServing;
    
    gameData.teams.A.lineup = lastAction.previousLineupA;
    gameData.teams.B.lineup = lastAction.previousLineupB;
    
    if (lastAction.previousLiberoReplacementsA) {
      gameData.liberoReplacements.A = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacementsA));
    }
    if (lastAction.previousLiberoReplacementsB) {
      gameData.liberoReplacements.B = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacementsB));
    }

    // Remove the summary events that were added by this point (Pt, SET WIN, SANCTION etc.)
    if (lastAction.previousSummaryLength !== undefined && gameData.matchSummary) {
      gameData.matchSummary.splice(lastAction.previousSummaryLength);
    }

    // Restore full sanction state if this point came from a sanction
    if (lastAction.sanctionSnapshot) {
      var snap = lastAction.sanctionSnapshot;
      gameData.sanctionSystem.misconduct    = snap.misconduct;
      gameData.sanctionSystem.delay         = snap.delay;
      gameData.sanctionSystem.expelled      = snap.expelled;
      gameData.sanctionSystem.disqualified  = snap.disqualified;
      gameData.sanctionSystem.coachExpelled = snap.coachExpelled;
      gameData.sanctionSystem.coachDisqualified = snap.coachDisqualified;
      gameData.sanctionsA = snap.sanctionsA;
      gameData.sanctionsB = snap.sanctionsB;
      smUpdateLiveSanctionLog();
    }
    
    if (set.winner) {
      set.winner = null;
      delete set.endTime;
    }
    
    var teamName = gameData.matchInfo['team' + lastAction.team + 'Name'];
    alert('‚úì Undone: Point for ' + teamName + '\nScore restored to ' + 
          lastAction.previousScore.A + '-' + lastAction.previousScore.B);
    
    updateMatchDisplay();
  } else if (lastAction.type === 'timeout') {
    set.timeouts[lastAction.team].pop();
    updateMatchDisplay();
    updateTimeoutHistory();
    alert('‚úì Undone: Timeout for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'substitution') {
    set.substitutions[lastAction.team].pop();
    var posIndex = gameData.teams[lastAction.team].lineup.indexOf(lastAction.playerIn);
    if (posIndex !== -1) {
      gameData.teams[lastAction.team].lineup[posIndex] = lastAction.playerOut;
    }
    updateMatchDisplay();
    alert('‚úì Undone: Substitution for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'libero') {
    gameData.liberoReplacements[lastAction.team] = gameData.liberoReplacements[lastAction.team].filter(function(r) {
      return !(r.libero === lastAction.libero && r.originalPlayer === lastAction.originalPlayer);
    });
    var posIndex = gameData.teams[lastAction.team].lineup.indexOf(lastAction.libero);
    if (posIndex !== -1) {
      gameData.teams[lastAction.team].lineup[posIndex] = lastAction.originalPlayer;
    }
    updateMatchDisplay();
    alert('‚úì Undone: Libero replacement for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'manual_rotate') {
    gameData.teams[lastAction.team].lineup = lastAction.previousLineup;
    gameData.liberoReplacements[lastAction.team] = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacements));
    updateMatchDisplay();
    alert('‚úì Undone: Manual rotation for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  }
}

function takeTimeout(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  var set = gameData.sets[gameData.currentSet - 1];
  
  if (set.timeouts[team].length >= 2) {
    alert('Maximum 2 timeouts per set');
    return;
  }
  
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var tA = gameData.swapped ? 'B' : 'A';
  var tB = gameData.swapped ? 'A' : 'B';
  
  set.timeouts[team].push({
    time: Date.now(),
    score: {A: set.score.A, B: set.score.B}
  });
  
  // Add to match summary with team name and score (Team's score : Opponent's score)
  var otherTeam = team === 'A' ? 'B' : 'A';
  var scoreText = set.score[team] + ':' + set.score[otherTeam];
  addSummaryEvent('TO', team, teamName + ' Timeout #' + set.timeouts[team].length + ' at ' + scoreText);
  
  document.getElementById('timeoutTeamName').textContent = teamName + ' - TIMEOUT';
  
  // Update the new score display
  document.getElementById('timeoutTeamAName').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('timeoutTeamBName').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('timeoutTeamAScore').textContent = set.score[tA];
  document.getElementById('timeoutTeamBScore').textContent = set.score[tB];
  
  gameData.timeoutRemaining = 30;
  gameData.currentTimeoutTeam = team;
  document.getElementById('timeoutTimer').textContent = '30';
  document.getElementById('timeoutModal').classList.add('active');
  
  gameData.timeoutTimer = setInterval(function() {
    gameData.timeoutRemaining--;
    document.getElementById('timeoutTimer').textContent = gameData.timeoutRemaining;
    
    if (gameData.timeoutRemaining <= 0) {
      endTimeout();
    }
  }, 1000);
  
  updateMatchDisplay();
}

function endTimeout() {
  if (gameData.timeoutTimer) {
    clearInterval(gameData.timeoutTimer);
    gameData.timeoutTimer = null;
  }
  document.getElementById('timeoutModal').classList.remove('active');
  gameData.currentTimeoutTeam = null;
}

function openSubModal(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Ensure team-specific tracking exists
  if (!set.substitutionTracking) {
    set.substitutionTracking = {A: {}, B: {}};
  }
  if (!set.substitutionTracking[team]) {
    set.substitutionTracking[team] = {};
  }
  
  // Clean up invalid entries for THIS team only
  if (set.substitutionTracking[team]) {
    var teamJerseys = gameData.teams[team].players.map(function(p) { return String(p.jersey); });
    
    // Remove pairings that reference non-existent players in this team
    var keysToDelete = [];
    Object.keys(set.substitutionTracking[team]).forEach(function(jersey) {
      var pairedWith = set.substitutionTracking[team][jersey].pairedWith;
      
      // If either player doesn't exist in THIS team's roster, mark for deletion
      if (!teamJerseys.includes(jersey) || !teamJerseys.includes(pairedWith)) {
        keysToDelete.push(jersey);
      }
    });
    
    keysToDelete.forEach(function(key) {
      delete set.substitutionTracking[team][key];
    });
  }
  
  // Calculate actual substitution count (each action counts as 1)
  var actualSubCount = countCompletedSubstitutions(team, gameData.currentSet - 1);
  
  gameData.subSelection = {playerOut: null, playerIn: null, team: team, side: side};
  
  document.getElementById('subTeamName').textContent = gameData.matchInfo['team' + team + 'Name'];
  
  // Update info message based on substitution count
  var _subLimMsg = getSubLimit();
  if (actualSubCount >= _subLimMsg) {
    document.getElementById('subInfo').textContent = '‚ö†Ô∏è Maximum ' + _subLimMsg + ' regular substitutions reached - Use Exceptional Substitution for injuries only';
  } else {
    document.getElementById('subInfo').textContent = 'Substitution ' + (actualSubCount + 1) + '/' + _subLimMsg + ' - Select player OUT, then player IN';
  }
  
  renderSubPlayers(team);
  document.getElementById('subModal').classList.add('active');
}

function renderSubPlayers(team) {
  var onCourt = gameData.teams[team].lineup.filter(function(j) { return j; });
  var allPlayers = gameData.teams[team].players;
  
  // Get players currently replaced by liberos
  var replacedByLibero = [];
  if (gameData.liberoReplacements && gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team].forEach(function(replacement) {
      // If libero is currently on court, the original player is replaced and on bench
      if (onCourt.includes(replacement.libero)) {
        replacedByLibero.push(replacement.originalPlayer);
      }
    });
  }
  
  // Get injured players (locked due to exceptional substitution)
  var injuredPlayers = gameData.injuredPlayers[team] || [];
  
  // Get sanction-locked players (expelled this set or disqualified)
  var sanctionLocked = [];
  if (gameData.sanctionSystem) {
    gameData.sanctionSystem.disqualified[team].forEach(function(e){ sanctionLocked.push(e.jersey); });
    gameData.sanctionSystem.expelled[team].forEach(function(e){
      if (e.set === gameData.currentSet) sanctionLocked.push(e.jersey);
    });
  }
  
  var onBench = allPlayers.filter(function(p) { 
    // Exclude: players on court, liberos, players replaced by liberos, injured, and sanction-locked
    return !onCourt.includes(p.jersey) && 
           p.role !== 'libero1' && 
           p.role !== 'libero2' &&
           !replacedByLibero.includes(p.jersey) &&
           !injuredPlayers.includes(p.jersey) && // Exclude injured players
           !sanctionLocked.some(function(j){ return String(j) === String(p.jersey); }); // Exclude sanction-locked
  });
  
  var outHTML = '';
  onCourt.forEach(function(jersey) {
    var player = allPlayers.find(function(p) { return p.jersey === jersey; });
    if (player) {
      // Check if this is a libero on court
      var isLibero = (player.role === 'libero1' || player.role === 'libero2');
      
      // Liberos on court cannot be substituted (only replaced by original player via libero replacement)
      if (!isLibero) {
        var badge = player.role === 'captain' ? ' (C)' : '';
        outHTML += '<div class="player-select-btn" onclick="selectPlayerOut(' + jersey + ')">';
        outHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
        outHTML += '</div>';
      }
    }
  });
  
  // Add info about liberos on court
  var liberosOnCourt = [];
  onCourt.forEach(function(jersey) {
    var player = allPlayers.find(function(p) { return p.jersey === jersey; });
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      liberosOnCourt.push(player);
    }
  });
  
  if (liberosOnCourt.length > 0) {
    outHTML += '<div style="background:#9c27b0;color:#fff;padding:8px;margin-top:10px;border-radius:4px;font-size:11px;">';
    outHTML += '‚ö†Ô∏è Liberos cannot be substituted. Use Libero Replacement:<br>';
    liberosOnCourt.forEach(function(lib) {
      outHTML += '‚Ä¢ L#' + lib.jersey + ' ' + lib.name + '<br>';
    });
    outHTML += '</div>';
  }
  
  document.getElementById('playersOut').innerHTML = outHTML || '<p style="color:#888">No players on court</p>';
  
  var inHTML = '';
  onBench.forEach(function(player) {
    var badge = player.role === 'captain' ? ' (C)' : '';
    inHTML += '<div class="player-select-btn" onclick="selectPlayerIn(' + player.jersey + ')">';
    inHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
    inHTML += '</div>';
  });
  
  // Add info message if players are blocked
  var blockedMessages = [];
  
  if (replacedByLibero.length > 0) {
    var liberoMsg = '‚ö†Ô∏è Players replaced by libero cannot be substituted:<br>';
    replacedByLibero.forEach(function(jersey) {
      var p = allPlayers.find(function(player) { return player.jersey === jersey; });
      if (p) {
        liberoMsg += '‚Ä¢ #' + jersey + ' ' + p.name + '<br>';
      }
    });
    blockedMessages.push(liberoMsg);
  }
  
  if (injuredPlayers.length > 0) {
    var injuredMsg = 'üöë Injured players (exceptional substitution - locked):<br>';
    injuredPlayers.forEach(function(jersey) {
      var p = allPlayers.find(function(player) { return player.jersey === jersey; });
      if (p) {
        injuredMsg += '‚Ä¢ #' + jersey + ' ' + p.name + ' - Cannot return this match<br>';
      }
    });
    blockedMessages.push(injuredMsg);
  }
  
  if (sanctionLocked.length > 0) {
    var sanctionMsg = '‚ö†Ô∏è Sanction-locked players (cannot sub in):<br>';
    sanctionLocked.forEach(function(jersey) {
      var p = allPlayers.find(function(player) { return String(player.jersey) === String(jersey); });
      var isDisq = gameData.sanctionSystem && gameData.sanctionSystem.disqualified[team].some(function(e){ return String(e.jersey) === String(jersey); });
      if (p) {
        sanctionMsg += '‚Ä¢ #' + jersey + ' ' + p.name + ' ‚Äî ' + (isDisq ? 'üü•‚ùå DISQUALIFIED (match)' : 'üü®üü• EXPELLED (this set)') + '<br>';
      }
    });
    blockedMessages.push(sanctionMsg);
  }
  
  if (blockedMessages.length > 0) {
    inHTML += '<div style="background:#ff3b3b;color:#fff;padding:8px;margin-top:10px;border-radius:4px;font-size:11px;">';
    inHTML += blockedMessages.join('<br>');
    inHTML += '</div>';
  }
  
  document.getElementById('playersIn').innerHTML = inHTML || '<p style="color:#888">No players on bench</p>';
  
  // Update button states based on substitution count
  updateSubInfo();
}

function selectPlayerOut(jersey) {
  gameData.subSelection.playerOut = jersey;
  
  var buttons = document.querySelectorAll('#playersOut .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    // Extract jersey number from button text and compare exactly
    var match = btn.textContent.match(/#(\d+)/);
    if (match && parseInt(match[1]) === jersey) {
      btn.classList.add('selected');
    }
  });
  
  updateSubInfo();
}

function selectPlayerIn(jersey) {
  gameData.subSelection.playerIn = jersey;
  
  var buttons = document.querySelectorAll('#playersIn .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    // Extract jersey number from button text and compare exactly
    var match = btn.textContent.match(/#(\d+)/);
    if (match && parseInt(match[1]) === jersey) {
      btn.classList.add('selected');
    }
  });
  
  updateSubInfo();
}

function updateSubInfo() {
  var sel = gameData.subSelection;
  var team = sel.team;
  var allPlayers = gameData.teams[team].players;
  
  var outPlayer = sel.playerOut ? allPlayers.find(function(p) { return p.jersey === sel.playerOut; }) : null;
  var inPlayer = sel.playerIn ? allPlayers.find(function(p) { return p.jersey === sel.playerIn; }) : null;
  
  var msg = '';
  if (outPlayer && inPlayer) {
    msg = 'OUT: #' + outPlayer.jersey + ' ' + outPlayer.name + ' ‚Üí IN: #' + inPlayer.jersey + ' ' + inPlayer.name;
  } else if (outPlayer) {
    msg = 'Selected OUT: #' + outPlayer.jersey + ' ' + outPlayer.name + ' - Now select player IN';
  } else {
    msg = 'Select player OUT, then player IN';
  }
  
  document.getElementById('subInfo').textContent = msg;
  
  // Check if 6 subs reached and disable regular sub button
  var set = gameData.sets[gameData.currentSet - 1];
  var actualSubCount = countCompletedSubstitutions(team, gameData.currentSet - 1);
  var confirmBtn = document.getElementById('confirmSubBtn');
  
  if (actualSubCount >= getSubLimit()) {
    confirmBtn.style.opacity = '0.3';
    confirmBtn.style.cursor = 'not-allowed';
    confirmBtn.disabled = true;
  } else {
    confirmBtn.style.opacity = '1';
    confirmBtn.style.cursor = 'pointer';
    confirmBtn.disabled = false;
  }
}

function confirmSubstitution() {
  var sel = gameData.subSelection;
  
  if (!sel.playerOut || !sel.playerIn) {
    alert('Please select both OUT and IN players');
    return;
  }
  
  var team = sel.team;
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Check if substitution limit has been reached
  var _subLimChk = getSubLimit();
  var actualSubCount = countCompletedSubstitutions(team, gameData.currentSet - 1);
  if (actualSubCount >= _subLimChk) {
    alert('‚ùå MAXIMUM SUBSTITUTIONS REACHED\n\nYou have already used all ' + _subLimChk + ' regular substitutions for this set.\n\nüöë For injuries, use the "Exceptional Substitution" button instead.\n\nExceptional substitutions do NOT count toward the substitution limit.');
    return;
  }
  
  var posIndex = gameData.teams[team].lineup.indexOf(sel.playerOut);
  
  if (posIndex === -1) {
    alert('Error: Player not found on court');
    return;
  }
  
  // FIVB Rule: Track substitutions per team
  if (!set.substitutionTracking) {
    set.substitutionTracking = {A: {}, B: {}};
  }
  if (!set.substitutionTracking[team]) {
    set.substitutionTracking[team] = {};
  }
  
  if (!set.completedSubstitutions) {
    set.completedSubstitutions = {A: [], B: []};
  }
  if (!set.completedSubstitutions[team]) {
    set.completedSubstitutions[team] = [];
  }
  
  var playerOutStr = String(sel.playerOut);
  var playerInStr = String(sel.playerIn);
  
  // Rule 1: Once a player has completed their substitution, they CANNOT go out again
  if (set.completedSubstitutions[team].includes(playerOutStr)) {
    alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerOutStr + ' has completed their substitution.\n\nAfter completing a substitution (OUT then back IN with same player), both players cannot be substituted again in this set.');
    return;
  }
  
  // Rule 2: If playerOut is already paired with someone, they can ONLY substitute with that same player
  if (set.substitutionTracking[team][playerOutStr]) {
    var pairedPlayer = set.substitutionTracking[team][playerOutStr].pairedWith;
    if (pairedPlayer !== playerInStr) {
      alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerOutStr + ' is paired with Player #' + pairedPlayer + '.\n\nPlayer #' + playerOutStr + ' can ONLY substitute with Player #' + pairedPlayer + ' (not with Player #' + playerInStr + ').');
      return;
    }
  }
  
  // Rule 3: If playerIn is already paired with someone, they can ONLY substitute with that same player
  if (set.substitutionTracking[team][playerInStr]) {
    var pairedPlayer = set.substitutionTracking[team][playerInStr].pairedWith;
    if (pairedPlayer !== playerOutStr) {
      alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerInStr + ' is paired with Player #' + pairedPlayer + '.\n\nPlayer #' + playerInStr + ' can ONLY substitute with Player #' + pairedPlayer + ' (not with Player #' + playerOutStr + ').');
      return;
    }
  }
  
  saveActionToHistory({
    type: 'substitution',
    team: team,
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  // Track in set.substitutions
  set.substitutions[team].push({
    time: Date.now(),
    score: {A: set.score.A, B: set.score.B},
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1
  });
  
  // Add to match summary with team name and score (Team's score : Opponent's score)
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var inPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerIn; });
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var otherTeam = team === 'A' ? 'B' : 'A';
  var scoreText = set.score[team] + ':' + set.score[otherTeam];
  addSummaryEvent('S', team, teamName + ' Substitution: #' + sel.playerOut + ' OUT, #' + sel.playerIn + ' IN at ' + scoreText);
  
  // Update tracking (team-specific)
  var isReturning = set.substitutionTracking[team][playerOutStr] && 
                    set.substitutionTracking[team][playerOutStr].pairedWith === playerInStr;
  
  if (isReturning) {
    // This is a return - COMPLETES the substitution for BOTH players
    set.substitutionTracking[team][playerOutStr].completed = true;
    set.substitutionTracking[team][playerInStr].completed = true;
    
    // Mark BOTH players as having completed their substitution
    if (!set.completedSubstitutions[team].includes(playerInStr)) {
      set.completedSubstitutions[team].push(playerInStr);
    }
    if (!set.completedSubstitutions[team].includes(playerOutStr)) {
      set.completedSubstitutions[team].push(playerOutStr);
    }
    
  } else {
    // New substitution - create the pairing for BOTH players
    set.substitutionTracking[team][playerOutStr] = {
      pairedWith: playerInStr,
      completed: false
    };
    set.substitutionTracking[team][playerInStr] = {
      pairedWith: playerOutStr,
      completed: false
    };
  }
  
  gameData.teams[team].lineup[posIndex] = sel.playerIn;
  
  closeSubModal();
  updateMatchDisplay();
  
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var inPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerIn; });
  
  var msg = '‚úì Substitution complete!\nOUT: #' + outPlayer.jersey + ' ' + outPlayer.name + '\nIN: #' + inPlayer.jersey + ' ' + inPlayer.name;
  
  if (isReturning) {
    msg += '\n\nüìã This is the 2nd substitution action with these players.';
    msg += '\n‚ö†Ô∏è Players #' + outPlayer.jersey + ' and #' + inPlayer.jersey + ' cannot be substituted again in this set.';
  } else {
    msg += '\n\nüìã Players #' + outPlayer.jersey + ' and #' + inPlayer.jersey + ' are now paired.';
    msg += '\n‚ö†Ô∏è They can ONLY substitute with each other for the rest of this set.';
  }
  
  alert(msg);
}

function countCompletedSubstitutions(team, setIndex) {
  var set = gameData.sets[setIndex];
  if (!set || !set.substitutions || !set.substitutions[team]) {
    return 0;
  }
  
  // FIVB Rule: Each substitution ACTION counts as 1 substitution
  // Maximum 6 substitution actions per set
  // Example:
  // - Player A OUT, Player B IN = 1st action (count = 1)
  // - Player B OUT, Player A IN = 2nd action (count = 2)
  // Total: 2 actions used
  return set.substitutions[team].length;
}

function closeSubModal() {
  document.getElementById('subModal').classList.remove('active');
  gameData.subSelection = {playerOut: null, playerIn: null, team: null};
}

// EXCEPTIONAL SUBSTITUTION FUNCTIONS
function openExceptionalSubModal() {
  // Save team info BEFORE closing regular modal (closeSubModal resets subSelection)
  var team = gameData.subSelection.team;
  var side = gameData.subSelection.side;
  
  // Close regular sub modal
  closeSubModal();
  
  gameData.exceptionalSubSelection = {playerOut: null, playerIn: null, team: team, side: side};
  
  document.getElementById('exceptionalSubTeamName').textContent = gameData.matchInfo['team' + team + 'Name'];
  
  renderExceptionalSubPlayers(team);
  document.getElementById('exceptionalSubModal').classList.add('active');
}

function renderExceptionalSubPlayers(team) {
  var onCourt = gameData.teams[team].lineup.filter(function(j) { return j; });
  var allPlayers = gameData.teams[team].players;
  
  // Get players currently replaced by liberos
  var replacedByLibero = [];
  if (gameData.liberoReplacements && gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team].forEach(function(replacement) {
      if (onCourt.includes(replacement.libero)) {
        replacedByLibero.push(replacement.originalPlayer);
      }
    });
  }
  
  // Get injured players
  var injuredPlayers = gameData.injuredPlayers[team] || [];
  
  var onBench = allPlayers.filter(function(p) { 
    return !onCourt.includes(p.jersey) && 
           p.role !== 'libero1' && 
           p.role !== 'libero2' &&
           !replacedByLibero.includes(p.jersey) &&
           !injuredPlayers.includes(p.jersey); // Exclude injured players
  });
  
  var outHTML = '';
  onCourt.forEach(function(jersey) {
    var player = allPlayers.find(function(p) { return p.jersey === jersey; });
    if (player) {
      var isLibero = (player.role === 'libero1' || player.role === 'libero2');
      
      if (!isLibero) {
        var badge = player.role === 'captain' ? ' (C)' : '';
        outHTML += '<div class="player-select-btn" onclick="selectExceptionalPlayerOut(' + jersey + ')">';
        outHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
        outHTML += '</div>';
      }
    }
  });
  
  var inHTML = '';
  onBench.forEach(function(p) {
    var badge = p.role === 'captain' ? ' (C)' : '';
    inHTML += '<div class="player-select-btn" onclick="selectExceptionalPlayerIn(' + p.jersey + ')">';
    inHTML += '<strong>#' + p.jersey + '</strong> ' + p.name + badge;
    inHTML += '</div>';
  });
  
  document.getElementById('exceptionalPlayersOut').innerHTML = outHTML || '<div style="color:#888;text-align:center;padding:20px">No players available</div>';
  document.getElementById('exceptionalPlayersIn').innerHTML = inHTML || '<div style="color:#888;text-align:center;padding:20px">No bench players available</div>';
}

function selectExceptionalPlayerOut(jersey) {
  gameData.exceptionalSubSelection.playerOut = jersey;
  
  var buttons = document.querySelectorAll('#exceptionalPlayersOut .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
  });
  
  event.target.closest('.player-select-btn').classList.add('selected');
  
  updateExceptionalConfirmButton();
}

function selectExceptionalPlayerIn(jersey) {
  gameData.exceptionalSubSelection.playerIn = jersey;
  
  var buttons = document.querySelectorAll('#exceptionalPlayersIn .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
  });
  
  event.target.closest('.player-select-btn').classList.add('selected');
  
  updateExceptionalConfirmButton();
}

function updateExceptionalConfirmButton() {
  var btn = document.getElementById('confirmExceptionalSubBtn');
  if (gameData.exceptionalSubSelection.playerOut && gameData.exceptionalSubSelection.playerIn) {
    btn.disabled = false;
    btn.style.opacity = '1';
  } else {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  }
}

function confirmExceptionalSubstitution() {
  var sel = gameData.exceptionalSubSelection;
  
  if (!sel.playerOut || !sel.playerIn) {
    alert('Please select both OUT and IN players');
    return;
  }
  
  var team = sel.team;
  var set = gameData.sets[gameData.currentSet - 1];
  
  var posIndex = gameData.teams[team].lineup.indexOf(sel.playerOut);
  
  if (posIndex === -1) {
    alert('Error: Player not found on court');
    return;
  }
  
  // Get current timestamp
  var now = new Date();
  var timeStr = now.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit'});
  
  // Get player details
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var inPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerIn; });
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var otherTeam = team === 'A' ? 'B' : 'A';
  var scoreText = set.score[team] + ':' + set.score[otherTeam];
  
  // Create auto-generated remark
  var autoRemark = 'Exceptional substitution: #' + sel.playerOut + ' replaced by #' + sel.playerIn + ' (injury) ‚Äì Set ' + gameData.currentSet + ' at ' + scoreText;
  
  // Save to action history (for undo functionality)
  saveActionToHistory({
    type: 'exceptionalSubstitution',
    team: team,
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1,
    setNumber: gameData.currentSet,
    score: {A: set.score.A, B: set.score.B},
    timestamp: timeStr,
    remark: autoRemark
  });
  
  // Track in set.substitutions with EXCEPTIONAL TAG (E)
  if (!set.exceptionalSubstitutions) {
    set.exceptionalSubstitutions = {A: [], B: []};
  }
  if (!set.exceptionalSubstitutions[team]) {
    set.exceptionalSubstitutions[team] = [];
  }
  
  set.exceptionalSubstitutions[team].push({
    time: Date.now(),
    score: {A: set.score.A, B: set.score.B},
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1,
    timestamp: timeStr,
    setNumber: gameData.currentSet,
    remark: autoRemark,
    tag: 'E' // Exceptional tag
  });
  
  // Add to match summary with E tag
  addSummaryEvent('E', team, teamName + ' ' + autoRemark);
  
  // Lock the injured player for the entire match
  if (!gameData.injuredPlayers[team]) {
    gameData.injuredPlayers[team] = [];
  }
  if (!gameData.injuredPlayers[team].includes(sel.playerOut)) {
    gameData.injuredPlayers[team].push(sel.playerOut);
  }
  
  // Perform the substitution
  gameData.teams[team].lineup[posIndex] = sel.playerIn;
  
  closeExceptionalSubModal();
  updateMatchDisplay();
  
  var msg = 'üöë EXCEPTIONAL SUBSTITUTION COMPLETE!\n\n';
  msg += 'OUT: #' + outPlayer.jersey + ' ' + outPlayer.name + ' (INJURED)\n';
  msg += 'IN: #' + inPlayer.jersey + ' ' + inPlayer.name + '\n\n';
  msg += 'üìã Details:\n';
  msg += '‚Ä¢ Set: ' + gameData.currentSet + '\n';
  msg += '‚Ä¢ Score: ' + scoreText + '\n';
  msg += '‚Ä¢ Time: ' + timeStr + '\n\n';
  msg += '‚ö†Ô∏è IMPORTANT:\n';
  msg += '‚Ä¢ This substitution does NOT count toward the 6-substitution limit\n';
  msg += '‚Ä¢ Player #' + outPlayer.jersey + ' is LOCKED and cannot return to play in this match\n';
  msg += '‚Ä¢ Tagged with "E" in match records';
  
  alert(msg);
}

function closeExceptionalSubModal() {
  document.getElementById('exceptionalSubModal').classList.remove('active');
  gameData.exceptionalSubSelection = {playerOut: null, playerIn: null, team: null};
}

function openLiberoModal(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  if (liberos.length === 0) {
    alert('No liberos available for ' + gameData.matchInfo['team' + team + 'Name']);
    return;
  }
  
  gameData.liberoSelection = {libero: null, playerOut: null, team: team, side: side};
  
  document.getElementById('liberoTeamName').textContent = gameData.matchInfo['team' + team + 'Name'];
  
  var set = gameData.sets[gameData.currentSet - 1];
  var isServing = set.serving === team;
  
  var infoText = '‚ö†Ô∏è IMPORTANT: Libero can ONLY replace BACK-ROW players (P1, P5, P6). Front-row replacements are NOT allowed!';
  if (isServing) {
    infoText += '\n\nüö´ LIBERO CANNOT SERVE: Cannot replace P1 while your team has service!';
  }
  
  document.getElementById('liberoInfo').textContent = infoText;
  
  renderLiberoOptions(team);
  document.getElementById('liberoModal').classList.add('active');
}

function renderLiberoOptions(team) {
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  // Check if any libero is already on court
  var liberoOnCourt = null;
  liberos.forEach(function(libero) {
    if (gameData.teams[team].lineup.includes(libero.jersey)) {
      liberoOnCourt = libero.jersey;
    }
  });
  
  var liberosHTML = '';
  liberos.forEach(function(p) {
    var onCourt = gameData.teams[team].lineup.includes(p.jersey);
    var badge = p.role === 'libero1' ? 'L1' : 'L2';

    // ‚îÄ‚îÄ SANCTION BLOCK: expelled/disqualified libero cannot be selected ‚îÄ‚îÄ
    var locked = SM.isPlayerLocked(team, String(p.jersey));
    var lockedReason = SM.isDisqualified(team, String(p.jersey))
      ? 'DISQUALIFIED ‚Äî out for match' : SM.isExpelled(team, String(p.jersey))
      ? 'EXPELLED ‚Äî out for this set' : '';
    if (locked) {
      liberosHTML += '<div class="libero-player-btn disabled" style="opacity:0.35;cursor:not-allowed;border:2px solid #ff4444">';
      liberosHTML += '<strong>#' + p.jersey + '</strong> ' + p.name;
      liberosHTML += '<span class="libero-badge-big">' + badge + '</span>';
      liberosHTML += '<div style="color:#ff4444;font-size:10px;margin-top:3px">üö´ ' + lockedReason + '</div>';
      liberosHTML += '</div>';
      return;
    }
    
    // Disable this libero if another libero is already on court
    var disabled = (liberoOnCourt && liberoOnCourt !== p.jersey);
    var disabledClass = disabled ? ' disabled' : '';
    var disabledStyle = disabled ? 'opacity:0.5;cursor:not-allowed;' : '';
    
    liberosHTML += '<div class="libero-player-btn libero' + disabledClass + '" onclick="' + (disabled ? '' : 'selectLibero(' + p.jersey + ')') + '" style="' + disabledStyle + '">';
    liberosHTML += '<strong>#' + p.jersey + '</strong> ' + p.name;
    liberosHTML += '<span class="libero-badge-big">' + badge + '</span>';
    if (onCourt) {
      liberosHTML += '<div style="color:#00ff00;font-size:11px;margin-top:3px;font-weight:bold">‚óè ON COURT</div>';
    } else if (disabled) {
      liberosHTML += '<div style="color:#ff6b6b;font-size:10px;margin-top:3px">‚õî Other libero on court</div>';
    }
    liberosHTML += '</div>';
  });
  document.getElementById('liberosList').innerHTML = liberosHTML;
  
  var backRowPositions = [1, 5, 6];
  var backRowHTML = '';
  
  var set = gameData.sets[gameData.currentSet - 1];
  var isServing = set.serving === team;
  
  backRowPositions.forEach(function(pos) {
    var jersey = gameData.teams[team].lineup[pos - 1];
    if (jersey) {
      var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
      if (player && player.role !== 'libero1' && player.role !== 'libero2') {
        var badge = player.role === 'captain' ? ' (C)' : '';
        var posLabel = pos === 1 ? 'P1-RB (Back)' : pos === 5 ? 'P5-LB (Back)' : 'P6-MB (Back)';

        // ‚îÄ‚îÄ SANCTION BLOCK: expelled/disqualified player cannot be exchange target ‚îÄ‚îÄ
        var playerLocked = SM.isPlayerLocked(team, String(jersey));
        var playerLockedReason = SM.isDisqualified(team, String(jersey))
          ? 'DISQUALIFIED' : SM.isExpelled(team, String(jersey)) ? 'EXPELLED' : '';
        if (playerLocked) {
          backRowHTML += '<div class="libero-player-btn disabled" style="opacity:0.35;cursor:not-allowed;border:2px solid #ff4444">';
          backRowHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
          backRowHTML += '<div style="color:#00d9ff;font-size:10px;margin-top:3px">' + posLabel + '</div>';
          backRowHTML += '<div style="color:#ff4444;font-size:9px;margin-top:2px">üö´ ' + playerLockedReason + ' ‚Äî no libero exchange</div>';
          backRowHTML += '</div>';
          return;
        }
        
        // PATCH: Exception for designated slot when LiberoServe feature is ON
        var liberoServeOk = (pos === 1 && isServing && LiberoServe.allowsP1Replacement(team, jersey, pos));
        var disabled = (pos === 1 && isServing && !liberoServeOk);
        var disabledClass = disabled ? ' disabled' : '';
        var disabledStyle = disabled ? 'opacity:0.5;cursor:not-allowed;' : '';
        var servingWarning = disabled ? '<div style="color:#ff6b6b;font-size:9px;margin-top:3px">‚ö†Ô∏è CANNOT SERVE</div>' : (liberoServeOk ? '<div style="color:#9c27b0;font-size:9px;margin-top:3px;font-weight:bold">LIBERO SERVE ALLOWED</div>' : '');
        
        backRowHTML += '<div class="libero-player-btn' + disabledClass + '" style="' + disabledStyle + '" onclick="' + (disabled ? 'alert(\'‚õî LIBERO CANNOT SERVE!\\n\\nLibero cannot replace P1 while your team has service.\')' : 'selectBackRowPlayer(' + jersey + ', ' + pos + ')') + '">';
        backRowHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
        backRowHTML += '<div style="color:#00d9ff;font-size:10px;margin-top:3px">' + posLabel + '</div>';
        backRowHTML += servingWarning;
        backRowHTML += '</div>';
      }
    }
  });
  
  if (!backRowHTML) {
    backRowHTML = '<p style="color:#888;padding:10px">No eligible back-row players (P1, P5, P6 only)</p>';
  }
  
  document.getElementById('backRowPlayers').innerHTML = backRowHTML;
}

function selectLibero(jersey) {
  var team = gameData.liberoSelection.team;

  // ‚îÄ‚îÄ SANCTION BLOCK (FIVB Art.19.3): expelled/disqualified libero cannot enter court ‚îÄ‚îÄ
  if (SM.isPlayerLocked(team, String(jersey))) {
    var reason = SM.isDisqualified(team, String(jersey))
      ? 'DISQUALIFIED ‚Äî out for entire match (Art.19.3.2)'
      : 'EXPELLED ‚Äî out for this set (Art.19.3.1)';
    alert('‚õî LIBERO EXCHANGE BLOCKED\n\nLibero #' + jersey + ': ' + reason +
      '\n\nExpelled/Disqualified players cannot participate in libero exchange.');
    return;
  }

  var onCourt = gameData.teams[team].lineup.includes(jersey);
  
  if (onCourt) {
    if (confirm('This libero is already on court. Remove libero from court?')) {
      removeLiberoFromCourt(jersey);
    }
    return;
  }
  
  gameData.liberoSelection.libero = jersey;
  
  var buttons = document.querySelectorAll('#liberosList .libero-player-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    if (btn.textContent.includes('#' + jersey)) {
      btn.classList.add('selected');
    }
  });
  
  updateLiberoInfo();
}

function selectBackRowPlayer(jersey, position) {
  var team = gameData.liberoSelection.team;

  // ‚îÄ‚îÄ SANCTION BLOCK (FIVB Art.19.3): expelled/disqualified player cannot be exchange target ‚îÄ‚îÄ
  if (SM.isPlayerLocked(team, String(jersey))) {
    var reason = SM.isDisqualified(team, String(jersey))
      ? 'DISQUALIFIED ‚Äî out for entire match (Art.19.3.2)'
      : 'EXPELLED ‚Äî out for this set (Art.19.3.1)';
    alert('‚õî LIBERO EXCHANGE BLOCKED\n\nPlayer #' + jersey + ': ' + reason +
      '\n\nExpelled/Disqualified players cannot participate in libero exchange.');
    return;
  }

  gameData.liberoSelection.playerOut = jersey;
  gameData.liberoSelection.position = position;
  
  var buttons = document.querySelectorAll('#backRowPlayers .libero-player-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    if (btn.textContent.includes('#' + jersey)) {
      btn.classList.add('selected');
    }
  });
  
  updateLiberoInfo();
}

function updateLiberoInfo() {
  var sel = gameData.liberoSelection;
  var team = sel.team;
  var allPlayers = gameData.teams[team].players;
  
  var libero = sel.libero ? allPlayers.find(function(p) { return p.jersey === sel.libero; }) : null;
  var playerOut = sel.playerOut ? allPlayers.find(function(p) { return p.jersey === sel.playerOut; }) : null;
  
  var msg = '';
  if (libero && playerOut) {
    msg = 'Replace #' + playerOut.jersey + ' ' + playerOut.name + ' with LIBERO #' + libero.jersey + ' ' + libero.name;
  } else if (libero) {
    msg = 'Selected LIBERO #' + libero.jersey + ' ' + libero.name + ' - Now select back-row player to replace';
  } else if (playerOut) {
    msg = 'Selected #' + playerOut.jersey + ' ' + playerOut.name + ' - Now select a Libero';
  } else {
    msg = 'Select a Libero and a back-row player to replace';
  }
  
  document.getElementById('liberoInfo').textContent = msg;
}

function confirmLiberoReplacement() {
  var sel = gameData.liberoSelection;
  
  if (!sel.libero || !sel.playerOut) {
    alert('Please select both a Libero and a back-row player');
    return;
  }
  
  var team = sel.team;
  var set = gameData.sets[gameData.currentSet - 1];

  // ‚îÄ‚îÄ FINAL SANCTION SAFETY GATE (FIVB Art.19.3) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (SM.isPlayerLocked(team, String(sel.libero))) {
    var lr = SM.isDisqualified(team, String(sel.libero)) ? 'DISQUALIFIED (out for match)' : 'EXPELLED (out for this set)';
    alert('‚õî LIBERO EXCHANGE BLOCKED\n\nLibero #' + sel.libero + ' is ' + lr +
      '\nExpelled/Disqualified players cannot participate in libero exchange (FIVB Art.19.3).');
    return;
  }
  if (SM.isPlayerLocked(team, String(sel.playerOut))) {
    var pr = SM.isDisqualified(team, String(sel.playerOut)) ? 'DISQUALIFIED (out for match)' : 'EXPELLED (out for this set)';
    alert('‚õî LIBERO EXCHANGE BLOCKED\n\nPlayer #' + sel.playerOut + ' is ' + pr +
      '\nExpelled/Disqualified players cannot participate in libero exchange (FIVB Art.19.3).');
    return;
  }
  var allLiberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  var otherLiberoOnCourt = false;
  var otherLiberoJersey = null;
  allLiberos.forEach(function(libero) {
    if (libero.jersey !== sel.libero && gameData.teams[team].lineup.includes(libero.jersey)) {
      otherLiberoOnCourt = true;
      otherLiberoJersey = libero.jersey;
    }
  });
  
  if (otherLiberoOnCourt) {
    var otherLibero = gameData.teams[team].players.find(function(p) { return p.jersey === otherLiberoJersey; });
    var badge = otherLibero.role === 'libero1' ? 'L1' : 'L2';
    alert('‚õî ONLY ONE LIBERO ALLOWED ON COURT!\n\nLibero #' + otherLiberoJersey + ' ' + otherLibero.name + ' (' + badge + ') is already on court.\n\nYou must remove the current libero before bringing in another libero.\n\nTo replace: Click on the current libero and select the original player to bring them back.');
    return;
  }
  
  var posIndex = gameData.teams[team].lineup.indexOf(sel.playerOut);
  
  if (posIndex === -1) {
    alert('Error: Player not found on court');
    return;
  }
  
  var backRowIndices = [0, 4, 5]; // P1, P5, P6
  if (!backRowIndices.includes(posIndex)) {
    alert('‚õî LIBERO RULE VIOLATION!\n\nLibero can ONLY replace back-row players (P1, P5, P6).\n\nThis player is in position P' + (posIndex + 1) + ' which is FRONT ROW.\n\nPlease select a back-row player.');
    return;
  }
  
  // FIVB Rule: Libero CANNOT serve, so cannot replace P1 when their team is serving
  // PATCH: Allow exception when LiberoServe feature designates this slot
  if (posIndex === 0 && set.serving === team) {
    if (!LiberoServe.allowsP1Replacement(team, sel.playerOut, posIndex + 1)) {
      alert('‚õî LIBERO CANNOT SERVE!\n\nFIVB Rule: The Libero is NOT allowed to serve.\n\nPosition P1 (Right Back) is currently the serving position for ' + gameData.matchInfo['team' + team + 'Name'] + '.\n\nTo allow libero serving: in the lineup setup, select a designated player under the Libero Serving Rule option.');
      return;
    }
  }
  
  if (!gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team] = [];
  }
  
  var existingReplacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === sel.libero;
  });
  
  if (existingReplacement) {
    var originalPlayer = existingReplacement.originalPlayer;
    var originalPos = gameData.teams[team].lineup.indexOf(sel.libero);
    if (originalPos !== -1) {
      gameData.teams[team].lineup[originalPos] = originalPlayer;
    }
    
    gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r) {
      return r.libero !== sel.libero;
    });
  }
  
  saveActionToHistory({
    type: 'libero',
    team: team,
    libero: sel.libero,
    originalPlayer: sel.playerOut,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  gameData.liberoReplacements[team].push({
    libero: sel.libero,
    originalPlayer: sel.playerOut,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  gameData.teams[team].lineup[posIndex] = sel.libero;
  
  // Add to match summary event log
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var liberoPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.libero; });
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var set = gameData.sets[gameData.currentSet - 1];
  var scoreText = set.score[team] + ':' + set.score[team === 'A' ? 'B' : 'A'];
  var badge = liberoPlayer.role === 'libero1' ? 'L1' : 'L2';
  addSummaryEvent('Libero', team, teamName + ' Libero #' + sel.libero + ' ' + liberoPlayer.name + ' (' + badge + ') replaces #' + sel.playerOut + ' ' + outPlayer.name + ' in P' + (posIndex + 1) + ' at ' + scoreText);
  
  closeLiberoModal();
  updateMatchDisplay();
  
  var liberoPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.libero; });
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  
  var posName = posIndex === 0 ? 'P1-RB' : posIndex === 4 ? 'P5-LB' : 'P6-MB';
  alert('‚úì Libero replacement complete!\nOUT: #' + outPlayer.jersey + ' ' + outPlayer.name + '\nIN: LIBERO #' + liberoPlayer.jersey + ' ' + liberoPlayer.name + '\nPosition: ' + posName + ' (Back Row)');
}

function removeLiberoFromCourt(liberoJersey) {
  var team = gameData.liberoSelection.team;
  
  var replacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === liberoJersey;
  });
  
  if (!replacement) {
    alert('Error: Libero replacement record not found');
    return;
  }
  
  var posIndex = gameData.teams[team].lineup.indexOf(liberoJersey);
  if (posIndex !== -1) {
    gameData.teams[team].lineup[posIndex] = replacement.originalPlayer;
  }
  
  gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r) {
    return r.libero !== liberoJersey;
  });
  
  closeLiberoModal();
  updateMatchDisplay();
  
  alert('Libero removed from court');
}

function closeLiberoModal() {
  document.getElementById('liberoModal').classList.remove('active');
  gameData.liberoSelection = {libero: null, playerOut: null, team: null};
}

function openRosterModal() {
  // Populate Team A
  document.getElementById('rosterTeamAName').textContent = gameData.matchInfo.teamAName || 'TEAM A';
  var rosterAHTML = '<table class="roster-table"><thead><tr><th>#</th><th>Name</th><th>Role</th><th>Status</th></tr></thead><tbody>';
  
  gameData.teams.A.players.forEach(function(p) {
    var roleText = p.role === 'captain' ? 'Captain' : 
                   p.role === 'libero1' ? 'Libero 1' : 
                   p.role === 'libero2' ? 'Libero 2' : 'Player';
    var onCourt = gameData.teams.A.lineup.includes(p.jersey) ? '‚úì On Court' : '';
    var roleColor = p.role === 'captain' ? '#ffd700' : 
                    (p.role === 'libero1' || p.role === 'libero2') ? '#9c27b0' : '#fff';
    
    rosterAHTML += '<tr><td style="text-align:center;font-weight:bold;color:#ff6b6b">' + p.jersey + '</td>';
    rosterAHTML += '<td>' + p.name + '</td>';
    rosterAHTML += '<td style="color:' + roleColor + '">' + roleText + '</td>';
    rosterAHTML += '<td style="color:#00ff00;font-weight:bold">' + onCourt + '</td></tr>';
  });
  
  rosterAHTML += '</tbody></table>';
  document.getElementById('rosterTeamAContent').innerHTML = rosterAHTML;
  
  // Populate Team B
  document.getElementById('rosterTeamBName').textContent = gameData.matchInfo.teamBName || 'TEAM B';
  var rosterBHTML = '<table class="roster-table"><thead><tr><th>#</th><th>Name</th><th>Role</th><th>Status</th></tr></thead><tbody>';
  
  gameData.teams.B.players.forEach(function(p) {
    var roleText = p.role === 'captain' ? 'Captain' : 
                   p.role === 'libero1' ? 'Libero 1' : 
                   p.role === 'libero2' ? 'Libero 2' : 'Player';
    var onCourt = gameData.teams.B.lineup.includes(p.jersey) ? '‚úì On Court' : '';
    var roleColor = p.role === 'captain' ? '#ffd700' : 
                    (p.role === 'libero1' || p.role === 'libero2') ? '#9c27b0' : '#fff';
    
    rosterBHTML += '<tr><td style="text-align:center;font-weight:bold;color:#4ecdc4">' + p.jersey + '</td>';
    rosterBHTML += '<td>' + p.name + '</td>';
    rosterBHTML += '<td style="color:' + roleColor + '">' + roleText + '</td>';
    rosterBHTML += '<td style="color:#00ff00;font-weight:bold">' + onCourt + '</td></tr>';
  });
  
  rosterBHTML += '</tbody></table>';
  document.getElementById('rosterTeamBContent').innerHTML = rosterBHTML;
  
  document.getElementById('rosterModal').classList.add('active');
}

function closeRosterModal() {
  document.getElementById('rosterModal').classList.remove('active');
}

function isPlayerReplacedByLibero(team, playerJersey) {
  if (!gameData.liberoReplacements[team]) return false;
  return gameData.liberoReplacements[team].some(function(r) {
    return r.originalPlayer === playerJersey;
  });
}

function getPlayerReplacedByLibero(team, liberoJersey) {
  if (!gameData.liberoReplacements[team]) return null;
  var replacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === liberoJersey;
  });
  return replacement ? replacement.originalPlayer : null;
}

function openHistoryModal() {
  populateHistoryModal();
  document.getElementById('historyModal').classList.add('active');
}

function populateHistoryModal() {
  var historyContent = document.getElementById('historyContent');
  if (!historyContent) return;
  
  var html = '';
  
  // Coin Toss Section
  html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd700">';
  html += '<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">ü™ô COIN TOSS</h4>';
  if (gameData.coinToss && gameData.coinToss.winner) {
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    html += '<div style="color:#fff;font-size:13px;line-height:1.8">';
    html += '<div>Winner: <strong style="color:#00d9ff">' + tossWinnerName + '</strong></div>';
    html += '<div>Choice: <strong style="color:#00d9ff">' + tossChoice + '</strong></div>';
    html += '<div>First Server: <strong style="color:#00d9ff">' + firstServerName + '</strong></div>';
    html += '</div>';
  } else {
    html += '<div style="color:#888">No coin toss data</div>';
  }
  html += '</div>';
  
  // Set-by-Set Breakdown
  if (gameData.sets && gameData.sets.length > 0) {
    gameData.sets.forEach(function(set, setIdx) {
      var setNum = setIdx + 1;
      html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid ' + (set.winner ? '#00ff00' : '#888') + '">';
      html += '<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">SET ' + setNum + (set.winner ? ' - Won by ' + gameData.matchInfo['team' + set.winner + 'Name'] : ' - In Progress') + '</h4>';
      
      // Score
      html += '<div style="font-size:24px;font-weight:bold;margin-bottom:10px;color:#fff;text-align:center">';
      html += '<span style="color:#ff6b6b">' + gameData.matchInfo.teamAName + ' ' + set.score.A + '</span>';
      html += ' - ';
      html += '<span style="color:#4ecdc4">' + set.score.B + ' ' + gameData.matchInfo.teamBName + '</span>';
      html += '</div>';
      
      // First Server
      html += '<div style="margin-bottom:10px;padding:8px;background:#1a1a2e;border-radius:4px">';
      html += '<strong style="color:#00d9ff">First Server:</strong> <span style="color:#fff">' + gameData.matchInfo['team' + (set.firstServer || set.serving) + 'Name'] + '</span>';
      html += '</div>';
      
      // Timeouts
      html += '<div style="margin-bottom:10px">';
      html += '<strong style="color:#00d9ff">‚è± TIMEOUTS:</strong>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
      html += '<div style="color:#fff">' + (set.timeouts.A ? set.timeouts.A.length : 0) + ' / 2 used</div>';
      if (set.timeouts.A && set.timeouts.A.length > 0) {
        set.timeouts.A.forEach(function(t) {
          html += '<div style="color:#888;font-size:11px;margin-top:3px">at ' + t.score.A + ':' + t.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
      html += '<div style="color:#fff">' + (set.timeouts.B ? set.timeouts.B.length : 0) + ' / 2 used</div>';
      if (set.timeouts.B && set.timeouts.B.length > 0) {
        set.timeouts.B.forEach(function(t) {
          html += '<div style="color:#888;font-size:11px;margin-top:3px">at ' + t.score.B + ':' + t.score.A + '</div>';
        });
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Substitutions
      var subCountA = countCompletedSubstitutions('A', setIdx);
      var subCountB = countCompletedSubstitutions('B', setIdx);
      
      html += '<div style="margin-bottom:10px">';
      html += '<strong style="color:#00d9ff">üë• SUBSTITUTIONS:</strong>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
      html += '<div style="color:#fff">' + subCountA + ' / ' + getSubLimit() + ' used</div>';
      if (set.substitutions.A && set.substitutions.A.length > 0) {
        set.substitutions.A.forEach(function(s) {
          html += '<div style="color:#ccc;font-size:11px;margin-top:3px">#' + s.playerOut + ' ‚Üí #' + s.playerIn + ' at ' + s.score.A + ':' + s.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
      html += '<div style="color:#fff">' + subCountB + ' / ' + getSubLimit() + ' used</div>';
      if (set.substitutions.B && set.substitutions.B.length > 0) {
        set.substitutions.B.forEach(function(s) {
          html += '<div style="color:#ccc;font-size:11px;margin-top:3px">#' + s.playerOut + ' ‚Üí #' + s.playerIn + ' at ' + s.score.B + ':' + s.score.A + '</div>';
        });
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Libero Replacements - read from matchSummary instead of liberoReplacements
      if (gameData.matchSummary) {
        var liberoEventsA = gameData.matchSummary.filter(function(e) {
          return e.type === 'Libero' && e.team === 'A' && e.setNumber === setNum;
        });
        var liberoEventsB = gameData.matchSummary.filter(function(e) {
          return e.type === 'Libero' && e.team === 'B' && e.setNumber === setNum;
        });
        
        if (liberoEventsA.length > 0 || liberoEventsB.length > 0) {
          html += '<div style="margin-bottom:10px">';
          html += '<strong style="color:#00d9ff">üîÑ LIBERO REPLACEMENTS:</strong>';
          html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
          html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
          html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
          if (liberoEventsA.length > 0) {
            liberoEventsA.forEach(function(event) {
              html += '<div style="color:#ccc;font-size:11px;margin-top:3px">' + event.description + '</div>';
            });
          } else {
            html += '<div style="color:#888;font-size:11px">None</div>';
          }
          html += '</div>';
          html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
          html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
          if (liberoEventsB.length > 0) {
            liberoEventsB.forEach(function(event) {
              html += '<div style="color:#ccc;font-size:11px;margin-top:3px">' + event.description + '</div>';
            });
          } else {
            html += '<div style="color:#888;font-size:11px">None</div>';
          }
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }
      }
      
      html += '</div>';
    });
  }
  
  // Deciding Set Toss (if applicable)
  if (gameData.decidingSetToss) {
    html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ff6b6b">';
    html += '<h4 style="color:#ff6b6b;margin-bottom:10px;font-size:16px">üéØ DECIDING SET TOSS (Set ' + gameData.decidingSetToss.setNumber + ')</h4>';
    var tossWinnerName = gameData.matchInfo['team' + gameData.decidingSetToss.winner + 'Name'];
    var tossChoice = gameData.decidingSetToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.decidingSetToss.firstServer + 'Name'];
    html += '<div style="color:#fff;font-size:13px;line-height:1.8">';
    html += '<div>Winner: <strong style="color:#00d9ff">' + tossWinnerName + '</strong></div>';
    html += '<div>Choice: <strong style="color:#00d9ff">' + tossChoice + '</strong></div>';
    html += '<div>First Server: <strong style="color:#00d9ff">' + firstServerName + '</strong></div>';
    html += '</div>';
    html += '</div>';
  }
  
  historyContent.innerHTML = html;
}

function saveMatch() {
  // Create a save data object with all match information
  var saveData = {
    version: '1.0',
    savedAt: new Date().toISOString(),
    gameData: {
      matchInfo: gameData.matchInfo,
      coinToss: gameData.coinToss,
      decidingSetToss: gameData.decidingSetToss,
      teams: gameData.teams,
      sets: gameData.sets,
      matchSummary: gameData.matchSummary,
      currentSet: gameData.currentSet,
      swapped: gameData.swapped,
      startTime: gameData.startTime,
      matchEnded: gameData.matchEnded
    }
  };
  
  // Convert to JSON string
  var jsonString = JSON.stringify(saveData, null, 2);
  
  // Create filename with team names and date
  var teamA = gameData.matchInfo.teamAName || 'TeamA';
  var teamB = gameData.matchInfo.teamBName || 'TeamB';
  var date = gameData.matchInfo.date || new Date().toISOString().split('T')[0];
  var filename = 'VolleyMatch_' + teamA + '_vs_' + teamB + '_' + date + '.json';
  
  // Create download link
  var blob = new Blob([jsonString], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('‚úÖ MATCH SAVED!\n\nFile: ' + filename + '\n\nYou can load this match later to continue or review.');
}

function saveRosterOnly() {
  // Check if we have roster data
  if (!gameData.teams || !gameData.teams.team1 || !gameData.teams.team2) {
    alert('‚ùå NO ROSTER DATA!\n\nPlease complete the team rosters first.');
    return;
  }
  
  // Create roster save data
  var rosterData = {
    version: '1.0',
    type: 'roster',
    savedAt: new Date().toISOString(),
    matchInfo: {
      team1Name: gameData.matchInfo.team1Name,
      team2Name: gameData.matchInfo.team2Name,
      competition: gameData.matchInfo.competition,
      venue: gameData.matchInfo.venue
    },
    teams: {
      team1: gameData.teams.team1,
      team2: gameData.teams.team2
    },
    officials: gameData.officials || {}
  };
  
  // Convert to JSON
  var jsonString = JSON.stringify(rosterData, null, 2);
  
  // Create filename
  var team1 = gameData.matchInfo.team1Name || 'Team1';
  var team2 = gameData.matchInfo.team2Name || 'Team2';
  var date = new Date().toISOString().split('T')[0];
  var filename = 'Roster_' + team1 + '_vs_' + team2 + '_' + date + '.json';
  
  // Download
  var blob = new Blob([jsonString], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('‚úÖ ROSTER SAVED!\n\nFile: ' + filename + '\n\nYou can load these rosters for practice or future matches.');
}

function loadRosterOnly(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  if (!confirm('‚ö†Ô∏è LOAD ROSTER?\n\nThis will replace the current roster data.\n\nContinue?')) {
    event.target.value = '';
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var loadedData = JSON.parse(e.target.result);
      
      // Validate roster file
      if (loadedData.type !== 'roster' || !loadedData.teams) {
        alert('‚ùå INVALID ROSTER FILE!\n\nThis does not appear to be a valid roster save file.');
        event.target.value = '';
        return;
      }
      
      // Load match info
      if (loadedData.matchInfo) {
        var team1NameEl = document.getElementById('team1Name');
        var team2NameEl = document.getElementById('team2Name');
        var competitionEl = document.getElementById('competition');
        var venueEl = document.getElementById('venue');
        
        if (team1NameEl) team1NameEl.value = loadedData.matchInfo.team1Name || '';
        if (team2NameEl) team2NameEl.value = loadedData.matchInfo.team2Name || '';
        if (competitionEl) competitionEl.value = loadedData.matchInfo.competition || '';
        if (venueEl) venueEl.value = loadedData.matchInfo.venue || '';
      }
      
      // Load teams
      gameData.teams.team1 = loadedData.teams.team1 || {players: [], lineup: []};
      gameData.teams.team2 = loadedData.teams.team2 || {players: [], lineup: []};
      
      // Load officials if present
      if (loadedData.officials) {
        gameData.officials = loadedData.officials;
      }
      
      // Update roster tables with loaded data
      updateRosterTable('team1');
      updateRosterTable('team2');
      
      // Update counts
      updatePlayerCount('team1');
      updatePlayerCount('team2');
      
      alert('‚úÖ ROSTER LOADED!\n\nTeam rosters have been loaded successfully.\n\nYou can now proceed with lineup setup.');
      
      event.target.value = '';
    } catch (error) {
      alert('‚ùå ERROR LOADING ROSTER!\n\n' + error.message);
      event.target.value = '';
    }
  };
  
  reader.readAsText(file);
}

function updateRosterTable(teamKey) {
  // teamKey is 'team1' or 'team2'
  var teamNum = teamKey.replace('team', '');
  var players = gameData.teams[teamKey].players || [];
  
  // Clear all inputs first
  for (var i = 1; i <= 14; i++) {
    var jerseyEl = document.getElementById('team' + teamNum + '_jersey_' + i);
    var nameEl = document.getElementById('team' + teamNum + '_name_' + i);
    var roleEl = document.getElementById('team' + teamNum + '_role_' + i);
    
    if (jerseyEl) jerseyEl.value = '';
    if (nameEl) nameEl.value = '';
    if (roleEl) roleEl.value = '';
  }
  
  // Fill in loaded player data
  players.forEach(function(player) {
    var row = player.row;
    var jerseyEl = document.getElementById('team' + teamNum + '_jersey_' + row);
    var nameEl = document.getElementById('team' + teamNum + '_name_' + row);
    var roleEl = document.getElementById('team' + teamNum + '_role_' + row);
    
    if (jerseyEl) jerseyEl.value = player.jersey || '';
    if (nameEl) nameEl.value = player.name || '';
    if (roleEl) roleEl.value = player.role || '';
  });
}

// SAVE TEAM 1 ROSTER ONLY
function saveTeam1Roster() {
  if (!gameData.teams || !gameData.teams.team1) {
    alert('‚ùå NO TEAM 1 DATA!\n\nPlease complete Team 1 roster first.');
    return;
  }
  
  var rosterData = {
    version: '1.0',
    type: 'team1_roster',
    savedAt: new Date().toISOString(),
    teamName: gameData.matchInfo.team1Name || 'Team 1',
    players: gameData.teams.team1.players || []
  };
  
  var jsonString = JSON.stringify(rosterData, null, 2);
  var teamName = (gameData.matchInfo.team1Name || 'Team1').replace(/\s+/g, '_');
  var date = new Date().toISOString().split('T')[0];
  var filename = 'Roster_' + teamName + '_' + date + '.json';
  
  var blob = new Blob([jsonString], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('‚úÖ TEAM 1 ROSTER SAVED!\n\nFile: ' + filename);
}

// SAVE TEAM 2 ROSTER ONLY
function saveTeam2Roster() {
  if (!gameData.teams || !gameData.teams.team2) {
    alert('‚ùå NO TEAM 2 DATA!\n\nPlease complete Team 2 roster first.');
    return;
  }
  
  var rosterData = {
    version: '1.0',
    type: 'team2_roster',
    savedAt: new Date().toISOString(),
    teamName: gameData.matchInfo.team2Name || 'Team 2',
    players: gameData.teams.team2.players || []
  };
  
  var jsonString = JSON.stringify(rosterData, null, 2);
  var teamName = (gameData.matchInfo.team2Name || 'Team2').replace(/\s+/g, '_');
  var date = new Date().toISOString().split('T')[0];
  var filename = 'Roster_' + teamName + '_' + date + '.json';
  
  var blob = new Blob([jsonString], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('‚úÖ TEAM 2 ROSTER SAVED!\n\nFile: ' + filename);
}

// LOAD TEAM 1 ROSTER ONLY
function loadTeam1Roster(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  if (!confirm('‚ö†Ô∏è LOAD TEAM 1 ROSTER?\n\nThis will replace the current Team 1 roster.\n\nContinue?')) {
    event.target.value = '';
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var loadedData = JSON.parse(e.target.result);
      
      if (loadedData.type !== 'team1_roster' && loadedData.type !== 'team2_roster') {
        alert('‚ùå INVALID FILE!\n\nThis is not a valid team roster file.');
        event.target.value = '';
        return;
      }
      
      // Update team name if present
      if (loadedData.teamName) {
        var teamNameEl = document.getElementById('team1Name');
        if (teamNameEl) teamNameEl.value = loadedData.teamName;
      }
      
      // Load players
      gameData.teams.team1.players = loadedData.players || [];
      
      // Update roster table
      updateRosterTable('team1');
      updatePlayerCount('team1');
      
      alert('‚úÖ TEAM 1 ROSTER LOADED!\n\nTeam 1 roster loaded successfully.');
      event.target.value = '';
    } catch (error) {
      alert('‚ùå ERROR LOADING TEAM 1!\n\n' + error.message);
      event.target.value = '';
    }
  };
  
  reader.readAsText(file);
}

// LOAD TEAM 2 ROSTER ONLY
function loadTeam2Roster(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  if (!confirm('‚ö†Ô∏è LOAD TEAM 2 ROSTER?\n\nThis will replace the current Team 2 roster.\n\nContinue?')) {
    event.target.value = '';
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var loadedData = JSON.parse(e.target.result);
      
      if (loadedData.type !== 'team1_roster' && loadedData.type !== 'team2_roster') {
        alert('‚ùå INVALID FILE!\n\nThis is not a valid team roster file.');
        event.target.value = '';
        return;
      }
      
      // Update team name if present
      if (loadedData.teamName) {
        var teamNameEl = document.getElementById('team2Name');
        if (teamNameEl) teamNameEl.value = loadedData.teamName;
      }
      
      // Load players
      gameData.teams.team2.players = loadedData.players || [];
      
      // Update roster table
      updateRosterTable('team2');
      updatePlayerCount('team2');
      
      alert('‚úÖ TEAM 2 ROSTER LOADED!\n\nTeam 2 roster loaded successfully.');
      event.target.value = '';
    } catch (error) {
      alert('‚ùå ERROR LOADING TEAM 2!\n\n' + error.message);
      event.target.value = '';
    }
  };
  
  reader.readAsText(file);
}

function updatePlayerCount(teamKey) {
  // teamKey is 'team1' or 'team2'
  var teamNum = teamKey.replace('team', '');
  var count = gameData.teams[teamKey].players ? gameData.teams[teamKey].players.length : 0;
  var countEl = document.getElementById('team' + teamNum + 'Count');
  if (countEl) {
    countEl.textContent = count;
  }
}

function loadMatch(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  if (!confirm('‚ö†Ô∏è LOAD MATCH?\n\nThis will replace the current match data.\n\nMake sure you have saved the current match if needed!')) {
    event.target.value = '';  // Reset file input
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var loadedData = JSON.parse(e.target.result);
      
      // Validate the loaded data
      if (!loadedData.gameData || !loadedData.gameData.matchInfo) {
        alert('‚ùå INVALID FILE!\n\nThis does not appear to be a valid match save file.');
        return;
      }
      
      // Restore gameData
      gameData.matchInfo = loadedData.gameData.matchInfo;
      gameData.coinToss = loadedData.gameData.coinToss;
      gameData.decidingSetToss = loadedData.gameData.decidingSetToss;
      gameData.teams = loadedData.gameData.teams;
      gameData.sets = loadedData.gameData.sets;
      gameData.matchSummary = loadedData.gameData.matchSummary || [];
      gameData.currentSet = loadedData.gameData.currentSet;
      gameData.swapped = loadedData.gameData.swapped || false;
      gameData.startTime = loadedData.gameData.startTime;
      gameData.matchEnded = loadedData.gameData.matchEnded || false;
      
      // Initialize libero replacements if not present
      if (!gameData.liberoReplacements) {
        gameData.liberoReplacements = {A: [], B: []};
      }
      
      // Hide setup screen and show main screen
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('matchScreen').classList.remove('hidden');
      
      // Apply team colors
      applyTeamColors();
      
      // Update all displays
      updateMatchDisplay();
      
      alert('‚úÖ MATCH LOADED!\n\nLoaded from: ' + file.name + '\n\nMatch data has been restored.');
      
    } catch (error) {
      alert('‚ùå ERROR LOADING FILE!\n\n' + error.message + '\n\nPlease check that this is a valid match save file.');
      console.error('Load error:', error);
    }
    
    // Reset file input
    event.target.value = '';
  };
  
  reader.readAsText(file);
}

function endMatch() {
  if (!confirm('‚ö†Ô∏è END MATCH?\n\nAre you sure you want to end the current match?\n\nThis will finalize all data and allow you to export the complete scoresheet.')) {
    return;
  }
  
  // Stop all timers
  if (gameData.matchTimerInterval) {
    clearInterval(gameData.matchTimerInterval);
    gameData.matchTimerInterval = null;
  }
  
  // Stop interval timer if running
  if (gameData.intervalTimer) {
    clearInterval(gameData.intervalTimer);
    gameData.intervalTimer = null;
    document.getElementById('intervalTimerDisplay').style.display = 'none';
  }
  
  // Mark match as ended
  gameData.matchEnded = true;
  gameData.matchEndTime = Date.now();
  
  var winner = null;
  var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  if (setsWonA > setsWonB) {
    winner = 'A';
  } else if (setsWonB > setsWonA) {
    winner = 'B';
  }
  
  var msg = '‚úÖ MATCH ENDED\n\n';
  msg += 'Final Score: ' + setsWonA + '-' + setsWonB + '\n';
  if (winner) {
    msg += 'Winner: ' + gameData.matchInfo['team' + winner + 'Name'] + '\n\n';
  } else {
    msg += 'Match incomplete (no winner)\n\n';
  }
  msg += 'You can now:\n';
  msg += '‚Ä¢ View match data (üíæ Match Data button)\n';
  msg += '‚Ä¢ Download PDF scoresheet\n';
  msg += '‚Ä¢ Export signatures\n';
  
  addSummaryEvent('MATCH END', winner || '-', 'Match concluded - Final score: ' + setsWonA + '-' + setsWonB);
  
  alert(msg);
  
  openMatchDataModal();
}

function closeHistoryModal() {
  document.getElementById('historyModal').classList.remove('active');
}

function exportHistoryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH HISTORY REPORT', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Info
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.competition + ' | ' + gameData.matchInfo.venue, 105, yPos, { align: 'center' });
  yPos += 5;
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Coin Toss
  if (gameData.coinToss && gameData.coinToss.winner) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Coin Toss', 20, yPos);
    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    doc.text('Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Set-by-Set Breakdown
  gameData.sets.forEach(function(set, setIdx) {
    var setNum = setIdx + 1;
    
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('SET ' + setNum + (set.winner ? ' - Won by ' + gameData.matchInfo['team' + set.winner + 'Name'] : ''), 20, yPos);
    yPos += 7;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Score: ' + gameData.matchInfo.teamAName + ' ' + set.score.A + ' - ' + set.score.B + ' ' + gameData.matchInfo.teamBName, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + gameData.matchInfo['team' + (set.firstServer || set.serving) + 'Name'], 20, yPos);
    yPos += 8;
    
    // Timeouts Table
    var timeoutData = [];
    var maxTimeouts = Math.max(set.timeouts.A.length, set.timeouts.B.length);
    for (var i = 0; i < maxTimeouts; i++) {
      var toA = set.timeouts.A[i];
      var toB = set.timeouts.B[i];
      timeoutData.push([
        toA ? 'at ' + toA.score.A + '-' + toA.score.B : '-',
        toB ? 'at ' + toB.score.A + '-' + toB.score.B : '-'
      ]);
    }
    
    doc.autoTable({
      head: [['Team A Timeouts (' + set.timeouts.A.length + '/2)', 'Team B Timeouts (' + set.timeouts.B.length + '/2)']],
      body: timeoutData.length > 0 ? timeoutData : [['-', '-']],
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [255, 149, 0] },
      margin: { left: 20, right: 20 }
    });
    
    yPos = doc.lastAutoTable.finalY + 5;
    
    // Substitutions Table  
    var subData = [];
    var maxSubs = Math.max(set.substitutions.A.length, set.substitutions.B.length);
    for (var i = 0; i < maxSubs; i++) {
      var subA = set.substitutions.A[i];
      var subB = set.substitutions.B[i];
      subData.push([
        subA ? '#' + subA.playerOut + '‚Üí#' + subA.playerIn + ' at ' + subA.score.A + '-' + subA.score.B : '-',
        subB ? '#' + subB.playerOut + '‚Üí#' + subB.playerIn + ' at ' + subB.score.A + '-' + subB.score.B : '-'
      ]);
    }
    
    var subCountA = countCompletedSubstitutions('A', setIdx);
    var subCountB = countCompletedSubstitutions('B', setIdx);
    
    doc.autoTable({
      head: [['Team A Subs (' + subCountA + '/' + getSubLimit() + ')', 'Team B Subs (' + subCountB + '/' + getSubLimit() + ')']],
      body: subData.length > 0 ? subData : [['-', '-']],
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [0, 122, 255] },
      margin: { left: 20, right: 20 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
  });
  
  // Deciding Set Toss
  if (gameData.decidingSetToss) {
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 0, 0);
    doc.text('Deciding Set Toss (Set ' + gameData.decidingSetToss.setNumber + ')', 20, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 7;
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.decidingSetToss.winner + 'Name'];
    var tossChoice = gameData.decidingSetToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.decidingSetToss.firstServer + 'Name'];
    doc.text('Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Sanctions ‚Äî FIVB Detailed Output
  var allSanctionRows = [];
  if (gameData.sanctionSystem) {
    ['A','B'].forEach(function(t) {
      gameData.sanctionSystem.misconduct[t].forEach(function(r) {
        var scoreText = r.score ? r.score.A + '-' + r.score.B : '-';
        var typeLabel = {W:'üü® Warning', P:'üü• Penalty (+1pt)', EXP:'üü®üü• Expulsion', DISQ:'üü•‚ùå Disqualification'}[r.type] || r.type;
        allSanctionRows.push([r.time||'-','Set '+r.set, scoreText, gameData.matchInfo['team'+t+'Name']||'Team '+t,
          typeLabel + ' ‚Äî ' + (r.personType==='coach'?'Coach':'#'+r.person) + (r.reason?' ('+r.reason+')':'')
        ]);
      });
      gameData.sanctionSystem.delay[t].log.forEach(function(r) {
        var scoreText = r.score ? r.score.A + '-' + r.score.B : '-';
        var typeLabel = r.type==='DW'?'‚è± Delay Warning':'‚è±üü• Delay Penalty (+1pt)';
        allSanctionRows.push([r.time||'-','Set '+r.set, scoreText, gameData.matchInfo['team'+t+'Name']||'Team '+t, typeLabel]);
      });
    });
  } else if (gameData.matchSummary) {
    var legacySanctions = gameData.matchSummary.filter(function(e){ return e.type && e.type.toUpperCase()==='SANCTION'; });
    legacySanctions.forEach(function(s) {
      var scoreText = s.score ? (s.score.A+'-'+s.score.B) : '-';
      allSanctionRows.push([s.time||'-','Set '+(s.setNumber||'-'),scoreText,s.team?gameData.matchInfo['team'+s.team+'Name']||'Team '+s.team:'-',s.description||'-']);
    });
  }
  
  if (allSanctionRows.length > 0) {
    if (yPos > 220) { doc.addPage(); yPos = 20; }
    doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.setTextColor(255, 0, 0);
    doc.text('FIVB SANCTIONS RECORD', 20, yPos);
    doc.setTextColor(0, 0, 0); yPos += 10;
    
    // Summary counts
    if (gameData.sanctionSystem) {
      doc.setFontSize(10); doc.setFont(undefined, 'normal');
      var tAN = gameData.matchInfo.teamAName||'Team A', tBN = gameData.matchInfo.teamBName||'Team B';
      doc.text('Misconduct ‚Äî ' + tAN + ': ' + gameData.sanctionSystem.misconduct.A.length + '  |  ' + tBN + ': ' + gameData.sanctionSystem.misconduct.B.length, 20, yPos); yPos += 5;
      doc.text('Delay ‚Äî ' + tAN + ': W=' + gameData.sanctionSystem.delay.A.warnings + ' P=' + gameData.sanctionSystem.delay.A.penalties + '  |  ' + tBN + ': W=' + gameData.sanctionSystem.delay.B.warnings + ' P=' + gameData.sanctionSystem.delay.B.penalties, 20, yPos); yPos += 8;
      
      // Disqualified list
      var disqA = gameData.sanctionSystem.disqualified.A, disqB = gameData.sanctionSystem.disqualified.B;
      if (disqA.length + disqB.length > 0) {
        doc.setTextColor(180,0,0);
        var disqStr = 'DISQUALIFIED: ';
        if (disqA.length) disqStr += tAN + ' #' + disqA.map(function(e){return e.jersey;}).join(',#') + '  ';
        if (disqB.length) disqStr += tBN + ' #' + disqB.map(function(e){return e.jersey;}).join(',#');
        doc.text(disqStr, 20, yPos); yPos += 7;
        doc.setTextColor(0,0,0);
      }
    }
    
    doc.autoTable({
      head: [['Time', 'Set', 'Score', 'Team', 'Sanction']],
      body: allSanctionRows,
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [180, 0, 0] },
      columnStyles: { 4: { cellWidth: 85 } },
      margin: { left: 20, right: 20 },
      styles: { fontSize: 9 }
    });
    yPos = doc.lastAutoTable.finalY + 10;
  }
  
  // Footer
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text('Generated by DC_Volley Scoresheet System', 105, 285, { align: 'center' });
  doc.text('¬© 2026 All Rights Reserved', 105, 290, { align: 'center' });
  
  var filename = 'Match_History_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(filename);
  
  alert('‚úÖ Match History exported successfully!');
}

function exportSummaryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH SUMMARY REPORT', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Info
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.competition + ' | ' + gameData.matchInfo.venue, 105, yPos, { align: 'center' });
  yPos += 5;
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Statistics Overview
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Statistics', 20, yPos);
  yPos += 10;
  
  // Count totals across all sets
  var totalTimeoutsA = 0;
  var totalTimeoutsB = 0;
  var totalSubsA = 0;
  var totalSubsB = 0;
  
  gameData.sets.forEach(function(set, idx) {
    totalTimeoutsA += set.timeouts.A ? set.timeouts.A.length : 0;
    totalTimeoutsB += set.timeouts.B ? set.timeouts.B.length : 0;
    totalSubsA += countCompletedSubstitutions('A', idx);
    totalSubsB += countCompletedSubstitutions('B', idx);
  });
  
  doc.autoTable({
    head: [['Category', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName]],
    body: [
      ['Total Timeouts', totalTimeoutsA, totalTimeoutsB],
      ['Total Substitutions', totalSubsA, totalSubsB]
    ],
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 15;
  
  // Event Log
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Complete Event Log', 20, yPos);
    yPos += 10;
    
    var eventData = [];
    gameData.matchSummary.forEach(function(event) {
      var teamName = event.team ? gameData.matchInfo['team' + event.team + 'Name'] : '-';
      eventData.push([
        event.time || '-',
        'Set ' + (event.setNumber || '-'),
        event.type || '-',
        teamName,
        event.description || '-'
      ]);
    });
    
    doc.autoTable({
      head: [['Time', 'Set', 'Type', 'Team', 'Details']],
      body: eventData,
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [255, 215, 0] },
      styles: { fontSize: 8 },
      margin: { left: 10, right: 10 }
    });
  }
  
  // Sanctions Summary
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      doc.addPage();
      yPos = 20;
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 0, 0);
      doc.text('‚ö†Ô∏è SANCTIONS SUMMARY', 20, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 10;
      
      var sanctionData = [];
      sanctions.forEach(function(s) {
        var scoreText = '-';
        if (s.score && s.team) {
          var otherTeam = s.team === 'A' ? 'B' : 'A';
          scoreText = s.score[s.team] + ':' + s.score[otherTeam];
        }
        sanctionData.push([
          s.time || '-',
          'Set ' + (s.setNumber || gameData.currentSet),
          scoreText,
          s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-',
          s.description || '-'
        ]);
      });
      
      doc.autoTable({
        head: [['Time', 'Set', 'Score', 'Team', 'Sanction Details']],
        body: sanctionData,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [255, 0, 0] },
        margin: { left: 20, right: 20 }
      });
    }
  }
  
  // Footer
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  var pageCount = doc.internal.getNumberOfPages();
  for (var i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.text('Page ' + i + ' of ' + pageCount, 105, 290, { align: 'center' });
    doc.text('Generated by DC_Volley Scoresheet System ¬© 2026', 105, 285, { align: 'center' });
  }
  
  var filename = 'Match_Summary_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(filename);
  
  alert('‚úÖ Match Summary exported successfully!');
}

function openMatchDataModal() {
  populateMatchDataModal();
  document.getElementById('matchDataModal').classList.add('active');
}

function closeMatchDataModal() {
  document.getElementById('matchDataModal').classList.remove('active');
}

function openSummaryModal() {
  populateSummaryTable();
  document.getElementById('summaryModal').classList.add('active');
}

function closeSummaryModal() {
  document.getElementById('summaryModal').classList.remove('active');
}

function populateSummaryTable() {
  var teamAName = gameData.matchInfo.teamAName || 'Team A';
  var teamBName = gameData.matchInfo.teamBName || 'Team B';
  var teamAColor = gameData.matchInfo.teamAColor || '#ff6b6b';
  var teamBColor = gameData.matchInfo.teamBColor || '#4ecdc4';
  
  // Calculate total timeouts
  var totalTimeoutsA = 0;
  var totalTimeoutsB = 0;
  gameData.sets.forEach(function(set) {
    if (set.timeouts) {
      totalTimeoutsA += (set.timeouts.A || []).length;
      totalTimeoutsB += (set.timeouts.B || []).length;
    }
  });
  
  document.getElementById('summaryTimeouts').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + totalTimeoutsA + ' / 2 per set</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + totalTimeoutsB + ' / 2 per set</div>';
  
  // Calculate total substitutions
  var totalSubsA = 0;
  var totalSubsB = 0;
  gameData.sets.forEach(function(set) {
    if (set.substitutions) {
      totalSubsA += (set.substitutions.A || []).length;
      totalSubsB += (set.substitutions.B || []).length;
    }
  });
  
  document.getElementById('summarySubstitutions').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + totalSubsA + ' / ' + getSubLimit() + ' per set</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + totalSubsB + ' / ' + getSubLimit() + ' per set</div>';
  
  // Calculate total libero replacements
  var totalLiberoA = 0;
  var totalLiberoB = 0;
  if (gameData.matchSummary) {
    gameData.matchSummary.forEach(function(event) {
      if (event.type === 'Libero') {
        if (event.team === 'A') totalLiberoA++;
        if (event.team === 'B') totalLiberoB++;
      }
    });
  }
  
  document.getElementById('summaryLibero').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + totalLiberoA + '</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + totalLiberoB + '</div>';
  
  // Sanctions ‚Äî use new sanctionSystem if available
  var sanctionsACount = 0, sanctionsBCount = 0;
  var sanctionDetailHTML = '';
  if (gameData.sanctionSystem) {
    sanctionsACount = gameData.sanctionSystem.misconduct.A.length + gameData.sanctionSystem.delay.A.log.length;
    sanctionsBCount = gameData.sanctionSystem.misconduct.B.length + gameData.sanctionSystem.delay.B.log.length;
    // Detail breakdown
    var typeMap = {W:'üü®W', P:'üü•P', EXP:'üü®üü•EXP', DISQ:'üü•‚ùåDISQ', DW:'‚è±DW', DP:'‚è±üü•DP'};
    ['A','B'].forEach(function(t){
      var color = t==='A'?(gameData.matchInfo.teamAColor||'#ff6b9d'):(gameData.matchInfo.teamBColor||'#4ecdc4');
      var tName = gameData.matchInfo['team'+t+'Name']||'Team '+t;
      var mRows = gameData.sanctionSystem.misconduct[t].map(function(r){ return typeMap[r.type]+':#'+r.person; }).join(' ');
      var dRows = gameData.sanctionSystem.delay[t].log.map(function(r){ return typeMap[r.type]; }).join(' ');
      if (mRows||dRows) sanctionDetailHTML += '<div style="color:'+color+';font-size:10px;margin-top:2px">'+tName+': '+(mRows||'')+(mRows&&dRows?' | ':'')+(dRows||'')+'</div>';
    });
  } else {
    sanctionsACount = gameData.sanctionsA || 0;
    sanctionsBCount = gameData.sanctionsB || 0;
  }
  
  document.getElementById('summarySanctions').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + sanctionsACount + '</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + sanctionsBCount + '</div>' +
    sanctionDetailHTML;
  
  // Calculate match duration (actual elapsed time)
  if (gameData.startTime) {
    var now = Date.now();
    var duration = now - gameData.startTime;
    
    var hours = Math.floor(duration / 3600000);
    var minutes = Math.floor((duration % 3600000) / 60000);
    var seconds = Math.floor((duration % 60000) / 1000);
    var durationStr = 
      (hours < 10 ? '0' : '') + hours + ':' +
      (minutes < 10 ? '0' : '') + minutes + ':' +
      (seconds < 10 ? '0' : '') + seconds;
    document.getElementById('totalDuration').textContent = durationStr;
  } else {
    document.getElementById('totalDuration').textContent = 'Not started';
  }
  
  // Generate set-by-set breakdown
  var setBreakdownHTML = '';
  gameData.sets.forEach(function(set, index) {
    var setNum = index + 1;
    var setDuration = '--:--';
    
    // Check for set duration
    if (set.startTime && set.endTime) {
      // Set has both start and end times
      var dur = set.endTime - set.startTime;
      var mins = Math.floor(dur / 60000);
      var secs = Math.floor((dur % 60000) / 1000);
      setDuration = mins + ':' + (secs < 10 ? '0' : '') + secs;
    } else if (set.endTime && gameData.startTime) {
      // Fallback: calculate from match start to set end
      var dur = set.endTime - gameData.startTime;
      var mins = Math.floor(dur / 60000);
      var secs = Math.floor((dur % 60000) / 1000);
      setDuration = mins + ':' + (secs < 10 ? '0' : '') + secs;
    } else if (index === gameData.currentSet - 1 && gameData.setStartTime) {
      // Current set in progress
      setDuration = 'In progress';
    }
    
    var winnerText = set.winner ? 
      (set.winner === 'A' ? '<span style="color:' + teamAColor + '">' + teamAName + ' wins</span>' : 
       '<span style="color:' + teamBColor + '">' + teamBName + ' wins</span>') : 
      'In progress';
    
    var scoreStyle = 'font-size:24px;font-weight:bold;margin:5px 0';
    var scoreA = '<span style="color:' + teamAColor + '">' + set.score.A + '</span>';
    var scoreB = '<span style="color:' + teamBColor + '">' + set.score.B + '</span>';
    
    var timeoutsA = (set.timeouts && set.timeouts.A) ? set.timeouts.A.length : 0;
    var timeoutsB = (set.timeouts && set.timeouts.B) ? set.timeouts.B.length : 0;
    var subsA = (set.substitutions && set.substitutions.A) ? set.substitutions.A.length : 0;
    var subsB = (set.substitutions && set.substitutions.B) ? set.substitutions.B.length : 0;
    
    setBreakdownHTML += '<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #533483;margin-bottom:10px">';
    setBreakdownHTML += '<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:15px;align-items:center">';
    
    // Left: Set info
    setBreakdownHTML += '<div>';
    setBreakdownHTML += '<h4 style="color:#ffd700;font-size:16px;margin-bottom:8px">SET ' + setNum + '</h4>';
    setBreakdownHTML += '<div style="color:#fff;font-size:13px">';
    setBreakdownHTML += '<div>‚è∞ Duration: ' + setDuration + '</div>';
    setBreakdownHTML += '<div>üèÜ ' + winnerText + '</div>';
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
    
    // Center: Score
    setBreakdownHTML += '<div style="text-align:center">';
    setBreakdownHTML += '<div style="' + scoreStyle + '">' + scoreA + ' - ' + scoreB + '</div>';
    setBreakdownHTML += '</div>';
    
    // Right: Stats
    setBreakdownHTML += '<div style="text-align:right">';
    setBreakdownHTML += '<div style="color:#fff;font-size:13px">';
    setBreakdownHTML += '<div>‚è± TO: <span style="color:' + teamAColor + '">' + timeoutsA + '</span> / <span style="color:' + teamBColor + '">' + timeoutsB + '</span></div>';
    setBreakdownHTML += '<div>üë• SUB: <span style="color:' + teamAColor + '">' + subsA + '</span> / <span style="color:' + teamBColor + '">' + subsB + '</span></div>';
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
    
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
  });
  
  document.getElementById('setBreakdownContainer').innerHTML = setBreakdownHTML || '<div style="color:#888;text-align:center;padding:20px">No sets completed yet</div>';
  
  // Populate event log
  if (!gameData.matchSummary || gameData.matchSummary.length === 0) {
    document.getElementById('summaryTableBody').innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center;color:#888">No events yet. Start the match to see live updates.</td></tr>';
    return;
  }
  
  var html = '';
  gameData.matchSummary.forEach(function(event) {
    var teamColor = event.team === 'A' ? teamAColor : teamBColor;
    var teamName = event.team === 'A' ? teamAName : teamBName;
    
    // Build score badge for events that carry a score object
    var scoreBadge = '';
    if (event.score && event.score.A !== undefined) {
      var myScore = event.team === 'A' ? event.score.A : event.score.B;
      var oppScore = event.team === 'A' ? event.score.B : event.score.A;
      scoreBadge = ' <span style="background:#00443a;color:#00ff88;font-weight:bold;padding:1px 6px;border-radius:3px;font-size:11px;border:1px solid #00ff88">' + myScore + '-' + oppScore + '</span>';
    }
    
    html += '<tr style="border-bottom:1px solid #533483">';
    html += '<td style="padding:10px">' + (event.setNumber || 'N/A') + '</td>';
    html += '<td style="padding:10px">' + (event.time || 'N/A') + '</td>';
    html += '<td style="padding:10px;color:' + teamColor + ';font-weight:bold">' + teamName + '</td>';
    html += '<td style="padding:10px">' + (event.type || 'N/A') + '</td>';
    html += '<td style="padding:10px">' + scoreBadge + ' ' + (event.description || 'N/A') + '</td>';
    html += '</tr>';
  });
  
  document.getElementById('summaryTableBody').innerHTML = html;
}

function addSummaryEvent(eventType, team, details, score) {
  if (!gameData.matchSummary) {
    gameData.matchSummary = [];
  }
  
  var now = new Date();
  var timeStr = now.toTimeString().substring(0, 8);
  
  var event = {
    setNumber: gameData.currentSet,
    time: timeStr,
    team: team,
    type: eventType,
    description: details
  };
  
  // Add score if provided
  if (score) {
    event.score = score;
  }
  
  gameData.matchSummary.push(event);
}

function openOfficialsModal() {
  populateOfficialsModal();
  initializeSignaturePads();
  document.getElementById('officialsModal').classList.add('active');
}

function closeOfficialsModal() {
  document.getElementById('officialsModal').classList.remove('active');
}

function populateOfficialsModal() {
  // Set team names in headers and inputs
  document.getElementById('officialsTeamATitle').textContent = gameData.matchInfo.teamAName;
  document.getElementById('officialsTeamBTitle').textContent = gameData.matchInfo.teamBName;
  document.getElementById('teamANameInput').value = gameData.matchInfo.teamAName || '';
  document.getElementById('teamBNameInput').value = gameData.matchInfo.teamBName || '';
  
  // Display match officials names from matchInfo
  document.getElementById('ref1Display').textContent = gameData.matchInfo.ref1 || '-';
  document.getElementById('ref2Display').textContent = gameData.matchInfo.ref2 || '-';
  document.getElementById('scorerDisplay').textContent = gameData.matchInfo.scorer || '-';
  document.getElementById('assistScorerDisplay').textContent = gameData.matchInfo.assistScorer || '-';
  
  // Load saved data if exists
  if (gameData.officials) {
    document.getElementById('coachA').value = gameData.officials.coachA || '';
    document.getElementById('asstCoachA').value = gameData.officials.asstCoachA || '';
    document.getElementById('medicalA').value = gameData.officials.medicalA || '';
    document.getElementById('trainerA').value = gameData.officials.trainerA || '';
    
    document.getElementById('coachB').value = gameData.officials.coachB || '';
    document.getElementById('asstCoachB').value = gameData.officials.asstCoachB || '';
    document.getElementById('medicalB').value = gameData.officials.medicalB || '';
    document.getElementById('trainerB').value = gameData.officials.trainerB || '';
  }
}

function saveOfficials() {
  // Update team names in matchInfo
  var teamAName = document.getElementById('teamANameInput').value.trim();
  var teamBName = document.getElementById('teamBNameInput').value.trim();
  
  if (teamAName) {
    gameData.matchInfo.teamAName = teamAName;
  }
  if (teamBName) {
    gameData.matchInfo.teamBName = teamBName;
  }
  
  // Update all displays with new team names
  document.getElementById('courtNameA').textContent = gameData.matchInfo.teamAName;
  document.getElementById('courtNameB').textContent = gameData.matchInfo.teamBName;
  document.getElementById('sideATtl').textContent = gameData.matchInfo.teamAName + ' LINEUP';
  document.getElementById('sideBTtl').textContent = gameData.matchInfo.teamBName + ' LINEUP';
  
  gameData.officials = {
    coachA: document.getElementById('coachA').value,
    asstCoachA: document.getElementById('asstCoachA').value,
    medicalA: document.getElementById('medicalA').value,
    trainerA: document.getElementById('trainerA').value,
    coachB: document.getElementById('coachB').value,
    asstCoachB: document.getElementById('asstCoachB').value,
    medicalB: document.getElementById('medicalB').value,
    trainerB: document.getElementById('trainerB').value,
    signatures: {
      captainSignA1: document.getElementById('captainSignA1').toDataURL(),
      captainSignA2: document.getElementById('captainSignA2').toDataURL(),
      coachSignA: document.getElementById('coachSignA').toDataURL(),
      captainSignB1: document.getElementById('captainSignB1').toDataURL(),
      captainSignB2: document.getElementById('captainSignB2').toDataURL(),
      coachSignB: document.getElementById('coachSignB').toDataURL(),
      firstRefSign: document.getElementById('firstRefSign').toDataURL(),
      secondRefSign: document.getElementById('secondRefSign').toDataURL(),
      scorerSign: document.getElementById('scorerSign').toDataURL(),
      assistScorerSign: document.getElementById('assistScorerSign').toDataURL()
    }
  };
  
  updateMatchDisplay();
  
  alert('‚úÖ Officials and signatures saved successfully!');
}

var signaturePads = {};

function initializeSignaturePads() {
  var canvasIds = ['captainSignA1', 'captainSignA2', 'coachSignA', 'captainSignB1', 'captainSignB2', 'coachSignB', 'firstRefSign', 'secondRefSign', 'scorerSign', 'assistScorerSign'];
  
  canvasIds.forEach(function(id) {
    var canvas = document.getElementById(id);
    var ctx = canvas.getContext('2d');
    
    // Load saved signature if exists
    if (gameData.officials && gameData.officials.signatures && gameData.officials.signatures[id]) {
      var img = new Image();
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
      };
      img.src = gameData.officials.signatures[id];
    }
    
    var drawing = false;
    
    canvas.addEventListener('mousedown', function(e) {
      drawing = true;
      ctx.beginPath();
      var rect = canvas.getBoundingClientRect();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });
    
    canvas.addEventListener('mousemove', function(e) {
      if (!drawing) return;
      var rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    canvas.addEventListener('mouseup', function() {
      drawing = false;
    });
    
    canvas.addEventListener('mouseleave', function() {
      drawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      drawing = true;
      ctx.beginPath();
      var rect = canvas.getBoundingClientRect();
      var touch = e.touches[0];
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });
    
    canvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      if (!drawing) return;
      var rect = canvas.getBoundingClientRect();
      var touch = e.touches[0];
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    canvas.addEventListener('touchend', function(e) {
      e.preventDefault();
      drawing = false;
    });
  });
}

function clearSignature(canvasId) {
  var canvas = document.getElementById(canvasId);
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// ================================================================
// FIVB SANCTION MANAGEMENT SYSTEM
// Module A: Misconduct  |  Module B: Delay
// ================================================================

var SM = {
  // ‚îÄ‚îÄ UI state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  module: 'misconduct',   // 'misconduct' | 'delay'
  team: null,             // 'A' | 'B'
  person: null,           // 'player' | 'coach'
  jerseyInput: '',        // raw jersey text
  misconductType: null,   // 'W' | 'P' | 'EXP' | 'DISQ'
  delayType: null,        // 'DW' | 'DP'

  // ‚îÄ‚îÄ Pending data (set during red-card confirmation flow) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  pending: null,

  // ‚îÄ‚îÄ Sub-required flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  subReqTeam: null,
  subReqJersey: null,
  subReqSelected: null,

  // ‚îÄ‚îÄ DATA STRUCTURES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // gameData.sanctionSystem = {
  //   misconduct: {A: [], B: []},   // misconduct records per team
  //   delay: {A: {warnings:0, penalties:0, log:[]}, B:{...}},
  //   expelled: {A: [], B: []},     // [{jersey, set}] ‚Äì cleared next set
  //   disqualified: {A: [], B: []}, // [{jersey}] ‚Äì entire match
  //   coachExpelled: {A: false, B: false},
  //   coachDisqualified: {A: false, B: false}
  // }

  ensure: function() {
    if (!gameData.sanctionSystem) {
      gameData.sanctionSystem = {
        misconduct: {A: [], B: []},
        delay: {
          A: {warnings: 0, penalties: 0, log: []},
          B: {warnings: 0, penalties: 0, log: []}
        },
        expelled: {A: [], B: []},
        disqualified: {A: [], B: []},
        coachExpelled: {A: false, B: false},
        coachDisqualified: {A: false, B: false}
      };
    }
    // backward-compat
    if (!gameData.sanctions) gameData.sanctions = {A: [], B: []};
    if (!gameData.sanctionsA) gameData.sanctionsA = 0;
    if (!gameData.sanctionsB) gameData.sanctionsB = 0;
  },

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  currentScore: function() {
    var s = gameData.sets[gameData.currentSet - 1];
    return s ? {A: s.score.A, B: s.score.B} : {A: 0, B: 0};
  },
  timestamp: function() { return new Date().toTimeString().substring(0,8); },
  teamName: function(t) { return gameData.matchInfo['team' + t + 'Name'] || 'Team ' + t; },
  opponent: function(t) { return t === 'A' ? 'B' : 'A'; },

  // ‚îÄ‚îÄ Query misconduct history for a specific person ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  getMisconductHistory: function(team, jerseyOrCoach) {
    SM.ensure();
    return gameData.sanctionSystem.misconduct[team].filter(function(r) {
      return r.person === String(jerseyOrCoach);
    });
  },

  isExpelled: function(team, jersey) {
    SM.ensure();
    return gameData.sanctionSystem.expelled[team].some(function(e) {
      return String(e.jersey) === String(jersey) && e.set === gameData.currentSet;
    });
  },

  isDisqualified: function(team, jersey) {
    SM.ensure();
    return gameData.sanctionSystem.disqualified[team].some(function(e) {
      return String(e.jersey) === String(jersey);
    });
  },

  isPlayerLocked: function(team, jersey) {
    return SM.isExpelled(team, jersey) || SM.isDisqualified(team, jersey);
  },

  // Build card display string
  cardString: function(type) {
    var m = {W:'üü® Yellow Card (Warning)', P:'üü• Red Card (Penalty)', EXP:'üü®üü• Expulsion', DISQ:'üü•‚ùå Disqualification', DW:'‚è± Delay Warning', DP:'‚è±üü• Delay Penalty'};
    return m[type] || type;
  },

  // ‚îÄ‚îÄ Auto-suggest next misconduct level for a player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  suggestMisconductType: function(team, jerseyOrCoach) {
    var hist = SM.getMisconductHistory(team, jerseyOrCoach);
    var hasWarning = hist.some(function(r){ return r.type==='W'; });
    var hasPenalty = hist.some(function(r){ return r.type==='P'; });
    var hasExp    = hist.some(function(r){ return r.type==='EXP'; });
    if (hasExp)    return {suggest:'DISQ', reason:'Already expelled ‚Äî disqualification recommended'};
    if (hasPenalty) return {suggest:'EXP', reason:'Already has Red Card ‚Äî Expulsion is next'};
    if (hasWarning) return {suggest:'P',   reason:'Already has Yellow Card ‚Äî Penalty recommended'};
    return {suggest:'W', reason:'First offence ‚Äî Warning recommended'};
  },

  // ‚îÄ‚îÄ Reset expelled status for new set ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onNewSet: function() {
    SM.ensure();
    // expelled players are out for the SET only ‚Äî cleared for next set
    // (disqualified stay locked)
    gameData.sanctionSystem.expelled.A = [];
    gameData.sanctionSystem.expelled.B = [];
    gameData.sanctionSystem.coachExpelled.A = false;
    gameData.sanctionSystem.coachExpelled.B = false;
  },

  // ‚îÄ‚îÄ Award point to opponent (penalty / delay penalty) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // sanctionSnapshot ‚Äî optional deep snapshot to also undo when this point is undone
  awardPenaltyPoint: function(penalisedTeam, sanctionSnapshot) {
    var opp = SM.opponent(penalisedTeam);
    var set = gameData.sets[gameData.currentSet - 1];

    // Save to history so UNDO can correctly reverse this penalty point (and sanction)
    saveActionToHistory({
      type: 'point',
      team: opp,
      previousScore: {A: set.score.A, B: set.score.B},
      previousServing: set.serving,
      previousLineupA: gameData.teams.A.lineup.slice(),
      previousLineupB: gameData.teams.B.lineup.slice(),
      previousLiberoReplacementsA: JSON.parse(JSON.stringify(gameData.liberoReplacements.A || [])),
      previousLiberoReplacementsB: JSON.parse(JSON.stringify(gameData.liberoReplacements.B || [])),
      setNumber: gameData.currentSet,
      previousSummaryLength: (gameData.matchSummary || []).length,
      sanctionSnapshot: sanctionSnapshot || null  // full sanction state before this sanction
    });

    set.score[opp]++;
    addSummaryEvent('Pt', opp, 'Sanction penalty point ‚Äî Score: ' + set.score.A + '-' + set.score.B);

    // If service is changing, rotate the team that now gets to serve (FIVB rule)
    if (set.serving !== opp) {
      set.serving = opp;
      rotateTeam(opp);
      // The penalised team loses service ‚Üí they become receivers ‚Üí libero may enter P1
      setTimeout(function() {
        checkAutoLiberoEntryAfterLosingService(penalisedTeam);
      }, 600);
    }

    // ‚îÄ‚îÄ Set-win check (same logic as addPointToTeam) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var maxSets = parseInt(gameData.matchInfo.format);
    var target = 25;
    if (maxSets === 5 && gameData.currentSet === 5) target = 15;
    else if (maxSets === 3 && gameData.currentSet === 3) target = 15;

    if (set.score[opp] >= target && set.score[opp] - set.score[penalisedTeam] >= 2) {
      set.winner = opp;
      set.endTime = Date.now();
      addSummaryEvent('SET WIN', opp, 'Won Set ' + gameData.currentSet + ' (' + set.score[opp] + '-' + set.score[penalisedTeam] + ')');

      // Force-stop rally so no more points can be scored in this set
      gameData.rallyInProgress = false;
      var rallyBtn = document.getElementById('rallyButton');
      var rallyStatus = document.getElementById('rallyStatus');
      if (rallyBtn) { rallyBtn.textContent = 'üèê START RALLY'; rallyBtn.style.background = '#ffd700'; rallyBtn.style.animation = 'none'; }
      if (rallyStatus) { rallyStatus.textContent = 'Set Complete'; rallyStatus.style.color = '#888'; }

      var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
      var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
      var setsNeeded = maxSets === 5 ? 3 : 2;

      updateMatchDisplay();

      if (setsWonA >= setsNeeded || setsWonB >= setsNeeded) {
        if (gameData.matchTimerInterval) { clearInterval(gameData.matchTimerInterval); gameData.matchTimerInterval = null; }
        if (gameData.intervalTimer) { clearInterval(gameData.intervalTimer); gameData.intervalTimer = null; document.getElementById('intervalTimerDisplay').style.display = 'none'; }
        gameData.matchEnded = true;
        gameData.matchEndTime = Date.now();
        setTimeout(function() {
          alert('üèÜ ' + gameData.matchInfo['team' + opp + 'Name'] + ' WINS THE MATCH!\n\nFinal Score: ' + set.score[opp] + '-' + set.score[penalisedTeam]);
        }, 300);
      } else {
        setTimeout(function() {
          var msg = '‚úÖ SET ' + gameData.currentSet + ' COMPLETE!\n\n';
          msg += gameData.matchInfo['team' + opp + 'Name'] + ' wins ' + set.score[opp] + '-' + set.score[penalisedTeam] + '\n\n';
          var nextSetNum = gameData.currentSet + 1;
          var isDecidingSet = (maxSets === 3 && nextSetNum === 3) || (maxSets === 5 && nextSetNum === 5);
          if (isDecidingSet) {
            msg += 'üéØ DECIDING SET ' + nextSetNum + '!\n\nA new coin toss will be conducted.\n\n';
          } else {
            msg += 'üèê ' + gameData.matchInfo['team' + penalisedTeam + 'Name'] + ' will serve first in next set.\n\n';
          }
          msg += '3-minute interval started. Setup lineup now!';
          alert(msg);
          startIntervalTimer(180, function() {});
          if (isDecidingSet) { showDecidingSetToss(); } else { startNextSet(); }
        }, 300);
      }
      return;
    }

    updateMatchDisplay();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPEN / CLOSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSanctionModal() {
  SM.ensure();
  // Reset UI state
  SM.module = 'misconduct'; SM.team = null; SM.person = null;
  SM.jerseyInput = ''; SM.misconductType = null; SM.delayType = null;

  // Set team names
  document.getElementById('smTeamAName').textContent = SM.teamName('A');
  document.getElementById('smTeamBName').textContent = SM.teamName('B');

  // Reset buttons
  ['smTeamA','smTeamB'].forEach(function(id){ smStyleReset(id,'#533483'); });
  ['smPersonPlayer','smPersonCoach'].forEach(function(id){ smStyleReset(id,'#533483'); });
  // Reset sanction type button borders to their default dim colours
  var typeBorders = {smTypeW:'#ffd70055', smTypeP:'#ff444455', smTypeEXP:'#ff880055', smTypeDISQ:'#cc00cc55'};
  Object.keys(typeBorders).forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    el.style.background = '#16213e';
    el.style.borderColor = typeBorders[id];
    el.style.color = id === 'smTypeW' ? '#ffd700' : id === 'smTypeP' ? '#ff4444' : id === 'smTypeEXP' ? '#ff8800' : '#cc00cc';
  });
  ['smDelayTypeW','smDelayTypeP'].forEach(function(id){ if(document.getElementById(id)) smStyleReset(id,null); });

  document.getElementById('smPlayerJerseyRow').style.display = 'none';
  document.getElementById('smPlayerJersey').value = '';
  document.getElementById('smEscalationStatus').style.display = 'none';
  document.getElementById('smConsequenceBox').style.display = 'none';
  document.getElementById('smDelayConsequenceBox').style.display = 'none';
  document.getElementById('smMisconductNotes').value = '';
  document.getElementById('smMisconductReason').value = '';
  var hintEl = document.getElementById('smTypeHint');
  if (hintEl) hintEl.style.display = '';

  smSelectModule('misconduct');
  smUpdateLiveSanctionLog();
  document.getElementById('sanctionModal').classList.add('active');
}

function closeSanctionModal() {
  document.getElementById('sanctionModal').classList.remove('active');
}

function smStyleReset(id, borderColor) {
  var el = document.getElementById(id);
  if (!el) return;
  el.style.background = '#16213e';
  el.style.color = '#aaa';
  if (borderColor) el.style.borderColor = borderColor;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE / TEAM / PERSON SELECTORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smSelectModule(mod) {
  SM.module = mod;
  var isM = mod === 'misconduct';

  // Tab styling
  var tabM = document.getElementById('smTabMisconduct');
  var tabD = document.getElementById('smTabDelay');
  tabM.style.background = isM ? '#2d1f00' : '#16213e';
  tabM.style.color      = isM ? '#ffd700' : '#888';
  tabM.style.borderColor = isM ? '#ffd700' : '#533483';
  tabD.style.background = !isM ? '#0d1a2e' : '#16213e';
  tabD.style.color      = !isM ? '#00d9ff' : '#888';
  tabD.style.borderColor = !isM ? '#00d9ff' : '#533483';

  document.getElementById('smMisconductPanel').style.display = isM ? '' : 'none';
  document.getElementById('smDelayPanel').style.display      = isM ? 'none' : '';

  if (!isM) smRefreshDelayPanel();
}

function smSelectTeam(t) {
  SM.team = t;
  var colorA = gameData.matchInfo.teamAColor || '#ff6b9d';
  var colorB = gameData.matchInfo.teamBColor || '#4ecdc4';
  var ca = t === 'A' ? colorA : '#533483';
  var cb = t === 'B' ? colorB : '#533483';
  document.getElementById('smTeamA').style.borderColor = ca;
  document.getElementById('smTeamA').style.color = t === 'A' ? '#fff' : '#aaa';
  document.getElementById('smTeamB').style.borderColor = cb;
  document.getElementById('smTeamB').style.color = t === 'B' ? '#fff' : '#aaa';

  // Refresh escalation if person already selected
  if (SM.module === 'misconduct' && SM.person) {
    smRefreshEscalation();
  }
  if (SM.module === 'delay') smRefreshDelayPanel();
}

function smSelectPerson(p) {
  SM.person = p;
  document.getElementById('smPersonPlayer').style.background = p === 'player' ? '#533483' : '#16213e';
  document.getElementById('smPersonPlayer').style.color = p === 'player' ? '#fff' : '#aaa';
  document.getElementById('smPersonCoach').style.background  = p === 'coach'  ? '#533483' : '#16213e';
  document.getElementById('smPersonCoach').style.color  = p === 'coach'  ? '#fff' : '#aaa';
  document.getElementById('smPlayerJerseyRow').style.display = p === 'player' ? '' : 'none';
  smRefreshEscalation();
}

function smSelectMisconductType(t) {
  SM.misconductType = t;
  var hintEl = document.getElementById('smTypeHint');
  if (hintEl) hintEl.style.display = 'none';
  var colors = {W:'#ffd700', P:'#ff4444', EXP:'#ff8800', DISQ:'#cc00cc'};
  ['W','P','EXP','DISQ'].forEach(function(k){
    var el = document.getElementById('smType'+k);
    if (!el) return;
    el.style.background = k === t ? colors[k] + '22' : '#16213e';
    el.style.color      = colors[k];
    el.style.borderColor = k === t ? colors[k] : colors[k] + '55';
  });
  smShowConsequence();
}

function smSelectDelayType(t) {
  SM.delayType = t;
  document.getElementById('smDelayTypeW').style.background = t === 'DW' ? '#ffd70022' : '#16213e';
  document.getElementById('smDelayTypeW').style.borderColor = t === 'DW' ? '#ffd700' : '#ffd70055';
  document.getElementById('smDelayTypeP').style.background = t === 'DP' ? '#ff444422' : '#16213e';
  document.getElementById('smDelayTypeP').style.borderColor = t === 'DP' ? '#ff4444' : '#ff444455';
  smShowDelayConsequence();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESCALATION STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smRefreshEscalation() {
  if (!SM.team) return;
  var jerseyEl = document.getElementById('smPlayerJersey');
  var key = SM.person === 'coach' ? 'coach' : (jerseyEl.value.trim() || '?');
  var hist = SM.getMisconductHistory(SM.team, key);
  var suggestion = SM.suggestMisconductType(SM.team, key);

  var statusEl = document.getElementById('smEscalationStatus');
  var detailEl = document.getElementById('smEscalationDetail');

  if (hist.length > 0) {
    statusEl.style.display = '';
    var html = hist.map(function(r){
      return '<span style="margin-right:8px">' + SM.cardString(r.type) + ' (Set ' + r.set + ')</span>';
    }).join('');
    html += '<div style="margin-top:6px;color:#ffd700">‚Üí Next suggested: ' + SM.cardString(suggestion.suggest) + ' ‚Äî ' + suggestion.reason + '</div>';
    detailEl.innerHTML = html;
  } else {
    statusEl.style.display = 'none';
  }
}

function smShowConsequence() {
  var box = document.getElementById('smConsequenceBox');
  var txt = document.getElementById('smConsequenceText');
  if (!SM.misconductType) { box.style.display = 'none'; return; }
  var msgs = {
    W:    'Yellow Card issued. ‚ö†Ô∏è Warning only ‚Äî no point awarded. Player stays on court.',
    P:    'üü• Red Card penalty ‚Äî <strong>+1 point</strong> and <strong>service</strong> awarded to opponent. Player stays on court.',
    EXP:  'üü®üü• Expulsion ‚Äî Player/Coach removed for <strong>remainder of this set</strong>. Replacement allowed (does NOT count as regular substitution). Eligible again next set.',
    DISQ: 'üü•‚ùå Disqualification ‚Äî Player/Coach removed for <strong>entire match</strong>. Replacement allowed (exceptional sub). <strong>No point awarded</strong> (FIVB Art.19.3.2).'
  };
  txt.innerHTML = msgs[SM.misconductType] || '';
  box.style.display = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELAY PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smRefreshDelayPanel() {
  SM.ensure();
  var grid = document.getElementById('smDelayStatusGrid');
  var autoText = document.getElementById('smDelayAutoText');
  var teams = ['A','B'];
  var html = '';
  teams.forEach(function(t) {
    var d = gameData.sanctionSystem.delay[t];
    var color = t === 'A' ? (gameData.matchInfo.teamAColor || '#ff6b9d') : (gameData.matchInfo.teamBColor || '#4ecdc4');
    html += '<div style="background:#1a2030;padding:10px;border-radius:5px;border:2px solid ' + color + '">';
    html += '<div style="color:' + color + ';font-weight:bold;font-size:13px">' + SM.teamName(t) + '</div>';
    html += '<div style="margin-top:5px;font-size:12px;color:#ccc">‚è± Warnings: <strong style="color:#ffd700">' + d.warnings + '</strong></div>';
    html += '<div style="font-size:12px;color:#ccc">üü• Penalties: <strong style="color:#ff4444">' + d.penalties + '</strong></div>';
    var next = d.warnings === 0 ? 'First delay ‚Üí Delay Warning (no pt)' : 'Delay already warned ‚Üí Delay Penalty (+1 pt)';
    html += '<div style="font-size:10px;color:#888;margin-top:4px">Next: ' + next + '</div>';
    html += '</div>';
  });
  grid.innerHTML = html;

  // Auto-suggestion for selected team
  if (SM.team) {
    var d = gameData.sanctionSystem.delay[SM.team];
    if (d.warnings === 0) {
      autoText.innerHTML = 'First delay for <strong>' + SM.teamName(SM.team) + '</strong> ‚Üí Suggest <strong style="color:#ffd700">‚è± Delay Warning</strong> (no point)';
      smSelectDelayType('DW');
    } else {
      autoText.innerHTML = 'Already warned (√ó' + d.warnings + ') ‚Üí Suggest <strong style="color:#ff4444">‚è±üü• Delay Penalty</strong> (+1 pt to opponent)';
      smSelectDelayType('DP');
    }
  } else {
    autoText.innerHTML = '<em style="color:#888">Select a team above to see suggestion.</em>';
  }
}

function smShowDelayConsequence() {
  var box = document.getElementById('smDelayConsequenceBox');
  var txt = document.getElementById('smDelayConsequenceText');
  if (!SM.delayType || !SM.team) { box.style.display = 'none'; return; }
  if (SM.delayType === 'DW') {
    txt.innerHTML = '‚è± Delay Warning recorded for <strong>' + SM.teamName(SM.team) + '</strong>. No point. This is a warning ‚Äî next delay will be a penalty.';
  } else {
    txt.innerHTML = '‚è±üü• Delay Penalty ‚Äî <strong>+1 point</strong> and <strong>service</strong> awarded to <strong>' + SM.teamName(SM.opponent(SM.team)) + '</strong>.';
  }
  box.style.display = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRM MISCONDUCT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smConfirmMisconduct() {
  if (!SM.team) { alert('Please select a team.'); return; }
  if (!SM.person) { alert('Please select Player or Coach.'); return; }
  var jersey = '';
  if (SM.person === 'player') {
    jersey = document.getElementById('smPlayerJersey').value.trim();
    if (!jersey) { alert('Please enter the player jersey number.'); return; }

    // ‚îÄ‚îÄ Validate jersey exists in this team's roster ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var jerseyNum = parseInt(jersey);
    var rosterPlayer = gameData.teams[SM.team].players.find(function(p) {
      return p.jersey === jerseyNum || String(p.jersey) === jersey;
    });
    if (!rosterPlayer) {
      var teamName = SM.teamName(SM.team);
      var validJerseys = gameData.teams[SM.team].players.map(function(p){ return '#' + p.jersey; }).join(', ');
      alert('‚õî INVALID JERSEY NUMBER\n\nPlayer #' + jersey + ' does not exist in ' + teamName + '\'s roster.\n\nValid jerseys: ' + validJerseys);
      return;
    }
  }
  if (!SM.misconductType) { alert('Please select a sanction type.'); return; }

  // Validate not already disqualified
  var key = SM.person === 'coach' ? 'coach' : jersey;
  if (SM.person === 'player' && SM.isDisqualified(SM.team, jersey)) {
    alert('‚õî Player #' + jersey + ' is already DISQUALIFIED for this match.');
    return;
  }
  if (SM.person === 'coach' && gameData.sanctionSystem.coachDisqualified[SM.team]) {
    alert('‚õî Coach of ' + SM.teamName(SM.team) + ' is already DISQUALIFIED.');
    return;
  }

  // Require red-card confirmation for P, EXP, DISQ
  if (SM.misconductType === 'P' || SM.misconductType === 'EXP' || SM.misconductType === 'DISQ') {
    smShowRedConfirm(key, jersey);
    return;
  }

  // Yellow card ‚Äî apply immediately
  smApplyMisconduct(key, jersey);
}

function smShowRedConfirm(key, jersey) {
  SM.pending = {key: key, jersey: jersey};
  var titles = {P:'CONFIRM RED CARD ‚Äî PENALTY', EXP:'CONFIRM EXPULSION', DISQ:'CONFIRM DISQUALIFICATION'};
  var effects = {
    P:    'üü• +1 point awarded to <strong>' + SM.teamName(SM.opponent(SM.team)) + '</strong>.<br>Service transfers to opponent.<br>Player remains on court.',
    EXP:  'üü®üü• Player/Coach removed for remainder of <strong>Set ' + gameData.currentSet + '</strong>.<br>Replacement required (not counted as regular sub).<br>No point penalty.',
    DISQ: 'üü•‚ùå Player/Coach removed for <strong>entire match</strong>.<br><strong>No point awarded</strong> (FIVB Art.19.3.2).<br>Replacement required (exceptional sub).'
  };
  var person = SM.person === 'coach' ? 'Coach / Staff' : 'Player #' + jersey;
  document.getElementById('smRedConfirmTitle').textContent = titles[SM.misconductType];
  document.getElementById('smRedConfirmText').innerHTML = 'Sanctioning: <strong style="color:#ffd700">' + SM.teamName(SM.team) + ' ‚Äî ' + person + '</strong>';
  document.getElementById('smRedConfirmEffect').innerHTML = effects[SM.misconductType];
  document.getElementById('smRedConfirmModal').classList.add('active');
}

function smRedConfirmYes() {
  document.getElementById('smRedConfirmModal').classList.remove('active');
  smApplyMisconduct(SM.pending.key, SM.pending.jersey);
  SM.pending = null;
}

function smRedConfirmNo() {
  document.getElementById('smRedConfirmModal').classList.remove('active');
  SM.pending = null;
}

function smApplyMisconduct(key, jersey) {
  SM.ensure();
  var team = SM.team;
  var type = SM.misconductType;
  var reason = document.getElementById('smMisconductReason').value;
  var notes  = document.getElementById('smMisconductNotes').value.trim();
  var score  = SM.currentScore();

  // ‚îÄ‚îÄ Snapshot full sanction state BEFORE writing anything ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // This is stored in the history entry so UNDO restores it fully
  var sanctionSnapshot = JSON.parse(JSON.stringify({
    misconduct: gameData.sanctionSystem.misconduct,
    delay: gameData.sanctionSystem.delay,
    expelled: gameData.sanctionSystem.expelled,
    disqualified: gameData.sanctionSystem.disqualified,
    coachExpelled: gameData.sanctionSystem.coachExpelled,
    coachDisqualified: gameData.sanctionSystem.coachDisqualified,
    sanctionsA: gameData.sanctionsA || 0,
    sanctionsB: gameData.sanctionsB || 0
  }));

  var record = {
    id: Date.now(),
    set: gameData.currentSet,
    time: SM.timestamp(),
    type: type,         // 'W'|'P'|'EXP'|'DISQ'
    person: key,        // jersey string or 'coach'
    personType: SM.person,
    reason: reason,
    notes: notes,
    score: {A: score.A, B: score.B},
    team: team
  };

  gameData.sanctionSystem.misconduct[team].push(record);

  if (team==='A') gameData.sanctionsA=(gameData.sanctionsA||0)+1;
  else            gameData.sanctionsB=(gameData.sanctionsB||0)+1;

  // ‚îÄ‚îÄ Apply consequences ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var personLabel = SM.person === 'coach' ? 'Coach' : '#' + jersey;
  var fullLabel   = SM.teamName(team) + ' ' + personLabel;
  var summaryDetail = SM.cardString(type) + ' ‚Äî ' + fullLabel;
  if (reason) summaryDetail += ' (' + reason + ')';

  if (type === 'P') {
    // Penalty: +1 pt to opponent
    SM.awardPenaltyPoint(team, sanctionSnapshot);
    addSummaryEvent('SANCTION', team, summaryDetail + ' ‚Üí +1pt to ' + SM.teamName(SM.opponent(team)), score);
  } else if (type === 'EXP') {
    // Expulsion: lock for this set only (FIVB Art.19.3.1)
    if (SM.person === 'coach') {
      gameData.sanctionSystem.coachExpelled[team] = true;
      addSummaryEvent('SANCTION', team, summaryDetail + ' ‚Üí Coach OUT for Set ' + gameData.currentSet, score);
    } else {
      var isLiberoEXP = smIsLiberoPlayer(team, jersey);
      var isCaptainEXP = smIsCaptainPlayer(team, jersey);
      gameData.sanctionSystem.expelled[team].push({jersey: jersey, set: gameData.currentSet});
      addSummaryEvent('SANCTION', team, summaryDetail + ' ‚Üí OUT for Set ' + gameData.currentSet, score);
      if (isLiberoEXP) {
        smHandleLiberoSanction(team, jersey, 'expelled');
      } else {
        smCheckSubRequired(team, jersey, 'expelled');
      }
      // Captain expelled: only blocks that set; no captain redesignation needed for EXP
    }
  } else if (type === 'DISQ') {
    // Disqualification: out for match, NO penalty point (FIVB Art.19.3.2)
    if (SM.person === 'coach') {
      gameData.sanctionSystem.coachDisqualified[team] = true;
      addSummaryEvent('SANCTION', team, summaryDetail + ' ‚Üí Coach OUT entire match. No point.', score);
    } else {
      var isLiberoDISQ = smIsLiberoPlayer(team, jersey);
      var isCaptainDISQ = smIsCaptainPlayer(team, jersey);
      gameData.sanctionSystem.disqualified[team].push({jersey: jersey});
      addSummaryEvent('SANCTION', team, summaryDetail + ' ‚Üí OUT entire match. No point.', score);
      if (isLiberoDISQ) {
        smHandleLiberoSanction(team, jersey, 'disqualified');
      } else {
        smCheckSubRequired(team, jersey, 'disqualified');
      }
      if (isCaptainDISQ) {
        setTimeout(function(){ smHandleCaptainDisqualified(team, jersey); }, 400);
      }
    }
  } else {
    // Warning only
    addSummaryEvent('SANCTION', team, summaryDetail, score);
  }

  smUpdateLiveSanctionLog();
  updateMatchDisplay();
  closeSanctionModal();

  var msg = '‚úÖ ' + SM.cardString(type) + ' applied to ' + fullLabel;
  if (type === 'P') msg += '\n+1 point awarded to ' + SM.teamName(SM.opponent(team));
  if (type === 'EXP') msg += '\nPlayer locked for Set ' + gameData.currentSet;
  if (type === 'DISQ') msg += '\nPlayer locked for entire match. No point awarded.';
  if (type === 'W') alert(msg);
  if (type === 'P') alert(msg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRM DELAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smConfirmDelay() {
  if (!SM.team) { alert('Please select a team.'); return; }
  if (!SM.delayType) { alert('Please select Delay Warning or Penalty.'); return; }

  SM.ensure();
  var team = SM.team;
  var type = SM.delayType;
  var d = gameData.sanctionSystem.delay[team];
  var score = SM.currentScore();

  // Snapshot full sanction state BEFORE writing anything
  var sanctionSnapshot = JSON.parse(JSON.stringify({
    misconduct: gameData.sanctionSystem.misconduct,
    delay: gameData.sanctionSystem.delay,
    expelled: gameData.sanctionSystem.expelled,
    disqualified: gameData.sanctionSystem.disqualified,
    coachExpelled: gameData.sanctionSystem.coachExpelled,
    coachDisqualified: gameData.sanctionSystem.coachDisqualified,
    sanctionsA: gameData.sanctionsA || 0,
    sanctionsB: gameData.sanctionsB || 0
  }));

  var record = {
    id: Date.now(),
    set: gameData.currentSet,
    time: SM.timestamp(),
    type: type,  // 'DW' | 'DP'
    team: team,
    score: {A: score.A, B: score.B}
  };

  if (type === 'DW') {
    d.warnings++;
  } else {
    d.penalties++;
    SM.awardPenaltyPoint(team, sanctionSnapshot);
  }
  d.log.push(record);

  if (team==='A') gameData.sanctionsA=(gameData.sanctionsA||0)+1;
  else            gameData.sanctionsB=(gameData.sanctionsB||0)+1;

  var label = type === 'DW' ? 'Delay Warning' : 'Delay Penalty';
  var detail = '‚è± ' + label + ' ‚Äî ' + SM.teamName(team);
  if (type === 'DP') detail += ' ‚Üí +1pt to ' + SM.teamName(SM.opponent(team));
  addSummaryEvent('SANCTION', team, detail, score);

  smUpdateLiveSanctionLog();
  updateMatchDisplay();
  closeSanctionModal();

  var msg = '‚úÖ ' + label + ' applied to ' + SM.teamName(team);
  if (type === 'DP') msg += '\n+1 point awarded to ' + SM.teamName(SM.opponent(team));
  alert(msg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBSTITUTE REQUIRED (Expulsion / Disqualification)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smCheckSubRequired(team, jersey, lockType) {
  SM.ensure();
  var onCourt = gameData.teams[team].lineup;
  if (!onCourt.some(function(j){ return String(j) === String(jersey); })) return;

  // Player is on court ‚Äî substitution required
  SM.subReqTeam = team;
  SM.subReqJersey = jersey;
  SM.subReqSelected = null;

  var player = gameData.teams[team].players.find(function(p){ return String(p.jersey) === String(jersey); });
  var pName = player ? player.name : '#' + jersey;
  var lockMsg = lockType === 'expelled' ? 'expelled for Set ' + gameData.currentSet : 'DISQUALIFIED for entire match';

  document.getElementById('smSubReqTitle').textContent = lockType === 'expelled' ? 'üîÑ EXPULSION ‚Äî SUBSTITUTE REQUIRED' : 'üîÑ DISQUALIFICATION ‚Äî SUBSTITUTE REQUIRED';
  document.getElementById('smSubReqText').innerHTML =
    '<strong style="color:#ffd700">#' + jersey + ' ' + pName + '</strong> has been ' + lockMsg + ' and must leave the court immediately.<br><br>Select an eligible bench player to replace them. This does NOT count as a regular substitution.';

  // Build eligible bench list (not libero, not already locked, not on court, not injured)
  var alreadyLocked = gameData.sanctionSystem.expelled[team].map(function(e){ return String(e.jersey); })
    .concat(gameData.sanctionSystem.disqualified[team].map(function(e){ return String(e.jersey); }));
  var injuredPlayers = gameData.injuredPlayers[team] || [];
  var liberoRepl = [];
  if (gameData.liberoReplacements && gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team].forEach(function(r){ if(onCourt.includes(r.libero)) liberoRepl.push(r.originalPlayer); });
  }

  var eligible = gameData.teams[team].players.filter(function(p) {
    var j = String(p.jersey);
    return !onCourt.includes(p.jersey)
      && p.role !== 'libero1' && p.role !== 'libero2'
      && !alreadyLocked.includes(j)
      && !injuredPlayers.includes(p.jersey)
      && !liberoRepl.includes(p.jersey);
  });

  var listEl = document.getElementById('smSubReqPlayerList');
  var noneEl = document.getElementById('smSubReqNoneMsg');
  var confirmBtn = document.getElementById('smSubReqConfirmBtn');

  if (eligible.length === 0) {
    listEl.innerHTML = '';
    noneEl.style.display = '';
    confirmBtn.style.display = 'none';
  } else {
    noneEl.style.display = 'none';
    confirmBtn.style.display = '';
    var html = '';
    eligible.forEach(function(p) {
      var badge = p.role === 'captain' ? ' <span style="background:#ffd700;color:#000;padding:1px 4px;border-radius:2px;font-size:9px">C</span>' : '';
      html += '<div onclick="smSubReqSelect(' + p.jersey + ',this)" style="padding:10px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;font-size:13px">';
      html += '<strong>#' + p.jersey + '</strong> ' + p.name + badge + '</div>';
    });
    listEl.innerHTML = html;
  }

  document.getElementById('smSubRequiredModal').classList.add('active');
}

function smSubReqSelect(jersey, el) {
  SM.subReqSelected = jersey;
  var items = document.querySelectorAll('#smSubReqPlayerList > div');
  items.forEach(function(d){ d.style.background='#0f3460'; d.style.borderColor='#533483'; });
  el.style.background = '#533483';
  el.style.borderColor = '#ffd700';
}

function smSubReqConfirm() {
  if (!SM.subReqSelected) { alert('Please select a replacement player.'); return; }
  var team = SM.subReqTeam;
  var outJersey = SM.subReqJersey;
  var inJersey  = SM.subReqSelected;

  // Perform the swap in lineup
  var lineup = gameData.teams[team].lineup;
  var pos = lineup.indexOf(Number(outJersey));
  if (pos === -1) pos = lineup.indexOf(String(outJersey));
  if (pos >= 0) {
    lineup[pos] = Number(inJersey) || inJersey;
  }

  addSummaryEvent('SUB', team, 'üîÑ Sanction replacement: #' + outJersey + ' ‚Üí #' + inJersey + ' (exceptional, not counted)', SM.currentScore());
  updateMatchDisplay();  // This already calls updateLineupPanel correctly for both teams
  document.getElementById('smSubRequiredModal').classList.remove('active');
  SM.subReqTeam = SM.subReqJersey = SM.subReqSelected = null;
}

function smSubReqDismiss() {
  document.getElementById('smSubRequiredModal').classList.remove('active');
  SM.subReqTeam = SM.subReqJersey = SM.subReqSelected = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADVANCED SANCTION EDGE-CASE LOGIC (FIVB Rules)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
// FIVB Rule References:
//   Art.5.1.2  ‚Äî Team Captain: designation, authority, scoresheet
//   Art.8.1    ‚Äî Team composition: min 6 players to continue
//   Art.8.3.2  ‚Äî Incomplete team: set/match forfeit
//   Art.19.3.1 ‚Äî Expulsion: out for remainder of set
//   Art.19.3.2 ‚Äî Disqualification: out for entire match, NO point
//   Art.19.4   ‚Äî Libero sanctions: removal, redesignation
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ Helper: is player a libero? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function smIsLiberoPlayer(team, jersey) {
  if (!gameData.teams[team]) return false;
  var pl = gameData.teams[team].players.find(function(p){ return String(p.jersey)===String(jersey); });
  return pl && (pl.role === 'libero1' || pl.role === 'libero2');
}

// ‚îÄ‚îÄ Helper: is player the captain? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function smIsCaptainPlayer(team, jersey) {
  if (!gameData.teams[team]) return false;
  var pl = gameData.teams[team].players.find(function(p){ return String(p.jersey)===String(jersey); });
  return pl && pl.role === 'captain';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. LIBERO SANCTION HANDLER (FIVB Art.19.3 + Art.19.4)
//    Called when a libero receives EXP or DISQ.
//    - Removes libero from court, restores original player
//    - Checks for redesignation (2 liberos) or no-libero continuation
//    - Triggers incomplete team check if < 6 eligible players
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function smHandleLiberoSanction(team, jersey, lockType) {
  SM.ensure();
  var allPlayers = gameData.teams[team].players;
  var sanctionedLibero = allPlayers.find(function(p){ return String(p.jersey)===String(jersey); });
  if (!sanctionedLibero) return;

  // Step 1 ‚Äî Remove libero from court immediately if on court
  var lineup = gameData.teams[team].lineup;
  var onCourt = lineup.some(function(j){ return String(j)===String(jersey); });
  if (onCourt) {
    // Restore original player from liberoReplacements
    var repl = (gameData.liberoReplacements[team]||[]).find(function(r){
      return String(r.libero) === String(jersey);
    });
    if (repl) {
      var posIdx = lineup.indexOf(Number(jersey)||jersey);
      if (posIdx === -1) posIdx = lineup.indexOf(String(jersey));
      if (posIdx !== -1) lineup[posIdx] = repl.originalPlayer;
      gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r){
        return String(r.libero) !== String(jersey);
      });
      addSummaryEvent('SUB', team, 'Libero #' + jersey + ' removed from court (sanction). #' + repl.originalPlayer + ' returns.');
    } else {
      var posIdx2 = lineup.indexOf(Number(jersey)||jersey);
      if (posIdx2 === -1) posIdx2 = lineup.indexOf(String(jersey));
      if (posIdx2 !== -1) lineup[posIdx2] = null;
      addSummaryEvent('SUB', team, 'Libero #' + jersey + ' removed from court (sanction). No original player record.');
    }
  }

  // Step 2 ‚Äî Find other eligible libero (FIVB Art.19.4 redesignation)
  var otherLiberos = allPlayers.filter(function(p){
    return (p.role === 'libero1' || p.role === 'libero2') &&
           String(p.jersey) !== String(jersey) &&
           !SM.isPlayerLocked(team, String(p.jersey));
  });

  var teamName = SM.teamName(team);
  var lockLabel = lockType === 'expelled' ? 'EXPELLED (this set)' : 'DISQUALIFIED (match)';

  if (otherLiberos.length > 0) {
    // ‚îÄ‚îÄ 2 Liberos: other can continue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var other = otherLiberos[0];
    setTimeout(function(){
      alert('‚ö†Ô∏è LIBERO SANCTIONED ‚Äî ' + lockLabel + '\n\n' +
        teamName + ' Libero #' + jersey + ' ' + sanctionedLibero.name + ' has been removed.\n\n' +
        '‚úÖ LIBERO REDESIGNATION (FIVB Art.19.4):\n' +
        '2nd Libero #' + other.jersey + ' ' + other.name + ' may continue as the active Libero.\n\n' +
        (lockType === 'expelled'
          ? 'üîÑ Sanctioned libero may return next set (expulsion = set only).'
          : 'üö´ Sanctioned libero cannot return for the rest of the match.'));
    }, 200);

  } else {
    // ‚îÄ‚îÄ 1 Libero or both locked: check if team has 6 eligible ‚îÄ‚îÄ‚îÄ
    var eligibleOnCourt = lineup.filter(function(j){
      if (j === null || j === undefined) return false;
      var pl = allPlayers.find(function(p){ return String(p.jersey)===String(j); });
      return pl && pl.role !== 'libero1' && pl.role !== 'libero2' &&
             !SM.isPlayerLocked(team, String(j));
    });

    if (eligibleOnCourt.length >= 6) {
      setTimeout(function(){
        alert('‚ö†Ô∏è LIBERO SANCTIONED ‚Äî ' + lockLabel + '\n\n' +
          teamName + ' Libero #' + jersey + ' ' + sanctionedLibero.name + ' removed.\n\n' +
          '‚õî NO REDESIGNATION AVAILABLE (FIVB Art.19.4)\n' +
          (lockType === 'expelled'
            ? 'Team continues WITHOUT a Libero for this set. Libero may return next set.'
            : 'Team continues WITHOUT a Libero for the rest of the match.'));
      }, 200);
    } else {
      // Not enough players ‚Äî incomplete team rule
      smHandleIncompleteTeam(team, lockType);
    }
  }

  updateMatchDisplay();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 2. CAPTAIN DISQUALIFICATION HANDLER (FIVB Art.5.1.2)
//    Fires when a player with role 'captain' is disqualified.
//    Opens redesignation modal. New captain gets immediate authority.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function smHandleCaptainDisqualified(team, oldJersey) {
  SM.ensure();
  var allPlayers = gameData.teams[team].players;
  var oldCap = allPlayers.find(function(p){ return String(p.jersey)===String(oldJersey); });

  // Eligible: not libero, not the disqualified captain, not locked
  var eligible = allPlayers.filter(function(p){
    return p.role !== 'libero1' && p.role !== 'libero2' &&
           String(p.jersey) !== String(oldJersey) &&
           !SM.isPlayerLocked(team, String(p.jersey));
  });

  if (eligible.length === 0) {
    alert('‚ö†Ô∏è CAPTAIN DISQUALIFIED (FIVB Art.5.1.2)\n\n' +
      SM.teamName(team) + ' Captain #' + oldJersey + (oldCap ? ' ' + oldCap.name : '') + ' disqualified.\n\n' +
      '‚õî No eligible replacement captain found.\n' +
      'Consult 1st Referee per Art.5.1.2.\n' +
      'Vice-Captain may assume scoresheet duties.');
    return;
  }

  var listHTML = eligible.map(function(p){
    var onCourt = gameData.teams[team].lineup.some(function(j){ return String(j)===String(p.jersey); });
    return '<div onclick="smConfirmNewCaptain(\'' + team + '\',\'' + oldJersey + '\',' + p.jersey + ',this)" ' +
      'style="padding:10px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center">' +
      '<span><strong>#' + p.jersey + '</strong> ' + p.name + '</span>' +
      '<span style="font-size:11px;color:' + (onCourt ? '#00ff88' : '#aaa') + '">' +
      (onCourt ? '‚óè ON COURT' : 'On bench') + '</span></div>';
  }).join('');

  document.getElementById('smCaptainReqTeam').textContent = SM.teamName(team);
  document.getElementById('smCaptainReqOld').textContent = '#' + oldJersey + (oldCap ? ' ' + oldCap.name : '');
  document.getElementById('smCaptainReqList').innerHTML = listHTML;
  document.getElementById('smCaptainReqModal').classList.add('active');
}

function smConfirmNewCaptain(team, oldJersey, newJersey, btn) {
  // Highlight selection
  document.querySelectorAll('#smCaptainReqList > div').forEach(function(el){
    el.style.background = '#0f3460'; el.style.borderColor = '#533483';
  });
  if (btn) { btn.style.background = '#533483'; btn.style.borderColor = '#ffd700'; }

  var allPlayers = gameData.teams[team].players;
  var oldCap = allPlayers.find(function(p){ return String(p.jersey)===String(oldJersey); });
  var newCap = allPlayers.find(function(p){ return p.jersey === newJersey; });

  // Transfer captain role
  if (oldCap) oldCap.role = 'player';
  if (newCap) newCap.role = 'captain';

  addSummaryEvent('CAPTAIN', team, 'New Captain: #' + newJersey + ' ' + (newCap ? newCap.name : '') +
    ' replaces disqualified #' + oldJersey + ' (FIVB Art.5.1.2)');

  document.getElementById('smCaptainReqModal').classList.remove('active');
  updateMatchDisplay();
  alert('‚úÖ NEW CAPTAIN DESIGNATED (FIVB Art.5.1.2)\n\n' +
    SM.teamName(team) + ' new Captain: #' + newJersey + ' ' + (newCap ? newCap.name : '') + '\n\n' +
    '‚Ä¢ Captain authority transfers immediately\n' +
    '‚Ä¢ New captain has full protest rights\n' +
    '‚Ä¢ New captain will sign scoresheet at end of match');
}

function smCloseCaptainReq() {
  document.getElementById('smCaptainReqModal').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 3. INCOMPLETE TEAM HANDLER (FIVB Art.8.3.2)
//    If team cannot field 6 players ‚Üí set/match lost by forfeit.
//    Forfeit score: 0-25 for the incomplete team's set.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function smHandleIncompleteTeam(team, lockType) {
  var opp = SM.opponent(team);
  var maxSets = parseInt(gameData.matchInfo.format);
  var setsNeeded = maxSets === 5 ? 3 : 2;
  var setsWonA = gameData.sets.filter(function(s){ return s.winner==='A'; }).length;
  var setsWonB = gameData.sets.filter(function(s){ return s.winner==='B'; }).length;
  var oppSetsWon = opp === 'A' ? setsWonA : setsWonB;

  // Forfeit current set
  var set = gameData.sets[gameData.currentSet - 1];
  set.score[opp]  = 25;
  set.score[team] = 0;
  set.winner = opp;
  set.endTime = Date.now();
  set.forfeit = true;

  addSummaryEvent('FORFEIT', team, SM.teamName(team) + ' INCOMPLETE TEAM ‚Äî Set ' +
    gameData.currentSet + ' forfeited 0-25 (FIVB Art.8.3.2)');

  var newOppSets = oppSetsWon + 1;
  if (newOppSets >= setsNeeded) {
    if (gameData.matchTimerInterval) { clearInterval(gameData.matchTimerInterval); gameData.matchTimerInterval = null; }
    gameData.matchEnded = true; gameData.matchEndTime = Date.now();
    updateMatchDisplay();
    setTimeout(function(){
      alert('üèÜ MATCH FORFEITED ‚Äî INCOMPLETE TEAM (FIVB Art.8.3.2)\n\n' +
        SM.teamName(team) + ' cannot field 6 players.\n' +
        SM.teamName(opp) + ' wins the match by forfeit.\n' +
        'Forfeited set score: 0-25.');
    }, 300);
  } else {
    updateMatchDisplay();
    setTimeout(function(){
      alert('‚ö†Ô∏è INCOMPLETE TEAM ‚Äî SET FORFEITED (FIVB Art.8.3.2)\n\n' +
        SM.teamName(team) + ' cannot field 6 players.\n' +
        'Set ' + gameData.currentSet + ' awarded to ' + SM.teamName(opp) + ' (25-0).\n' +
        'Match continues.');
      startNextSet();
    }, 300);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE SANCTION LOG (bottom of modal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smUpdateLiveSanctionLog() {
  SM.ensure();
  var all = [];
  ['A','B'].forEach(function(t){
    gameData.sanctionSystem.misconduct[t].forEach(function(r){
      all.push({time:r.time, team:t, label: SM.cardString(r.type), person: r.person, set: r.set, score: r.score});
    });
    gameData.sanctionSystem.delay[t].log.forEach(function(r){
      all.push({time:r.time, team:t, label: SM.cardString(r.type), person:'Team', set: r.set, score: r.score});
    });
  });
  all.sort(function(a,b){ return a.time > b.time ? 1 : -1; });
  if (all.length === 0) { document.getElementById('smLiveSanctionLog').innerHTML = '<em style="color:#555">No sanctions recorded yet.</em>'; return; }
  var colors = {A: gameData.matchInfo.teamAColor||'#ff6b9d', B: gameData.matchInfo.teamBColor||'#4ecdc4'};
  var html = all.map(function(r){
    var scoreStr = '';
    if (r.score && r.score.A !== undefined) {
      var myScore = r.team === 'A' ? r.score.A : r.score.B;
      var oppScore = r.team === 'A' ? r.score.B : r.score.A;
      scoreStr = ' <span style="color:#00ff88;font-weight:bold">[' + myScore + '-' + oppScore + ']</span>';
    }
    return '<div style="padding:3px 0;border-bottom:1px solid #1a2030">'
      + '<span style="color:' + colors[r.team] + ';font-weight:bold">' + SM.teamName(r.team) + '</span> '
      + '<span style="color:#ffd700">' + r.label + '</span> '
      + (r.person !== 'Team' ? '<span style="color:#ccc">#' + r.person + '</span>' : '<span style="color:#aaa">Team</span>')
      + scoreStr + ' '
      + '<span style="color:#666">Set ' + r.set + ' ' + r.time + '</span>'
      + '</div>';
  }).join('');
  document.getElementById('smLiveSanctionLog').innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRATION: isPlayerLocked check for sub modal
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function smIsPlayerBlockedFromSub(team, jersey) {
  if (!gameData.sanctionSystem) return false;
  return SM.isPlayerLocked(team, Number(jersey) || jersey);
}

// Patch into renderSubPlayers ‚Äì add sanction lock check
// Called by the existing renderSubPlayers when building bench/court lists

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRATION: Called when a new set starts
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Hook into existing startNewSet / manuallyOpenNextSetLineup flow
var _smOriginalStartNewSet = typeof startNewSet === 'function' ? startNewSet : null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRATION: lineup panel card symbols (updated from previous patch)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// This function is re-defined here to include sanctionSystem data
// (overrides the previous version that used old gameData.sanctions)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKWARD-COMPAT: old selectSanctionTeam / recordSanction stubs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var selectedSanctionTeam = null;
function selectSanctionTeam(t) { smSelectTeam(t); selectedSanctionTeam = t; }
function recordSanction() { smConfirmMisconduct(); }



function populateMatchDataModal() {
  // Match Information
  var infoHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">';
  infoHTML += '<div><strong>Competition:</strong> ' + gameData.matchInfo.competition + '</div>';
  infoHTML += '<div><strong>Match Number:</strong> ' + gameData.matchInfo.matchNumber + '</div>';
  infoHTML += '<div><strong>Venue:</strong> ' + gameData.matchInfo.venue + '</div>';
  infoHTML += '<div><strong>Date:</strong> ' + gameData.matchInfo.date + '</div>';
  infoHTML += '<div><strong>Time:</strong> ' + gameData.matchInfo.time + '</div>';
  infoHTML += '<div><strong>Format:</strong> Best of ' + gameData.matchInfo.format + '</div>';
  infoHTML += '<div><strong>1st Referee:</strong> ' + gameData.matchInfo.ref1 + '</div>';
  infoHTML += '<div><strong>2nd Referee:</strong> ' + gameData.matchInfo.ref2 + '</div>';
  infoHTML += '<div><strong>Scorer:</strong> ' + gameData.matchInfo.scorer + '</div>';
  infoHTML += '<div><strong>Assistant Scorer:</strong> ' + gameData.matchInfo.assistScorer + '</div>';
  infoHTML += '</div>';
  
  // Coin Toss Information
  if (gameData.coinToss && gameData.coinToss.winner) {
    infoHTML += '<div style="background:#1a1a2e;padding:12px;border-radius:6px;margin-top:15px;border-left:3px solid #ffd700">';
    infoHTML += '<div style="font-size:14px;font-weight:bold;color:#ffd700;margin-bottom:8px">ü™ô Coin Toss</div>';
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    infoHTML += '<div style="font-size:12px;margin-bottom:4px"><strong>Winner:</strong> ' + tossWinnerName + '</div>';
    infoHTML += '<div style="font-size:12px;margin-bottom:4px"><strong>Choice:</strong> ' + tossChoice + '</div>';
    infoHTML += '<div style="font-size:12px"><strong>First Server:</strong> ' + firstServerName + '</div>';
    infoHTML += '</div>';
  }
  
  document.getElementById('matchDataInfo').innerHTML = infoHTML;
  
  // Team A Data
  var teamAHTML = '<div style="margin-bottom:10px"><strong>' + gameData.matchInfo.teamAName + '</strong></div>';
  teamAHTML += '<div style="color:#888;font-size:11px;margin-bottom:8px">Players:</div>';
  gameData.teams.A.players.forEach(function(p) {
    var role = '';
    if (p.role === 'captain') role = ' <span style="color:#ffd700">(Captain)</span>';
    else if (p.role === 'libero1') role = ' <span style="color:#9c27b0">(Libero 1)</span>';
    else if (p.role === 'libero2') role = ' <span style="color:#9c27b0">(Libero 2)</span>';
    teamAHTML += '<div style="padding:4px 0">#' + p.jersey + ' - ' + p.name + role + '</div>';
  });
  document.getElementById('teamAData').innerHTML = teamAHTML;
  
  // Team B Data
  var teamBHTML = '<div style="margin-bottom:10px"><strong>' + gameData.matchInfo.teamBName + '</strong></div>';
  teamBHTML += '<div style="color:#888;font-size:11px;margin-bottom:8px">Players:</div>';
  gameData.teams.B.players.forEach(function(p) {
    var role = '';
    if (p.role === 'captain') role = ' <span style="color:#ffd700">(Captain)</span>';
    else if (p.role === 'libero1') role = ' <span style="color:#9c27b0">(Libero 1)</span>';
    else if (p.role === 'libero2') role = ' <span style="color:#9c27b0">(Libero 2)</span>';
    teamBHTML += '<div style="padding:4px 0">#' + p.jersey + ' - ' + p.name + role + '</div>';
  });
  document.getElementById('teamBData').innerHTML = teamBHTML;
  
  // Sets Data
  var setsHTML = '';
  var totalPointsA = 0;
  var totalPointsB = 0;
  var pointsBreakdownA = [];
  var pointsBreakdownB = [];
  
  gameData.sets.forEach(function(set, idx) {
    var setNum = idx + 1;
    var scoreA = set.score.A || 0;
    var scoreB = set.score.B || 0;
    totalPointsA += scoreA;
    totalPointsB += scoreB;
    pointsBreakdownA.push(scoreA);
    pointsBreakdownB.push(scoreB);
    
    setsHTML += '<div style="background:#1a1a2e;padding:15px;border-radius:6px;margin-bottom:10px;border-left:4px solid ' + (set.winner ? '#00ff00' : '#888') + '">';
    setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ffd700">SET ' + setNum + '</div>';
    setsHTML += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;color:#ffffff">';
    setsHTML += '<div><strong style="color:#00d9ff">Score:</strong> ' + gameData.matchInfo.teamAName + ' ' + set.score.A + ' - ' + set.score.B + ' ' + gameData.matchInfo.teamBName + '</div>';
    setsHTML += '<div><strong style="color:#00d9ff">Winner:</strong> ' + (set.winner ? gameData.matchInfo['team' + set.winner + 'Name'] : 'In Progress') + '</div>';
    setsHTML += '<div><strong style="color:#00d9ff">First Server:</strong> ' + gameData.matchInfo['team' + (set.firstServer || set.serving) + 'Name'] + '</div>';
    setsHTML += '<div><strong style="color:#00d9ff">Timeouts A:</strong> ' + set.timeouts.A.length + ' | <strong style="color:#00d9ff">B:</strong> ' + set.timeouts.B.length + '</div>';
    setsHTML += '<div><strong style="color:#00d9ff">Substitutions A:</strong> ' + set.substitutions.A.length + ' | <strong style="color:#00d9ff">B:</strong> ' + set.substitutions.B.length + '</div>';
    setsHTML += '</div>';
    
    // Show libero replacements for this set from matchSummary
    if (gameData.matchSummary) {
      var liberoEventsA = gameData.matchSummary.filter(function(e) {
        return e.type === 'Libero' && e.team === 'A' && e.setNumber === setNum;
      });
      var liberoEventsB = gameData.matchSummary.filter(function(e) {
        return e.type === 'Libero' && e.team === 'B' && e.setNumber === setNum;
      });
      
      if (liberoEventsA.length > 0 || liberoEventsB.length > 0) {
        setsHTML += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #333">';
        setsHTML += '<div style="color:#9c27b0;font-weight:bold;margin-bottom:6px">üîÑ Libero Replacements:</div>';
        setsHTML += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
        setsHTML += '<div><strong style="color:#ff6b6b">' + gameData.matchInfo.teamAName + ':</strong> ' + (liberoEventsA.length > 0 ? liberoEventsA.length + ' replacement(s)' : 'None') + '</div>';
        setsHTML += '<div><strong style="color:#4ecdc4">' + gameData.matchInfo.teamBName + ':</strong> ' + (liberoEventsB.length > 0 ? liberoEventsB.length + ' replacement(s)' : 'None') + '</div>';
        setsHTML += '</div>';
        setsHTML += '</div>';
      }
    }
    
    setsHTML += '</div>';
  });
  
  // Add Total Points Summary with calculation breakdown
  setsHTML += '<div style="background:#0f3460;padding:15px;border-radius:6px;margin-top:15px;border:2px solid #ffd700">';
  setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ffd700">üìä TOTAL POINTS CALCULATION</div>';
  setsHTML += '<div style="font-size:14px;margin-bottom:8px">';
  setsHTML += '<strong style="color:#ff6b6b">' + gameData.matchInfo.teamAName + ':</strong> ';
  setsHTML += '<span style="color:#fff">' + pointsBreakdownA.join(' + ') + ' = <strong style="color:#ffd700;font-size:18px">' + totalPointsA + '</strong></span>';
  setsHTML += '</div>';
  setsHTML += '<div style="font-size:14px">';
  setsHTML += '<strong style="color:#4ecdc4">' + gameData.matchInfo.teamBName + ':</strong> ';
  setsHTML += '<span style="color:#fff">' + pointsBreakdownB.join(' + ') + ' = <strong style="color:#ffd700;font-size:18px">' + totalPointsB + '</strong></span>';
  setsHTML += '</div>';
  setsHTML += '</div>';
  
  // Add Sanctions Summary (if any)
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      setsHTML += '<div style="background:#1a1a2e;padding:15px;border-radius:6px;margin-top:15px;border:2px solid #ff0000">';
      setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ff0000">‚ö†Ô∏è SANCTIONS (' + sanctions.length + ')</div>';
      sanctions.forEach(function(s) {
        setsHTML += '<div style="background:#16213e;padding:10px;margin-bottom:8px;border-radius:4px;border-left:3px solid #ff0000">';
        setsHTML += '<div style="color:#ffd700;font-size:11px;margin-bottom:4px">' + (s.time || '-') + ' | Set ' + (s.setNumber || gameData.currentSet);
        if (s.score) {
          var otherTeam = s.team === 'A' ? 'B' : 'A';
          setsHTML += ' | Score: ' + s.score[s.team] + ':' + s.score[otherTeam];
        }
        setsHTML += '</div>';
        setsHTML += '<div><strong style="color:#ff6b6b">' + (s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-') + '</strong></div>';
        setsHTML += '<div style="color:#ccc;font-size:13px;margin-top:4px">' + (s.description || '-') + '</div>';
        setsHTML += '</div>';
      });
      setsHTML += '</div>';
    }
  }
  
  document.getElementById('setsData').innerHTML = setsHTML;
}

function downloadMatchDataPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('COMPLETE MATCH LOG & SCORESHEET', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Information
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Information', 20, yPos);
  yPos += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Competition: ' + (gameData.matchInfo.competition || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Venue: ' + (gameData.matchInfo.venue || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Date: ' + (gameData.matchInfo.matchDate || 'N/A') + ' | Time: ' + (gameData.matchInfo.matchTime || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Format: Best of ' + gameData.matchInfo.format, 20, yPos);
  yPos += 10;
  
  // Teams
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Teams', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 20, yPos);
  yPos += 10;
  
  // Coin Toss Information
  if (gameData.coinToss && gameData.coinToss.winner) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Coin Toss', 20, yPos);
    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    doc.text('Toss Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Officials
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Officials', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), 20, yPos);
  yPos += 5;
  if (gameData.matchInfo.assistScorer) {
    doc.text('Assistant Scorer: ' + gameData.matchInfo.assistScorer, 20, yPos);
    yPos += 5;
  }
  yPos += 5;
  
  // Final Score
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Final Score', 20, yPos);
  yPos += 7;
  
  var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ': ' + setsWonA + ' sets', 20, yPos);
  yPos += 5;
  doc.text(gameData.matchInfo.teamBName + ': ' + setsWonB + ' sets', 20, yPos);
  yPos += 10;
  
  // Set Scores Table
  var setScores = [];
  gameData.sets.forEach(function(set, idx) {
    setScores.push([
      'Set ' + (idx + 1),
      set.score.A,
      set.score.B,
      set.winner === 'A' ? gameData.matchInfo.teamAName : (set.winner === 'B' ? gameData.matchInfo.teamBName : '-')
    ]);
  });
  
  doc.autoTable({
    head: [['Set', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName, 'Winner']],
    body: setScores,
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [233, 69, 96] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 10;
  
  // Calculate Total Points with breakdown
  var totalPointsA = 0;
  var totalPointsB = 0;
  var pointsBreakdownA = [];
  var pointsBreakdownB = [];
  
  gameData.sets.forEach(function(set, idx) {
    var scoreA = set.score.A || 0;
    var scoreB = set.score.B || 0;
    totalPointsA += scoreA;
    totalPointsB += scoreB;
    pointsBreakdownA.push(scoreA);
    pointsBreakdownB.push(scoreB);
  });
  
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Total Points Across All Sets', 20, yPos);
  yPos += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  
  // Team A calculation
  var calcA = pointsBreakdownA.join(' + ') + ' = ' + totalPointsA;
  doc.text(gameData.matchInfo.teamAName + ': ' + calcA, 20, yPos);
  yPos += 5;
  
  // Team B calculation
  var calcB = pointsBreakdownB.join(' + ') + ' = ' + totalPointsB;
  doc.text(gameData.matchInfo.teamBName + ': ' + calcB, 20, yPos);
  yPos += 10;
  
  // NEW PAGE - Match Statistics
  doc.addPage();
  yPos = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH STATISTICS', 20, yPos);
  yPos += 10;
  
  var statsData = [];
  gameData.sets.forEach(function(set, idx) {
    var timeoutsUsedA = set.timeouts.A ? set.timeouts.A.length : 0;
    var timeoutsUsedB = set.timeouts.B ? set.timeouts.B.length : 0;
    var subsUsedA = set.substitutions.A ? set.substitutions.A.length : 0;
    var subsUsedB = set.substitutions.B ? set.substitutions.B.length : 0;
    
    statsData.push([
      'Set ' + (idx + 1),
      timeoutsUsedA + ' / 2',
      timeoutsUsedB + ' / 2',
      subsUsedA + ' / ' + getSubLimit(),
      subsUsedB + ' / ' + getSubLimit()
    ]);
  });
  
  doc.autoTable({
    head: [[
      'Set',
      gameData.matchInfo.teamAName + ' Timeouts',
      gameData.matchInfo.teamBName + ' Timeouts',
      gameData.matchInfo.teamAName + ' Subs',
      gameData.matchInfo.teamBName + ' Subs'
    ]],
    body: statsData,
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 15;
  
  // Sanctions (if any)
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 0, 0);
      doc.text('‚ö†Ô∏è SANCTIONS', 20, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 10;
      
      var sanctionData = [];
      sanctions.forEach(function(s) {
        var scoreText = '-';
        if (s.score && s.team) {
          var otherTeam = s.team === 'A' ? 'B' : 'A';
          scoreText = s.score[s.team] + ':' + s.score[otherTeam];
        }
        sanctionData.push([
          s.time || '-',
          'Set ' + (s.setNumber || gameData.currentSet),
          scoreText,
          s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-',
          s.description || '-'
        ]);
      });
      
      doc.autoTable({
        head: [['Time', 'Set', 'Score', 'Team', 'Sanction']],
        body: sanctionData,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [255, 69, 96] },
        margin: { left: 20, right: 20 }
      });
      
      yPos = doc.lastAutoTable.finalY + 10;
    }
  }
  
  // NEW PAGE - Complete Action History / Match Log
  doc.addPage();
  yPos = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('COMPLETE MATCH LOG', 20, yPos);
  yPos += 10;
  
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var logData = [];
    gameData.matchSummary.forEach(function(event) {
      var teamName = event.team ? gameData.matchInfo['team' + event.team + 'Name'] : '-';
      logData.push([
        event.time || '-',
        'Set ' + (event.setNumber || gameData.currentSet),
        event.type || '-',
        teamName,
        event.description || '-'
      ]);
    });
    
    doc.autoTable({
      head: [['Time', 'Set', 'Event', 'Team', 'Details']],
      body: logData,
      startY: yPos,
      theme: 'striped',
      headStyles: { fillColor: [83, 52, 131] },
      margin: { left: 20, right: 20 },
      styles: { fontSize: 8, cellPadding: 2 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
  } else {
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('No match events recorded.', 20, yPos);
  }
  
  // Copyright footer on last page
  var pageCount = doc.internal.getNumberOfPages();
  doc.setPage(pageCount);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(100, 100, 100);
  doc.text('Generated by DC_Volley ¬© 2025 - Digital Volleyball Scoresheet', 105, 285, { align: 'center' });
  
  // Save PDF
  var fileName = 'Match_Log_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(fileName);
  
  alert('‚úÖ Complete match log PDF downloaded successfully!');
}
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  let y = 20;
  
  // Title
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('VOLLEYBALL MATCH REPORT', 105, y, { align: 'center' });
  y += 15;
  
  // Match Info
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text('Competition: ' + (gameData.matchInfo.competition || 'N/A'), 20, y);
  y += 7;
  if (gameData.matchInfo.venue) {
    doc.text('Venue: ' + gameData.matchInfo.venue, 20, y);
    y += 7;
  }
  doc.text('Date: ' + (gameData.matchInfo.matchDate || 'N/A') + ' | Time: ' + (gameData.matchInfo.matchTime || 'N/A'), 20, y);
  y += 10;
  
  // Officials
  doc.setFontSize(11);
  doc.text('Officials:', 20, y);
  y += 6;
  doc.text('  1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), 20, y);
  y += 6;
  doc.text('  2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), 20, y);
  y += 6;
  doc.text('  Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), 20, y);
  y += 6;
  if (gameData.matchInfo.assistScorer) {
    doc.text('  Assistant Scorer: ' + gameData.matchInfo.assistScorer, 20, y);
    y += 6;
  }
  y += 6;
  
  // Teams
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('TEAMS', 20, y);
  y += 8;
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 30, y);
  y += 12;
  
  // Final Score
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('FINAL SCORE', 20, y);
  y += 8;
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  
  var setsWonA = 0, setsWonB = 0;
  gameData.sets.forEach(function(s) {
    if (s.winner === 'A') setsWonA++;
    if (s.winner === 'B') setsWonB++;
  });
  
  doc.text(gameData.matchInfo.teamAName + ': ' + setsWonA + ' sets', 30, y);
  y += 6;
  doc.text(gameData.matchInfo.teamBName + ': ' + setsWonB + ' sets', 30, y);
  y += 10;
  
  // Set Scores Table
  var setScores = [];
  gameData.sets.forEach(function(set, idx) {
    setScores.push([
      'Set ' + (idx + 1),
      set.score.A,
      set.score.B,
      set.winner === 'A' ? gameData.matchInfo.teamAName : (set.winner === 'B' ? gameData.matchInfo.teamBName : '-')
    ]);
  });
  
  doc.autoTable({
    head: [['Set', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName, 'Winner']],
    body: setScores,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [233, 69, 96] },
    margin: { left: 20, right: 20 }
  });
  
  y = doc.lastAutoTable.finalY + 12;
  
  // Team Rosters
  doc.addPage();
  y = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(gameData.matchInfo.teamAName + ' ROSTER', 20, y);
  y += 10;
  
  var rosterA = [];
  if (gameData.teams.A.players) {
    gameData.teams.A.players.forEach(function(p) {
      var role = 'Player';
      if (p.role === 'libero1') role = 'Libero 1';
      else if (p.role === 'libero2') role = 'Libero 2';
      else if (p.role === 'captain') role = 'Captain';
      
      rosterA.push([
        p.jersey,
        p.name,
        role
      ]);
    });
  }
  
  doc.autoTable({
    head: [['Jersey #', 'Player Name', 'Role']],
    body: rosterA,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [83, 52, 131] },
    margin: { left: 20, right: 20 }
  });
  
  y = doc.lastAutoTable.finalY + 12;
  
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(gameData.matchInfo.teamBName + ' ROSTER', 20, y);
  y += 10;
  
  var rosterB = [];
  if (gameData.teams.B.players) {
    gameData.teams.B.players.forEach(function(p) {
      var role = 'Player';
      if (p.role === 'libero1') role = 'Libero 1';
      else if (p.role === 'libero2') role = 'Libero 2';
      else if (p.role === 'captain') role = 'Captain';
      
      rosterB.push([
        p.jersey,
        p.name,
        role
      ]);
    });
  }
  
  doc.autoTable({
    head: [['Jersey #', 'Player Name', 'Role']],
    body: rosterB,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [83, 52, 131] },
    margin: { left: 20, right: 20 }
  });
  
  // Match Stats
  doc.addPage();
  y = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH STATISTICS', 20, y);
  y += 10;
  
  var statsData = [];
  gameData.sets.forEach(function(set) {
    var timeoutsUsedA = set.timeouts.A ? set.timeouts.A.length : 0;
    var timeoutsUsedB = set.timeouts.B ? set.timeouts.B.length : 0;
    var subsUsedA = set.substitutions.A ? set.substitutions.A.length : 0;
    var subsUsedB = set.substitutions.B ? set.substitutions.B.length : 0;
    
    statsData.push([
      'Set ' + set.setNumber || gameData.sets.indexOf(set) + 1,
      timeoutsUsedA + ' / 2',
      timeoutsUsedB + ' / 2',
      subsUsedA + ' / 6',
      subsUsedB + ' / 6'
    ]);
  });
  
  doc.autoTable({
    head: [[
      'Set',
      gameData.matchInfo.teamAName + ' Timeouts',
      gameData.matchInfo.teamBName + ' Timeouts',
      gameData.matchInfo.teamAName + ' Subs',
      gameData.matchInfo.teamBName + ' Subs'
    ]],
    body: statsData,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  // Signatures Page
  if (gameData.officials && gameData.officials.signatures) {
    doc.addPage();
    y = 20;
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('OFFICIAL SIGNATURES', 105, y, { align: 'center' });
    y += 15;
    
    // Team A Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 107, 107);
    doc.text(gameData.matchInfo.teamAName, 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    if (gameData.officials.coachA) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text('Coach: ' + gameData.officials.coachA, 25, y);
      y += 5;
      if (gameData.officials.signatures.coachSignA) {
        doc.addImage(gameData.officials.signatures.coachSignA, 'PNG', 25, y, 50, 10);
      }
      y += 15;
    }
    
    doc.setFontSize(11);
    doc.text('Captain Signature (Before Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignA1) {
      doc.addImage(gameData.officials.signatures.captainSignA1, 'PNG', 25, y, 50, 10);
    }
    y += 15;
    
    doc.text('Captain Signature (After Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignA2) {
      doc.addImage(gameData.officials.signatures.captainSignA2, 'PNG', 25, y, 50, 10);
    }
    y += 20;
    
    // Team B Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(78, 205, 196);
    doc.text(gameData.matchInfo.teamBName, 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    if (gameData.officials.coachB) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text('Coach: ' + gameData.officials.coachB, 25, y);
      y += 5;
      if (gameData.officials.signatures.coachSignB) {
        doc.addImage(gameData.officials.signatures.coachSignB, 'PNG', 25, y, 50, 10);
      }
      y += 15;
    }
    
    doc.setFontSize(11);
    doc.text('Captain Signature (Before Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignB1) {
      doc.addImage(gameData.officials.signatures.captainSignB1, 'PNG', 25, y, 50, 10);
    }
    y += 15;
    
    doc.text('Captain Signature (After Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignB2) {
      doc.addImage(gameData.officials.signatures.captainSignB2, 'PNG', 25, y, 50, 10);
    }
    y += 20;
    
    // Match Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 193, 7);
    doc.text('MATCH OFFICIALS', 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    // Two columns for officials
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    
    // Left column
    var leftX = 25;
    var rightX = 110;
    var yStart = y;
    
    doc.text('1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), leftX, y);
    y += 5;
    if (gameData.officials.signatures.firstRefSign) {
      doc.addImage(gameData.officials.signatures.firstRefSign, 'PNG', leftX, y, 40, 8);
    }
    
    y = yStart;
    doc.text('2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), rightX, y);
    y += 5;
    if (gameData.officials.signatures.secondRefSign) {
      doc.addImage(gameData.officials.signatures.secondRefSign, 'PNG', rightX, y, 40, 8);
    }
    
    y += 18;
    doc.text('Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), leftX, y);
    y += 5;
    if (gameData.officials.signatures.scorerSign) {
      doc.addImage(gameData.officials.signatures.scorerSign, 'PNG', leftX, y, 40, 8);
    }
    
    y -= 5;
    if (gameData.matchInfo.assistScorer) {
      doc.text('Assistant Scorer: ' + gameData.matchInfo.assistScorer, rightX, y + 5);
      y += 10;
      if (gameData.officials.signatures.assistScorerSign) {
        doc.addImage(gameData.officials.signatures.assistScorerSign, 'PNG', rightX, y, 40, 8);
      }
    }
  }
  
  // Copyright footer on last page
  var pageCount = doc.internal.getNumberOfPages();
  doc.setPage(pageCount);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(100, 100, 100);
  doc.text('Generated by DC_Volley ¬© 2025 - Digital Volleyball Scoresheet', 105, 285, { align: 'center' });
  
  // Save PDF
  var fileName = 'Volleyball_Match_Report_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(fileName);
  
  alert('PDF exported successfully!');
}

function openLineupDisplay() {
  // Save current game data to localStorage
  localStorage.setItem('volleyballGameData', JSON.stringify(gameData));
  // Open lineup display in new window
  window.open('lineup_display.html', '_blank', 'width=800,height=600');
}

var scoreboardWindow = null;

function openScoreboard() {
  var scoreboardHTML = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Scoreboard Display</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:#000;color:#fff;overflow:hidden;height:100vh;display:flex;flex-direction:column}.scoreboard{flex:1;display:flex;flex-direction:column;justify-content:center;padding:20px}.match-header{text-align:center;margin-bottom:20px}.match-title{font-size:36px;font-weight:bold;color:#00d9ff;margin-bottom:10px;text-transform:uppercase}.match-subtitle{font-size:20px;color:#888}.score-container{display:flex;align-items:center;justify-content:center;gap:50px;margin-bottom:30px}.team-display{text-align:center;flex:1;max-width:400px}.team-name{font-size:42px;font-weight:bold;margin-bottom:15px;text-transform:uppercase;letter-spacing:2px}.team-a-color{color:#ff4444}.team-b-color{color:#00ffee}.score-box{background:#000;border:4px solid;border-radius:15px;padding:25px;position:relative}.team-a-border{border-color:#ff4444;box-shadow:0 0 30px rgba(255,68,68,0.5)}.team-b-border{border-color:#00ffee;box-shadow:0 0 30px rgba(0,255,238,0.5)}.score-number{font-size:120px;font-weight:bold;font-family:"Arial Black",sans-serif;line-height:1}.serving-indicator{position:absolute;top:-20px;right:-20px;background:linear-gradient(135deg,#ffeb3b 0%,#00d9ff 100%);color:#000;padding:10px 15px;border-radius:50%;font-size:30px;border:4px solid #fff;animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}.set-indicator{text-align:center;background:linear-gradient(135deg,#533483 0%,#9c27b0 100%);padding:20px;border-radius:15px;margin-bottom:25px}.set-number{font-size:28px;margin-bottom:15px;color:#00d9ff;font-weight:bold}.set-dots-container{display:flex;gap:15px;justify-content:center}.set-dot{width:55px;height:55px;border-radius:50%;border:3px solid #fff;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:bold;background:#1a1a2e;transition:all 0.3s}.set-won-a{background:#ff4444;border-color:#ff4444;box-shadow:0 0 25px rgba(255,68,68,0.8)}.set-won-b{background:#00ffee;border-color:#00ffee;box-shadow:0 0 25px rgba(0,255,238,0.8);color:#000}.footer-info{display:flex;justify-content:space-around;padding:15px;background:rgba(22,33,62,0.8);border-top:2px solid #533483}.info-item{text-align:center}.info-label{font-size:14px;color:#888;margin-bottom:5px}.info-value{font-size:24px;font-weight:bold;color:#00d9ff}.no-data{text-align:center;padding:100px 40px;font-size:48px;color:#888}.winner-announcement{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;align-items:center;justify-content:center}.winner-announcement.show{display:flex}.winner-content{text-align:center;padding:60px}.winner-trophy{font-size:150px;margin-bottom:30px;animation:bounce 1s infinite}@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-30px)}}.winner-text{font-size:80px;font-weight:bold;color:#ffc107;margin-bottom:30px;text-transform:uppercase;text-shadow:0 0 40px rgba(255,193,7,0.8)}.winner-team{font-size:100px;font-weight:bold;margin-bottom:20px}.winner-score{font-size:50px;color:#00d9ff}</style></head><body><div class="scoreboard" id="scoreboard"></div><div class="winner-announcement" id="winnerAnnouncement"><div class="winner-content"><div class="winner-trophy">&#127942;</div><div class="winner-text">MATCH WINNER</div><div class="winner-team" id="winnerTeam"></div><div class="winner-score" id="winnerScore"></div></div></div><div style="position:fixed;bottom:0;left:0;right:0;text-align:center;padding:8px;background:rgba(0,0,0,0.8);color:#666;font-size:12px;border-top:1px solid #333">DC_Volley &copy; 2025 | Digital Volleyball Scoresheet</div><script>function renderScoreboard(){var gameData;try{gameData=window.opener&&window.opener.gameData?window.opener.gameData:null;}catch(e){gameData=null;}if(!gameData||!gameData.sets||gameData.sets.length===0){document.getElementById("scoreboard").innerHTML="<div class=\\"no-data\\">WAITING FOR MATCH TO START...</div>";return;}var set=gameData.sets[gameData.currentSet-1];if(!set)return;var html="";html+="<div class=\\"match-header\\">";html+="<div class=\\"match-title\\">"+(gameData.matchInfo.competition||"VOLLEYBALL MATCH")+"</div>";if(gameData.matchInfo.venue||gameData.matchInfo.matchDate){html+="<div class=\\"match-subtitle\\">"+(gameData.matchInfo.venue||"")+(gameData.matchInfo.venue&&gameData.matchInfo.matchDate?" | ":"")+(gameData.matchInfo.matchDate||"")+"</div>";}html+="</div>";html+="<div class=\\"score-container\\">";html+="<div class=\\"team-display\\">";html+="<div class=\\"team-name team-a-color\\">"+gameData.matchInfo.teamAName+"</div>";html+="<div class=\\"score-box team-a-border\\">";if(set.serving==="A")html+="<div class=\\"serving-indicator\\">&#127952;</div>";html+="<div class=\\"score-number team-a-color\\">"+set.score.A+"</div>";html+="</div></div>";html+="<div class=\\"team-display\\">";html+="<div class=\\"team-name team-b-color\\">"+gameData.matchInfo.teamBName+"</div>";html+="<div class=\\"score-box team-b-border\\">";if(set.serving==="B")html+="<div class=\\"serving-indicator\\">&#127952;</div>";html+="<div class=\\"score-number team-b-color\\">"+set.score.B+"</div>";html+="</div></div>";html+="</div>";html+="<div class=\\"set-indicator\\">";html+="<div class=\\"set-number\\">SET "+gameData.currentSet+"</div>";html+="<div class=\\"set-dots-container\\">";var setsToWin=parseInt(gameData.matchInfo.format);for(var i=0;i<setsToWin;i++){var dotClass="set-dot";if(i<gameData.sets.length&&gameData.sets[i].winner){dotClass+=gameData.sets[i].winner==="A"?" set-won-a":" set-won-b";}html+="<div class=\\""+dotClass+"\\">"+(i+1)+"</div>";}html+="</div>";html+="<div style=\\"display:flex;justify-content:center;gap:30px;margin-top:15px;font-size:16px;font-weight:bold\\">";html+="<div style=\\"display:flex;align-items:center;gap:8px\\"><div style=\\"width:25px;height:25px;border-radius:50%;background:#ff4444\\"></div><span style=\\"color:#ff4444\\">"+gameData.matchInfo.teamAName+"</span></div>";html+="<div style=\\"display:flex;align-items:center;gap:8px\\"><div style=\\"width:25px;height:25px;border-radius:50%;background:#00ffee\\"></div><span style=\\"color:#00ffee\\">"+gameData.matchInfo.teamBName+"</span></div>";html+="</div></div>";html+="<div class=\\"footer-info\\">";var setsWonA=gameData.sets.filter(function(s){return s.winner==="A";}).length;var setsWonB=gameData.sets.filter(function(s){return s.winner==="B";}).length;html+="<div class=\\"info-item\\"><div class=\\"info-label\\">SETS WON</div><div class=\\"info-value\\">"+setsWonA+" - "+setsWonB+"</div></div>";var toA=set.timeouts.A?set.timeouts.A.length:0;var toB=set.timeouts.B?set.timeouts.B.length:0;html+="<div class=\\"info-item\\"><div class=\\"info-label\\">TIMEOUTS REMAINING</div><div class=\\"info-value\\">"+(2-toA)+" - "+(2-toB)+"</div></div>";var subA=set.substitutions.A?set.substitutions.A.length:0;var subB=set.substitutions.B?set.substitutions.B.length:0;var maxSubs=parseInt(gameData.matchInfo.subLimit)||6;html+="<div class=\\"info-item\\"><div class=\\"info-label\\">SUBS REMAINING</div><div class=\\"info-value\\">"+(maxSubs-subA)+" - "+(maxSubs-subB)+"</div></div>";html+="</div>";document.getElementById("scoreboard").innerHTML=html;var setsToWin2=Math.ceil(parseInt(gameData.matchInfo.format)/2);if(setsWonA>=setsToWin2||setsWonB>=setsToWin2){var winnerTeam=setsWonA>=setsToWin2?gameData.matchInfo.teamAName:gameData.matchInfo.teamBName;var winnerSets=setsWonA>=setsToWin2?setsWonA:setsWonB;var loserSets=setsWonA>=setsToWin2?setsWonB:setsWonA;var teamColor=setsWonA>=setsToWin2?"team-a-color":"team-b-color";document.getElementById("winnerTeam").textContent=winnerTeam;document.getElementById("winnerTeam").className="winner-team "+teamColor;document.getElementById("winnerScore").textContent="Wins "+winnerSets+" - "+loserSets;document.getElementById("winnerAnnouncement").classList.add("show");}}setInterval(renderScoreboard,500);renderScoreboard();<\/script></body></html>';

  if (scoreboardWindow && !scoreboardWindow.closed) {
    scoreboardWindow.focus();
    return;
  }
  scoreboardWindow = window.open('', 'scoreboardDisplay', 'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');
  if (scoreboardWindow) {
    scoreboardWindow.document.open();
    scoreboardWindow.document.write(scoreboardHTML);
    scoreboardWindow.document.close();
  }
}

window.onload = function() {
  var today = new Date();
  document.getElementById('matchDate').value = today.toISOString().split('T')[0];
  document.getElementById('matchTime').value = today.toTimeString().substring(0, 5);
  
  initRosterTables();
  
  document.getElementById('nextLineupBtn').addEventListener('click', validateAndProceed);
  // DO NOT use addEventListener for startMatchBtn - it will be reassigned via onclick for new sets
  // document.getElementById('startMatchBtn').addEventListener('click', startMatch);
  
  // Set initial onclick for first match start
  document.getElementById('startMatchBtn').onclick = startMatch;
  
  document.getElementById('coinTossWinner').addEventListener('change', determineCoinTossOutcome);
  document.getElementById('coinTossChoice').addEventListener('change', determineCoinTossOutcome);
  
  // Team assignment auto-fill opposite side
  document.getElementById('teamAAssignment').addEventListener('change', function() {
    var teamA = this.value;
    if (teamA) {
      var teamB = teamA === 'team1' ? 'team2' : 'team1';
      document.getElementById('teamBAssignment').value = teamB;
    }
  });
  
  document.getElementById('teamBAssignment').addEventListener('change', function() {
    var teamB = this.value;
    if (teamB) {
      var teamA = teamB === 'team1' ? 'team2' : 'team1';
      document.getElementById('teamAAssignment').value = teamA;
    }
  });
  
  var positionsA = document.querySelectorAll('#courtASetup .court-setup-pos');
  positionsA.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    el.addEventListener('click', function() {
      assignPosition('A', pos);
    });
  });
  
  var positionsB = document.querySelectorAll('#courtBSetup .court-setup-pos');
  positionsB.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    el.addEventListener('click', function() {
      assignPosition('B', pos);
    });
  });
  
  console.log('DC Volleyball E-Scoresheet initialized successfully!');
};
</script>

<div class="copyright-footer">
  ¬© 2025 DC_Volley - Digital Volleyball Scoresheet | All Rights Reserved
</div>

<!-- ‚ïê‚ïê‚ïê PATCH: Configurable Substitution Limit ‚ïê‚ïê‚ïê -->
<script>
/**
 * getSubLimit() ‚Äî single source of truth for the substitution limit.
 * Reads from matchInfo.subLimit (set at match start from UI dropdown).
 * Falls back to 6 for full backward compatibility with saved/loaded matches
 * that pre-date this feature.
 */
function getSubLimit() {
  return (gameData.matchInfo && gameData.matchInfo.subLimit) || 6;
}

/**
/* getSubLimit() is defined above; subDispA/B are updated directly in updateMatchDisplay() */
</script>
<!-- ‚ïê‚ïê‚ïê END PATCH: Configurable Substitution Limit ‚ïê‚ïê‚ïê -->

<script>
/* ================================================================
   LiberoServe - Libero Optional Serving (FIVB Rule 7.3.2 variant)
   Backward compatible: fully inactive when dropdown = OFF
   ================================================================ */
(function(global) {
  'use strict';

  var cfg = {
    A: { enabled: false, designatedJersey: null },
    B: { enabled: false, designatedJersey: null }
  };

  var LiberoServe = {

    /* Called by the dropdown onchange handlers */
    onConfigChange: function(team) {
      var sel = document.getElementById('liberoServePlayer' + team);
      if (!sel) return;
      cfg[team].enabled          = sel.value !== '';
      cfg[team].designatedJersey = sel.value || null;
    },

    /* Populate dropdowns - called whenever lineup modal opens */
    populateDropdowns: function() {
      ['A', 'B'].forEach(function(team) {
        var sel = document.getElementById('liberoServePlayer' + team);
        if (!sel) return;

        /* Update team name label */
        var nameLabel = document.getElementById('liberoServeTeam' + team + 'Name');
        if (nameLabel && gameData.matchInfo) {
          nameLabel.textContent = gameData.matchInfo['team' + team + 'Name'] || ('TEAM ' + team);
        }

        /* Remember current selection across repopulation */
        var prevVal = cfg[team].designatedJersey || '';

        while (sel.options.length > 1) sel.remove(1);

        var players = (gameData.teams[team] && gameData.teams[team].players) || [];
        players.filter(function(p) {
          return p.role !== 'libero1' && p.role !== 'libero2';
        }).forEach(function(p) {
          var opt = document.createElement('option');
          opt.value = String(p.jersey);
          opt.text  = '#' + p.jersey + '  ' + (p.name || '');
          sel.appendChild(opt);
        });

        /* Restore previous selection if still valid */
        if (prevVal) {
          sel.value = prevVal;
          if (sel.value !== prevVal) { sel.value = ''; } /* player no longer exists */
        }
        /* Sync cfg with current select state */
        cfg[team].enabled          = sel.value !== '';
        cfg[team].designatedJersey = sel.value || null;
      });
      LiberoServe._updateBoxVisibility();
    },

    /*
     * Gate: can the libero replace `jersey` at P1 while team is serving?
     * Called from confirmLiberoReplacement() and the libero modal UI renderer.
     * Returns true  ‚Üí allow the replacement (libero may serve for this player)
     * Returns false ‚Üí block (feature off or wrong player)
     */
    /**
     * Gate: can the libero replace the player at this position while team is serving?
     * 
     * NEW LOGIC: Libero can serve for the designated PLAYER wherever that player
     * currently is in the rotation, OR for any substitute who replaced that player.
     * 
     * @param {string} team - 'A' or 'B'
     * @param {number|string} jersey - jersey of the player being replaced
     * @param {number} position - 1-based position (1=P1, 2=P2, ..., 6=P6)
     * 
     * Returns true  ‚Üí allow the replacement (libero may serve for this player)
     * Returns false ‚Üí block (feature off or wrong player/substitute chain)
     */
    allowsP1Replacement: function(team, jersey, position) {
      if (!cfg[team].enabled) return false;
      if (!cfg[team].designatedJersey) return false;
      
      var playerJersey = String(jersey);
      var designated = String(cfg[team].designatedJersey);
      
      // Direct match: this IS the designated player
      if (playerJersey === designated) return true;
      
      // Check if this player is a substitute for the designated player
      // by tracing the substitution chain
      var set = gameData.sets[gameData.currentSet - 1];
      if (!set || !set.substitutionTracking || !set.substitutionTracking[team]) {
        return false;
      }
      
      // substitutionTracking[team][playerJersey] = {pairedWith: otherPlayer, completed: bool}
      var tracking = set.substitutionTracking[team];
      
      // Walk the substitution chain
      var current = playerJersey;
      var visited = {};
      var maxDepth = 10;
      
      while (maxDepth-- > 0) {
        if (visited[current]) break;
        visited[current] = true;
        
        if (current === designated) return true;
        
        // Check if current player has a pairing
        var record = tracking[current];
        if (!record || !record.pairedWith) break;
        
        current = String(record.pairedWith);
      }
      
      return false;
    },

    /*
     * Final safety check at START RALLY moment.
     * Verifies that if a libero is in P1 of the serving team,
     * they replaced the designated player (or that player's substitute).
     * Returns true = legal, false = violation (shows alert).
     */
    validateServeStart: function() {
      var set = gameData.sets[gameData.currentSet - 1];
      if (!set) return true;

      var servingTeam = set.serving;
      if (!cfg[servingTeam].enabled) return true;
      if (!cfg[servingTeam].designatedJersey) return true;

      var lineup   = gameData.teams[servingTeam].lineup;
      var p1Jersey = String(lineup[0]);

      var p1Player = (gameData.teams[servingTeam].players || []).find(function(p) {
        return String(p.jersey) === p1Jersey;
      });

      /* P1 is not a libero ‚Üí nothing to check */
      if (!p1Player || (p1Player.role !== 'libero1' && p1Player.role !== 'libero2')) {
        return true;
      }

      /* P1 IS a libero. Find who they replaced.
         Check if that player is the designated player or in the substitution chain */
      var replacements = gameData.liberoReplacements[servingTeam] || [];
      var p1Record = replacements.find(function(r) {
        return r.position === 1 || String(r.libero) === p1Jersey;
      });

      if (!p1Record) {
        LiberoServe._showViolation(servingTeam, p1Player);
        return false;
      }

      var originalJersey = String(p1Record.originalPlayer);
      var designated = String(cfg[servingTeam].designatedJersey);

      // Direct match
      if (originalJersey === designated) return true;

      // Check substitution chain
      var tracking = set.substitutionTracking && set.substitutionTracking[servingTeam];
      if (!tracking) {
        LiberoServe._showViolation(servingTeam, p1Player);
        return false;
      }

      // Walk chain to see if originalPlayer connects to designated
      var current = originalJersey;
      var visited = {};
      var maxDepth = 10;

      while (maxDepth-- > 0) {
        if (visited[current]) break;
        visited[current] = true;
        if (current === designated) return true;
        
        var record = tracking[current];
        if (!record || !record.pairedWith) break;
        current = String(record.pairedWith);
      }

      /* Violation */
      LiberoServe._showViolation(servingTeam, p1Player);
      return false;
    },

    /*
     * captureDesignatedSlots ‚Äî called when a new set lineup is confirmed.
     * Records which rotation slot the designated player occupies at the start
     * of the set, so the libero serve rule can track them through rotations.
     */
    captureDesignatedSlots: function() {
      ['A', 'B'].forEach(function(team) {
        if (!cfg[team].enabled || !cfg[team].designatedJersey) return;
        var lineup = gameData.teams[team] && gameData.teams[team].lineup;
        if (!lineup) return;
        var designatedStr = String(cfg[team].designatedJersey);
        var slot = lineup.findIndex(function(j) { return String(j) === designatedStr; });
        cfg[team].designatedStartSlot = slot; // 0-based, -1 if not on court
      });
    },

    /* Show / hide the config box based on whether any team has a libero */
    _updateBoxVisibility: function() {
      var box = document.getElementById('liberoServeConfigBox');
      if (!box) return;
      var hasLibero = ['A', 'B'].some(function(t) {
        return ((gameData.teams[t] && gameData.teams[t].players) || []).some(function(p) {
          return p.role === 'libero1' || p.role === 'libero2';
        });
      });
      box.style.display = hasLibero ? 'block' : 'none';
    },

    _showViolation: function(team, liberoPlayer) {
      var teamName  = gameData.matchInfo['team' + team + 'Name'] || ('Team ' + team);
      var libName   = liberoPlayer
        ? ('#' + liberoPlayer.jersey + ' ' + (liberoPlayer.name || ''))
        : 'Libero';
      var sel       = document.getElementById('liberoServePlayer' + team);
      var desigLabel = (sel && sel.selectedIndex > 0)
        ? sel.options[sel.selectedIndex].text.trim()
        : (cfg[team].designatedJersey ? '#' + cfg[team].designatedJersey : 'the designated player');
      alert('\u26d4 ILLEGAL SERVE - Libero Serving Violation\n\nTeam: ' + teamName +
            '\nLibero ' + libName + ' is in P1 (server position).' +
            '\n\nLibero may only serve when ' + desigLabel +
            ' is in P1 as the replaced player.' +
            '\n\nPlease restore the original P1 player before starting the rally.');
    }
  };

  /*
   * Hook both lineup-open paths so dropdowns always populate:
   *  - showLineupSetup()        ‚Üí Set 1
   *  - showNewSetLineupSetup()  ‚Üí Set 2, 3, 4, 5
   */
  var _origShow = global.showLineupSetup;
  global.showLineupSetup = function() {
    if (typeof _origShow === 'function') _origShow.apply(this, arguments);
    LiberoServe.populateDropdowns();
  };

  var _origNewSet = global.showNewSetLineupSetup;
  global.showNewSetLineupSetup = function() {
    if (typeof _origNewSet === 'function') _origNewSet.apply(this, arguments);
    LiberoServe.populateDropdowns();
  };

  global.LiberoServe = LiberoServe;
  console.log('[LiberoServe] Patch v3 loaded.');
}(window));
</script>

</body>
</html>